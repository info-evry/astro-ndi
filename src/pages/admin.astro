---
import AdminLayout from '../layouts/AdminLayout.astro';
---

<AdminLayout title="NDI Admin - Gestion des équipes - Asso Info Evry">
  <!-- Admin Hero Header -->
  <section class="page-hero">
    <div class="page-hero-bg">
      <div class="orb orb-blue"></div>
      <div class="orb orb-indigo"></div>
    </div>
    <div class="page-hero-content container">
      <h1 class="page-hero-title">
        <span>Administration</span>
        <span class="gradient-text">NDI</span>
      </h1>
      <p class="page-hero-subtitle">Gestion des équipes et participants</p>
    </div>
  </section>

  <main class="container-wide admin">
    <section id="auth-section" class="section glass-card">
      <h2>Authentification</h2>
      <div class="form-group">
        <label for="admin-token">Token d'administration</label>
        <input type="password" id="admin-token" placeholder="Entrez votre token...">
      </div>
      <button type="button" id="auth-btn" class="btn btn-primary">Connexion</button>
      <p id="auth-error" class="error-text hidden"></p>
    </section>

    <div id="admin-content" class="hidden">
      <!-- Tab Navigation -->
      <nav class="tab-nav" role="tablist">
        <button type="button" role="tab" id="tab-registrations" aria-controls="panel-registrations" aria-selected="true" class="tab-item active" data-tab="registrations">
          <span class="tab-icon">&#x1F4DD;</span>
          <span class="tab-label">Inscriptions</span>
        </button>
        <button type="button" role="tab" id="tab-attendance" aria-controls="panel-attendance" aria-selected="false" class="tab-item" data-tab="attendance">
          <span class="tab-icon">&#x2705;</span>
          <span class="tab-label">Présences</span>
          <span id="attendance-badge" class="tab-badge">0</span>
        </button>
      </nav>

      <!-- Registrations Panel -->
      <div id="panel-registrations" class="tab-panel" role="tabpanel" aria-labelledby="tab-registrations">

      <!-- Stats Section -->
      <div class="disclosure-group open" data-disclosure="stats">
        <div class="disclosure-header" onclick="toggleDisclosure('stats')">
          <h2><span class="disclosure-chevron">􀆊</span> Vue d'ensemble</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="export-official-btn" class="btn btn-primary btn-sm">Export Officiel</button>
            <button type="button" id="export-all-btn" class="btn btn-secondary btn-sm">Exporter CSV</button>
            <button type="button" id="refresh-btn" class="btn btn-secondary btn-sm">Rafraîchir</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="stats-grid" class="stats-grid"></div>
        </div>
      </div>

      <!-- Food Stats -->
      <div class="disclosure-group open" data-disclosure="food">
        <div class="disclosure-header" onclick="toggleDisclosure('food')">
          <h2><span class="disclosure-chevron">􀆊</span> Préférences alimentaires</h2>
        </div>
        <div class="disclosure-body">
          <div id="food-stats" class="food-stats"></div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="disclosure-group" data-disclosure="settings" id="settings-section">
        <div class="disclosure-header" onclick="toggleDisclosure('settings')">
          <h2><span class="disclosure-chevron">􀆊</span> Paramètres</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="save-settings-btn" class="btn btn-primary btn-sm" disabled>
              Enregistrer
            </button>
          </div>
        </div>
        <div class="disclosure-body">
          <!-- School Name for Official Export -->
          <div class="settings-card">
            <h3>Export Officiel NDI</h3>
            <div class="form-group">
              <label for="setting-school-name">Nom de l'école (exact comme saisi sur le site NDI)</label>
              <input type="text" id="setting-school-name" value="Université d'Evry" maxlength="256" placeholder="Université d'Evry">
            </div>
          </div>

          <!-- Capacity Settings -->
          <div class="settings-card">
            <h3>Limites de capacité</h3>
            <div class="settings-grid">
              <div class="form-group">
                <label for="setting-max-team">Taille max d'équipe</label>
                <input type="number" id="setting-max-team" min="1" max="100" value="15">
              </div>
              <div class="form-group">
                <label for="setting-max-participants">Participants max</label>
                <input type="number" id="setting-max-participants" min="1" max="10000" value="200">
              </div>
              <div class="form-group">
                <label for="setting-min-team">Taille min d'équipe</label>
                <input type="number" id="setting-min-team" min="1" max="50" value="1">
              </div>
            </div>
          </div>

          <!-- Pizza Management -->
          <div class="settings-card">
            <h3>Gestion des pizzas</h3>
            <div id="pizzas-list" class="pizzas-list"></div>

            <div id="pizza-add-form" class="pizza-add-form">
              <h4>Ajouter une pizza</h4>
              <form id="add-pizza-form-element">
                <div class="settings-grid">
                  <div class="form-group">
                    <label for="new-pizza-id">ID (unique)</label>
                    <input type="text" id="new-pizza-id" placeholder="ex: hawaienne" required>
                  </div>
                  <div class="form-group">
                    <label for="new-pizza-name">Nom</label>
                    <input type="text" id="new-pizza-name" placeholder="ex: Hawaïenne" required>
                  </div>
                  <div class="form-group">
                    <label for="new-pizza-desc">Description</label>
                    <input type="text" id="new-pizza-desc" placeholder="ex: Tomate, jambon, ananas">
                  </div>
                </div>
                <button type="submit" class="btn btn-secondary btn-sm">+ Ajouter</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Import Section -->
      <div class="disclosure-group" data-disclosure="import">
        <div class="disclosure-header" onclick="toggleDisclosure('import')">
          <h2><span class="disclosure-chevron">􀆊</span> Importer des données</h2>
        </div>
        <div class="disclosure-body">
          <div class="settings-card">
            <h3>Import CSV</h3>
            <p class="import-description">
              Importez des membres depuis un fichier CSV. Les équipes seront créées automatiquement avec le nom de l'équipe comme mot de passe.
            </p>
            <div class="import-format">
              <strong>Format attendu :</strong>
              <code>id,firstname,lastname,email,fooddiet,baclevel,ismanager,teamName,date</code>
            </div>
            <div class="form-group">
              <label for="import-file">Fichier CSV</label>
              <input type="file" id="import-file" accept=".csv,text/csv">
            </div>
            <div id="import-preview" class="import-preview hidden">
              <h4>Aperçu</h4>
              <div id="import-preview-content"></div>
            </div>
            <div class="import-actions">
              <button type="button" id="import-btn" class="btn btn-primary" disabled>Importer</button>
              <span id="import-status" class="import-status"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="disclosure-group open" data-disclosure="actions">
        <div class="disclosure-header" onclick="toggleDisclosure('actions')">
          <h2><span class="disclosure-chevron">􀆊</span> Actions rapides</h2>
        </div>
        <div class="disclosure-body">
          <div class="quick-actions">
            <button type="button" id="add-team-btn" class="btn btn-primary">+ Nouvelle équipe</button>
            <button type="button" id="add-member-btn" class="btn btn-primary">+ Nouveau membre</button>
            <button type="button" id="select-all-btn" class="btn btn-secondary">Tout sélectionner</button>
            <button type="button" id="delete-selected-btn" class="btn btn-danger" disabled>Supprimer sélection</button>
          </div>
        </div>
      </div>

      <!-- Teams Section -->
      <div class="disclosure-group open" data-disclosure="teams">
        <div class="disclosure-header" onclick="toggleDisclosure('teams')">
          <h2><span class="disclosure-chevron">􀆊</span> Équipes et membres</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <div class="search-input-wrapper">
              <span class="search-icon" aria-hidden="true">&#x1F50D;</span>
              <input type="search" id="teams-search" class="search-input" placeholder="Rechercher...">
            </div>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="teams-container"></div>
        </div>
      </div>

      </div><!-- End Registrations Panel -->

      <!-- Attendance Panel -->
      <div id="panel-attendance" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-attendance">
        <!-- Attendance Stats -->
        <div class="disclosure-group open" data-disclosure="attendance-stats">
          <div class="disclosure-header" onclick="toggleDisclosure('attendance-stats')">
            <h2><span class="disclosure-chevron">􀆊</span> Statistiques de présence</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <button type="button" id="refresh-attendance-btn" class="btn btn-secondary btn-sm">Rafraîchir</button>
            </div>
          </div>
          <div class="disclosure-body">
            <div id="attendance-stats-grid" class="stats-grid"></div>
          </div>
        </div>

        <!-- Attendance List -->
        <div class="disclosure-group open" data-disclosure="attendance-list">
          <div class="disclosure-header" onclick="toggleDisclosure('attendance-list')">
            <h2><span class="disclosure-chevron">􀆊</span> Liste des participants</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <div class="search-input-wrapper">
                <span class="search-icon" aria-hidden="true">&#x1F50D;</span>
                <input type="search" id="attendance-search" class="search-input" placeholder="Rechercher un participant...">
              </div>
            </div>
          </div>
          <div class="disclosure-body">
            <div class="attendance-filters">
              <label class="filter-label">
                <input type="checkbox" id="filter-checked-in"> Présents uniquement
              </label>
              <label class="filter-label">
                <input type="checkbox" id="filter-not-checked-in"> Absents uniquement
              </label>
            </div>
            <div class="table-container">
              <table id="attendance-table" class="members-table attendance-table">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Équipe</th>
                    <th>Statut</th>
                    <th>Heure d'arrivée</th>
                    <th class="actions-col">Actions</th>
                  </tr>
                </thead>
                <tbody id="attendance-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div><!-- End Attendance Panel -->

    </div>

    <!-- Add/Edit Team Modal -->
    <div id="team-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="team-modal-title">Nouvelle équipe</h3>
        <form id="team-form">
          <input type="hidden" id="team-form-id">
          <div class="form-group">
            <label for="team-form-name">Nom de l'équipe *</label>
            <input type="text" id="team-form-name" required>
          </div>
          <div class="form-group">
            <label for="team-form-desc">Description</label>
            <textarea id="team-form-desc" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label for="team-form-password">Mot de passe (laisser vide pour ne pas changer)</label>
            <input type="text" id="team-form-password" placeholder="Nouveau mot de passe">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('team-modal')">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add/Edit Member Modal -->
    <div id="member-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="member-modal-title">Nouveau membre</h3>
        <form id="member-form">
          <input type="hidden" id="member-form-id">
          <div class="form-group">
            <label for="member-form-team">Équipe *</label>
            <select id="member-form-team" required></select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-firstname">Prénom *</label>
              <input type="text" id="member-form-firstname" required>
            </div>
            <div class="form-group">
              <label for="member-form-lastname">Nom *</label>
              <input type="text" id="member-form-lastname" required>
            </div>
          </div>
          <div class="form-group">
            <label for="member-form-email">Email *</label>
            <input type="email" id="member-form-email" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-bac">Niveau BAC</label>
              <select id="member-form-bac">
                <option value="0">Non bachelier</option>
                <option value="1">BAC+1</option>
                <option value="2">BAC+2</option>
                <option value="3">BAC+3 (Licence)</option>
                <option value="4">BAC+4</option>
                <option value="5">BAC+5 (Master)</option>
                <option value="6">BAC+6</option>
                <option value="7">BAC+7</option>
                <option value="8">BAC+8 (Doctorat)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="member-form-food">Pizza</label>
              <select id="member-form-food">
                <option value="">Aucune</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="member-form-leader">
              Chef d'équipe
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('member-modal')">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Confirmer la suppression</h3>
        <p id="confirm-message"></p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('confirm-modal')">Annuler</button>
          <button type="button" id="confirm-delete-btn" class="btn btn-danger">Supprimer</button>
        </div>
      </div>
    </div>
  </main>
</AdminLayout>

<script define:vars={{ baseUrl: import.meta.env.BASE_URL }}>
/**
 * NDI Admin Dashboard
 * Full CRUD functionality for teams and members
 */

// API base URL (from Astro's BASE_URL)
const API_BASE = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function $(id) {
  return document.getElementById(id);
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================

function showToast(message, type = 'success', duration = 3000) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function toastSuccess(message) {
  showToast(message, 'success');
}

function toastError(message) {
  showToast(message, 'error');
}

// ============================================================
// API FUNCTIONS
// ============================================================

let adminToken = localStorage.getItem('ndi_admin_token') || '';

async function api(endpoint, options = {}) {
  const response = await fetch(`${API_BASE}/api${endpoint}`, {
    headers: {
      'Authorization': `Bearer ${adminToken}`,
      'Content-Type': 'application/json',
      ...options.headers
    },
    ...options
  });

  if (response.status === 401) {
    throw new Error('Unauthorized');
  }

  // Handle CSV downloads
  if (response.headers.get('Content-Type')?.includes('text/csv')) {
    return response;
  }

  if (!response.ok) {
    const data = await response.json();
    throw new Error(data.error || 'Request failed');
  }

  return response.json();
}

function adminGet(endpoint) {
  return api(endpoint, { method: 'GET' });
}

function adminPost(endpoint, body) {
  return api(endpoint, { method: 'POST', body: JSON.stringify(body) });
}

function adminPut(endpoint, body) {
  return api(endpoint, { method: 'PUT', body: JSON.stringify(body) });
}

// ============================================================
// STATE
// ============================================================

let teamsData = [];
let selectedMembers = new Set();
let pizzasConfig = [];

// Settings state
let settingsState = {
  maxTeamSize: 15,
  maxTotalParticipants: 200,
  minTeamSize: 1,
  schoolName: "Université d'Evry",
  pizzas: [],
  bacLevels: [],
  isDirty: false
};

// Import state
let csvData = null;
let parsedRows = [];

// DOM Elements
const elements = {
  authSection: $('auth-section'),
  adminContent: $('admin-content'),
  tokenInput: $('admin-token'),
  authBtn: $('auth-btn'),
  authError: $('auth-error'),
  statsGrid: $('stats-grid'),
  foodStats: $('food-stats'),
  teamsContainer: $('teams-container'),
  exportOfficialBtn: $('export-official-btn'),
  exportAllBtn: $('export-all-btn'),
  refreshBtn: $('refresh-btn'),
  addTeamBtn: $('add-team-btn'),
  addMemberBtn: $('add-member-btn'),
  selectAllBtn: $('select-all-btn'),
  deleteSelectedBtn: $('delete-selected-btn'),
  teamModal: $('team-modal'),
  memberModal: $('member-modal'),
  confirmModal: $('confirm-modal'),
  teamForm: $('team-form'),
  memberForm: $('member-form'),
  confirmDeleteBtn: $('confirm-delete-btn')
};

// ============================================================
// MODAL & DISCLOSURE FUNCTIONS
// ============================================================

window.closeModal = function(modalId) {
  $(modalId).classList.add('hidden');
};

function openModal(modalId) {
  $(modalId).classList.remove('hidden');
}

window.toggleDisclosure = function(name) {
  const group = document.querySelector(`[data-disclosure="${name}"]`);
  if (group) {
    group.classList.toggle('open');
  }
};

// ============================================================
// RENDER FUNCTIONS
// ============================================================

function renderStats(stats) {
  elements.statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.total_teams}</div>
      <div class="stat-label">Équipes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total_participants}</div>
      <div class="stat-label">Participants</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.max_participants}</div>
      <div class="stat-label">Capacité max</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.available_spots}</div>
      <div class="stat-label">Places restantes</div>
    </div>
  `;
}

function renderFoodStats(foodPreferences) {
  if (!foodPreferences || foodPreferences.length === 0) {
    elements.foodStats.innerHTML = '<p>Aucune préférence enregistrée</p>';
    return;
  }

  elements.foodStats.innerHTML = foodPreferences
    .map(item => `
      <div class="food-item">
        <span class="count">${item.count}</span> ${escapeHtml(item.food_diet)}
      </div>
    `)
    .join('');
}

function renderTeams(teams) {
  teamsData = teams;
  updateTeamSelect();

  if (!teams || teams.length === 0) {
    elements.teamsContainer.innerHTML = '<p>Aucune équipe inscrite</p>';
    return;
  }

  elements.teamsContainer.innerHTML = teams.map(team => `
    <div class="team-block" data-team-id="${team.id}">
      <div class="team-header" onclick="toggleTeam(${team.id})">
        <h3>${escapeHtml(team.name)}</h3>
        <div class="team-info">
          <span>${team.members?.length || 0} membre(s)</span>
        </div>
      </div>
      <div class="team-body">
        ${team.description ? `<p><em>${escapeHtml(team.description)}</em></p>` : ''}
        <div class="team-actions action-buttons">
          <button type="button" class="icon-btn" onclick="editTeam(${team.id})" title="Modifier" aria-label="Modifier l'équipe">􀈊</button>
          <button type="button" class="action-btn" onclick="exportTeam(${team.id}, '${escapeHtml(team.name)}')">Exporter CSV</button>
          <button type="button" class="action-btn primary" onclick="exportTeamOfficial(${team.id}, '${escapeHtml(team.name)}')">Export Officiel</button>
          ${team.name !== 'Organisation' ? `<button type="button" class="icon-btn danger" onclick="confirmDeleteTeam(${team.id}, '${escapeHtml(team.name)}')" title="Supprimer" aria-label="Supprimer l'équipe">􀈑</button>` : ''}
        </div>
        ${renderMembersTable(team.members, team.id)}
      </div>
    </div>
  `).join('');
}

function renderMembersTable(members, teamId) {
  if (!members || members.length === 0) {
    return '<p>Aucun membre</p>';
  }

  return `
    <div class="table-container">
    <table class="members-table">
      <thead>
        <tr>
          <th class="checkbox-col">
            <label class="select-all-label">
              <input type="checkbox" onchange="toggleSelectAll(${teamId}, this.checked)">
            </label>
          </th>
          <th>Nom</th>
          <th>Email</th>
          <th>Niveau</th>
          <th>Pizza</th>
          <th>Rôle</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${members.map(m => `
          <tr class="member-row" data-member-id="${m.id}">
            <td class="checkbox-col">
              <input type="checkbox" onchange="toggleMemberSelect(${m.id}, this.checked)">
            </td>
            <td>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</td>
            <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
            <td><span class="badge badge-bac">BAC+${m.bac_level}</span></td>
            <td>${escapeHtml(m.food_diet) || '-'}</td>
            <td>${m.is_leader ? '<span class="badge badge-leader">Chef</span>' : ''}</td>
            <td class="actions-col">
              <div class="action-buttons">
                <button type="button" class="icon-btn" onclick="editMember(${m.id}, ${teamId})" title="Modifier" aria-label="Modifier le membre">􀈊</button>
                <button type="button" class="icon-btn danger" onclick="confirmDeleteMember(${m.id}, '${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}')" title="Supprimer" aria-label="Supprimer le membre">􀈑</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    </div>
  `;
}

function updateTeamSelect() {
  const select = $('member-form-team');
  if (select) {
    select.innerHTML = teamsData.map(t =>
      `<option value="${t.id}">${escapeHtml(t.name)}</option>`
    ).join('');
  }
}

// ============================================================
// UI HELPERS
// ============================================================

function showAuth() {
  elements.authSection.classList.remove('hidden');
  elements.adminContent.classList.add('hidden');
}

function showAdmin() {
  elements.authSection.classList.add('hidden');
  elements.adminContent.classList.remove('hidden');
}

function showAuthError(message) {
  elements.authError.textContent = message;
  elements.authError.classList.remove('hidden');
}

function hideAuthError() {
  elements.authError.classList.add('hidden');
}

function updateDeleteButton() {
  elements.deleteSelectedBtn.disabled = selectedMembers.size === 0;
  elements.deleteSelectedBtn.textContent = selectedMembers.size > 0
    ? `Supprimer sélection (${selectedMembers.size})`
    : 'Supprimer sélection';
}

// ============================================================
// GLOBAL FUNCTIONS FOR ONCLICK HANDLERS
// ============================================================

window.toggleTeam = function(teamId) {
  const block = document.querySelector(`[data-team-id="${teamId}"]`);
  if (block) block.classList.toggle('open');
};

window.toggleSelectAll = function(teamId, checked) {
  const block = document.querySelector(`[data-team-id="${teamId}"]`);
  block.querySelectorAll('.member-row input[type="checkbox"]').forEach(cb => {
    cb.checked = checked;
    const memberId = parseInt(cb.closest('.member-row').dataset.memberId);
    if (checked) {
      selectedMembers.add(memberId);
    } else {
      selectedMembers.delete(memberId);
    }
  });
  updateDeleteButton();
};

window.toggleMemberSelect = function(memberId, checked) {
  if (checked) {
    selectedMembers.add(memberId);
  } else {
    selectedMembers.delete(memberId);
  }
  updateDeleteButton();
};

window.exportTeam = async function(teamId, teamName) {
  try {
    const response = await api(`/admin/export/${teamId}`);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `participants_${teamName.replace(/[^a-z0-9]/gi, '_')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
};

window.exportTeamOfficial = async function(teamId, teamName) {
  try {
    const response = await api(`/admin/export-official/${teamId}`);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `participants_officiel_${teamName.replace(/[^a-z0-9]/gi, '_')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastSuccess('Export officiel téléchargé');
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
};

// ============================================================
// TEAM CRUD
// ============================================================

window.editTeam = function(teamId) {
  const team = teamsData.find(t => t.id === teamId);
  if (!team) return;

  $('team-modal-title').textContent = 'Modifier l\'équipe';
  $('team-form-id').value = teamId;
  $('team-form-name').value = team.name;
  $('team-form-desc').value = team.description || '';
  $('team-form-password').value = '';
  openModal('team-modal');
};

function openAddTeamModal() {
  $('team-modal-title').textContent = 'Nouvelle équipe';
  $('team-form-id').value = '';
  $('team-form-name').value = '';
  $('team-form-desc').value = '';
  $('team-form-password').value = '';
  openModal('team-modal');
}

window.confirmDeleteTeam = function(teamId, teamName) {
  $('confirm-message').textContent =
    `Êtes-vous sûr de vouloir supprimer l'équipe "${teamName}" et tous ses membres ?`;
  elements.confirmDeleteBtn.onclick = () => deleteTeam(teamId);
  openModal('confirm-modal');
};

async function deleteTeam(teamId) {
  try {
    await api(`/admin/teams/${teamId}`, { method: 'DELETE' });
    toastSuccess('Équipe supprimée');
    closeModal('confirm-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

// ============================================================
// MEMBER CRUD
// ============================================================

window.editMember = function(memberId, teamId) {
  const team = teamsData.find(t => t.id === teamId);
  const member = team?.members?.find(m => m.id === memberId);
  if (!member) return;

  $('member-modal-title').textContent = 'Modifier le membre';
  $('member-form-id').value = memberId;
  $('member-form-team').value = teamId;
  $('member-form-firstname').value = member.first_name;
  $('member-form-lastname').value = member.last_name;
  $('member-form-email').value = member.email;
  $('member-form-bac').value = member.bac_level;
  $('member-form-food').value = member.food_diet || '';
  $('member-form-leader').checked = !!member.is_leader;
  openModal('member-modal');
};

function openAddMemberModal() {
  $('member-modal-title').textContent = 'Nouveau membre';
  $('member-form-id').value = '';
  $('member-form-team').value = teamsData[0]?.id || '';
  $('member-form-firstname').value = '';
  $('member-form-lastname').value = '';
  $('member-form-email').value = '';
  $('member-form-bac').value = '0';
  $('member-form-food').value = '';
  $('member-form-leader').checked = false;
  openModal('member-modal');
}

window.confirmDeleteMember = function(memberId, memberName) {
  $('confirm-message').textContent =
    `Êtes-vous sûr de vouloir supprimer ${memberName} ?`;
  elements.confirmDeleteBtn.onclick = () => deleteMember(memberId);
  openModal('confirm-modal');
};

async function deleteMember(memberId) {
  try {
    await api(`/admin/members/${memberId}`, { method: 'DELETE' });
    toastSuccess('Membre supprimé');
    closeModal('confirm-modal');
    selectedMembers.delete(memberId);
    updateDeleteButton();
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

async function deleteSelectedMembers() {
  if (selectedMembers.size === 0) return;

  $('confirm-message').textContent =
    `Êtes-vous sûr de vouloir supprimer ${selectedMembers.size} membre(s) ?`;
  elements.confirmDeleteBtn.onclick = async () => {
    try {
      await api('/admin/members/delete-batch', {
        method: 'POST',
        body: JSON.stringify({ memberIds: Array.from(selectedMembers) })
      });
      toastSuccess(`${selectedMembers.size} membre(s) supprimé(s)`);
      closeModal('confirm-modal');
      selectedMembers.clear();
      updateDeleteButton();
      loadData();
    } catch (err) {
      toastError('Erreur: ' + err.message);
    }
  };
  openModal('confirm-modal');
}

function selectAllParticipants() {
  // Get all member checkboxes across all teams
  const allCheckboxes = document.querySelectorAll('.member-row input[type="checkbox"]');
  const allSelected = selectedMembers.size === allCheckboxes.length && allCheckboxes.length > 0;

  // Toggle: if all are selected, deselect all; otherwise select all
  allCheckboxes.forEach(cb => {
    const memberId = parseInt(cb.closest('.member-row').dataset.memberId);
    if (allSelected) {
      cb.checked = false;
      selectedMembers.delete(memberId);
    } else {
      cb.checked = true;
      selectedMembers.add(memberId);
    }
  });

  // Also update the team-level "select all" checkboxes
  document.querySelectorAll('.team-block input[type="checkbox"]').forEach(cb => {
    if (!cb.closest('.member-row')) {
      cb.checked = !allSelected;
    }
  });

  updateDeleteButton();
  updateSelectAllButton();
}

function updateSelectAllButton() {
  const allCheckboxes = document.querySelectorAll('.member-row input[type="checkbox"]');
  const allSelected = selectedMembers.size === allCheckboxes.length && allCheckboxes.length > 0;
  elements.selectAllBtn.textContent = allSelected ? 'Tout désélectionner' : 'Tout sélectionner';
}

// ============================================================
// FORM HANDLERS
// ============================================================

async function handleTeamSubmit(e) {
  e.preventDefault();
  const id = $('team-form-id').value;
  const name = $('team-form-name').value;
  const description = $('team-form-desc').value;
  const password = $('team-form-password').value;

  try {
    if (id) {
      await api(`/admin/teams/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ name, description, password })
      });
      toastSuccess('Équipe mise à jour');
    } else {
      await api('/admin/teams', {
        method: 'POST',
        body: JSON.stringify({ name, description, password })
      });
      toastSuccess('Équipe créée');
    }
    closeModal('team-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

async function handleMemberSubmit(e) {
  e.preventDefault();
  const id = $('member-form-id').value;
  const teamId = parseInt($('member-form-team').value);
  const firstName = $('member-form-firstname').value;
  const lastName = $('member-form-lastname').value;
  const email = $('member-form-email').value;
  const bacLevel = parseInt($('member-form-bac').value);
  const foodDiet = $('member-form-food').value;
  const isLeader = $('member-form-leader').checked;

  try {
    if (id) {
      await api(`/admin/members/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ teamId, firstName, lastName, email, bacLevel, foodDiet, isLeader })
      });
      toastSuccess('Membre mis à jour');
    } else {
      await api('/admin/members', {
        method: 'POST',
        body: JSON.stringify({ teamId, firstName, lastName, email, bacLevel, foodDiet, isLeader })
      });
      toastSuccess('Membre ajouté');
    }
    closeModal('member-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

// ============================================================
// AUTH & DATA LOADING
// ============================================================

async function handleAuth() {
  const token = elements.tokenInput.value.trim();
  if (!token) {
    showAuthError('Token requis');
    return;
  }

  adminToken = token;
  hideAuthError();

  try {
    await loadData();
    localStorage.setItem('ndi_admin_token', token);
    showAdmin();
    initSettings();
    initImport();
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuthError('Token invalide');
      adminToken = '';
      localStorage.removeItem('ndi_admin_token');
    } else {
      showAuthError('Erreur: ' + err.message);
    }
  }
}

async function loadData() {
  const { stats, teams } = await api('/admin/stats');
  renderStats(stats);
  renderFoodStats(stats.food_preferences);
  renderTeams(teams);
  await loadSettings();
  await loadPizzasConfig();
}

async function loadPizzasConfig() {
  try {
    const response = await fetch('./api/config');
    const { config } = await response.json();
    pizzasConfig = config.pizzas || [];
    updatePizzaSelect();
  } catch (err) {
    console.error('Error loading pizzas config:', err);
  }
}

function updatePizzaSelect() {
  const select = $('member-form-food');
  if (!select) return;

  select.innerHTML = '<option value="">Aucune</option>' +
    pizzasConfig.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('');
}

async function handleExportAll() {
  try {
    const response = await api('/admin/export');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'participants.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
}

async function handleExportOfficial() {
  try {
    const response = await api('/admin/export-official');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'participants_officiel.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastSuccess('Export officiel téléchargé');
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
}

async function handleRefresh() {
  try {
    await loadData();
    toastSuccess('Données actualisées');
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuth();
      showAuthError('Session expirée');
    } else {
      toastError('Erreur: ' + err.message);
    }
  }
}

// ============================================================
// SETTINGS MODULE
// ============================================================

async function loadSettings() {
  try {
    const data = await adminGet('/admin/settings');
    settingsState.maxTeamSize = parseInt(data.settings.max_team_size, 10) || 15;
    settingsState.maxTotalParticipants = parseInt(data.settings.max_total_participants, 10) || 200;
    settingsState.minTeamSize = parseInt(data.settings.min_team_size, 10) || 1;
    settingsState.schoolName = data.settings.school_name || "Université d'Evry";
    settingsState.pizzas = data.settings.pizzas || [];
    settingsState.bacLevels = data.settings.bac_levels || [];
    settingsState.isDirty = false;

    renderSettings();
  } catch (err) {
    console.error('Error loading settings:', err);
  }
}

function renderSettings() {
  const schoolNameInput = $('setting-school-name');
  if (schoolNameInput) schoolNameInput.value = settingsState.schoolName;

  const maxTeamInput = $('setting-max-team');
  const maxParticipantsInput = $('setting-max-participants');
  const minTeamInput = $('setting-min-team');

  if (maxTeamInput) maxTeamInput.value = settingsState.maxTeamSize;
  if (maxParticipantsInput) maxParticipantsInput.value = settingsState.maxTotalParticipants;
  if (minTeamInput) minTeamInput.value = settingsState.minTeamSize;

  renderPizzasList();
  updateSaveButton();
}

function renderPizzasList() {
  const container = $('pizzas-list');
  if (!container) return;

  if (settingsState.pizzas.length === 0) {
    container.innerHTML = '<p class="text-muted">Aucune pizza configurée</p>';
    return;
  }

  container.innerHTML = settingsState.pizzas.map((pizza, index) => `
    <div class="pizza-item" data-index="${index}">
      <div class="pizza-item-info">
        <span class="pizza-item-id">${escapeHtml(pizza.id)}</span>
        <span class="pizza-item-name">${escapeHtml(pizza.name)}</span>
        <span class="pizza-item-desc">${escapeHtml(pizza.description || '')}</span>
      </div>
      <div class="pizza-item-actions action-buttons">
        <button type="button" class="icon-btn sm edit-pizza-btn" data-index="${index}" title="Modifier" aria-label="Modifier la pizza">􀈊</button>
        <button type="button" class="icon-btn sm danger delete-pizza-btn" data-index="${index}" title="Supprimer" aria-label="Supprimer la pizza">􀈑</button>
      </div>
    </div>
  `).join('');

  container.querySelectorAll('.edit-pizza-btn').forEach(btn => {
    btn.addEventListener('click', () => editPizza(parseInt(btn.dataset.index, 10)));
  });

  container.querySelectorAll('.delete-pizza-btn').forEach(btn => {
    btn.addEventListener('click', () => deletePizza(parseInt(btn.dataset.index, 10)));
  });
}

function initSettings() {
  ['setting-max-team', 'setting-max-participants', 'setting-min-team', 'setting-school-name'].forEach(id => {
    const input = $(id);
    if (input) {
      input.addEventListener('change', markDirty);
      input.addEventListener('input', markDirty);
    }
  });

  const saveBtn = $('save-settings-btn');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveSettings);
  }

  const addPizzaForm = $('add-pizza-form-element');
  if (addPizzaForm) {
    addPizzaForm.addEventListener('submit', (e) => {
      e.preventDefault();
      addPizzaFromForm();
    });
  }
}

function markDirty() {
  settingsState.isDirty = true;
  updateSaveButton();
}

function updateSaveButton() {
  const saveBtn = $('save-settings-btn');
  if (saveBtn) {
    saveBtn.disabled = !settingsState.isDirty;
    saveBtn.textContent = settingsState.isDirty ? 'Enregistrer *' : 'Enregistrer';
  }
}

function addPizzaFromForm() {
  const idInput = $('new-pizza-id');
  const nameInput = $('new-pizza-name');
  const descInput = $('new-pizza-desc');

  if (!idInput || !nameInput) return;

  const id = idInput.value.trim().toLowerCase().replace(/\s+/g, '_');
  const name = nameInput.value.trim();
  const description = descInput?.value.trim() || '';

  if (!id || !name) {
    toastError('ID et nom requis');
    return;
  }

  if (settingsState.pizzas.some(p => p.id === id)) {
    toastError('Une pizza avec cet ID existe déjà');
    return;
  }

  settingsState.pizzas.push({ id, name, description });
  markDirty();
  renderPizzasList();

  idInput.value = '';
  nameInput.value = '';
  if (descInput) descInput.value = '';

  toastSuccess('Pizza ajoutée (non sauvegardée)');
}

function editPizza(index) {
  const pizza = settingsState.pizzas[index];
  if (!pizza) return;

  const newName = prompt('Nom de la pizza:', pizza.name);
  if (newName === null) return;

  const newDesc = prompt('Description:', pizza.description || '');
  if (newDesc === null) return;

  settingsState.pizzas[index] = {
    ...pizza,
    name: newName.trim() || pizza.name,
    description: newDesc.trim()
  };

  markDirty();
  renderPizzasList();
}

function deletePizza(index) {
  const pizza = settingsState.pizzas[index];
  if (!pizza) return;

  if (!confirm(`Supprimer la pizza "${pizza.name}" ?`)) return;

  settingsState.pizzas.splice(index, 1);
  markDirty();
  renderPizzasList();
}

async function saveSettings() {
  try {
    const maxTeamSize = parseInt($('setting-max-team')?.value, 10);
    const maxTotalParticipants = parseInt($('setting-max-participants')?.value, 10);
    const minTeamSize = parseInt($('setting-min-team')?.value, 10);
    const schoolName = $('setting-school-name')?.value?.trim() || "Université d'Evry";

    if (isNaN(maxTeamSize) || maxTeamSize < 1 || maxTeamSize > 100) {
      toastError('Taille max d\'équipe invalide (1-100)');
      return;
    }
    if (isNaN(maxTotalParticipants) || maxTotalParticipants < 1 || maxTotalParticipants > 10000) {
      toastError('Participants max invalide (1-10000)');
      return;
    }
    if (isNaN(minTeamSize) || minTeamSize < 1 || minTeamSize > 50) {
      toastError('Taille min d\'équipe invalide (1-50)');
      return;
    }

    const saveBtn = $('save-settings-btn');
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Enregistrement...';
    }

    await adminPut('/admin/settings', {
      max_team_size: maxTeamSize,
      max_total_participants: maxTotalParticipants,
      min_team_size: minTeamSize,
      school_name: schoolName,
      pizzas: settingsState.pizzas
    });

    settingsState.isDirty = false;
    settingsState.maxTeamSize = maxTeamSize;
    settingsState.maxTotalParticipants = maxTotalParticipants;
    settingsState.minTeamSize = minTeamSize;
    settingsState.schoolName = schoolName;

    updateSaveButton();
    toastSuccess('Paramètres enregistrés');
  } catch (err) {
    console.error('Error saving settings:', err);
    toastError(err.message || 'Erreur lors de la sauvegarde');
    updateSaveButton();
  }
}

// ============================================================
// IMPORT MODULE
// ============================================================

function initImport() {
  const fileInput = $('import-file');
  const importBtn = $('import-btn');

  if (fileInput) {
    fileInput.addEventListener('change', handleFileSelect);
  }

  if (importBtn) {
    importBtn.addEventListener('click', handleImport);
  }
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) {
    resetImport();
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    csvData = e.target.result;
    parseAndPreview(csvData);
  };
  reader.onerror = () => {
    toastError('Erreur lors de la lecture du fichier');
    resetImport();
  };
  reader.readAsText(file);
}

function parseAndPreview(csv) {
  try {
    const lines = csv.trim().split('\n');
    if (lines.length < 2) {
      throw new Error('Le fichier doit contenir au moins une ligne de données');
    }

    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    parsedRows = [];

    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLine(lines[i]);
      if (values.length === headers.length) {
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx].trim();
        });
        parsedRows.push(row);
      }
    }

    const teams = new Set(parsedRows.map(r => r.teamname || 'Sans équipe'));

    const preview = $('import-preview');
    const previewContent = $('import-preview-content');
    const importBtn = $('import-btn');
    const status = $('import-status');

    if (preview && previewContent) {
      previewContent.innerHTML = `
        <p><strong>${parsedRows.length}</strong> membres dans <strong>${teams.size}</strong> équipes</p>
        <table class="import-preview-table">
          <thead>
            <tr>
              <th>Équipe</th>
              <th>Prénom</th>
              <th>Nom</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody>
            ${parsedRows.slice(0, 5).map(row => `
              <tr>
                <td>${escapeHtml(row.teamname || '-')}</td>
                <td>${escapeHtml(row.firstname || '-')}</td>
                <td>${escapeHtml(row.lastname || '-')}</td>
                <td>${escapeHtml(row.email || '-')}</td>
              </tr>
            `).join('')}
            ${parsedRows.length > 5 ? `<tr><td colspan="4" style="text-align:center;color:var(--color-text-muted)">... et ${parsedRows.length - 5} autres</td></tr>` : ''}
          </tbody>
        </table>
      `;
      preview.classList.remove('hidden');
    }

    if (importBtn) {
      importBtn.disabled = false;
    }

    if (status) {
      status.textContent = '';
      status.className = 'import-status';
    }

  } catch (err) {
    toastError(err.message);
    resetImport();
  }
}

function parseCSVLine(line) {
  const values = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      values.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  values.push(current);

  return values;
}

async function handleImport() {
  if (!csvData) {
    toastError('Veuillez sélectionner un fichier');
    return;
  }

  const importBtn = $('import-btn');
  const status = $('import-status');

  if (importBtn) {
    importBtn.disabled = true;
    importBtn.textContent = 'Import en cours...';
  }

  if (status) {
    status.textContent = 'Import en cours...';
    status.className = 'import-status';
  }

  try {
    const result = await adminPost('/admin/import', { csv: csvData });

    if (result.success) {
      const { stats } = result;
      toastSuccess(`Import terminé: ${stats.membersImported} membres, ${stats.teamsCreated} équipes créées`);

      if (status) {
        status.textContent = `✓ ${stats.membersImported} importés, ${stats.membersSkipped} ignorés, ${stats.teamsCreated} équipes créées`;
        status.className = 'import-status success';
      }

      loadData();
    } else {
      throw new Error(result.error || 'Erreur lors de l\'import');
    }

  } catch (err) {
    console.error('Import error:', err);
    toastError(err.message || 'Erreur lors de l\'import');

    if (status) {
      status.textContent = `✗ Erreur: ${err.message}`;
      status.className = 'import-status error';
    }
  } finally {
    if (importBtn) {
      importBtn.disabled = false;
      importBtn.textContent = 'Importer';
    }
  }
}

function resetImport() {
  csvData = null;
  parsedRows = [];

  const preview = $('import-preview');
  const importBtn = $('import-btn');
  const status = $('import-status');

  if (preview) {
    preview.classList.add('hidden');
  }

  if (importBtn) {
    importBtn.disabled = true;
  }

  if (status) {
    status.textContent = '';
    status.className = 'import-status';
  }
}

// ============================================================
// TAB NAVIGATION
// ============================================================

let activeTab = 'registrations';

function initTabs() {
  document.querySelectorAll('.tab-item').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });
}

function switchTab(tabId) {
  activeTab = tabId;

  // Update tab buttons
  document.querySelectorAll('.tab-item').forEach(tab => {
    const isActive = tab.dataset.tab === tabId;
    tab.classList.toggle('active', isActive);
    tab.setAttribute('aria-selected', isActive);
  });

  // Update panels
  document.querySelectorAll('.tab-panel').forEach(panel => {
    const isActive = panel.id === `panel-${tabId}`;
    panel.classList.toggle('hidden', !isActive);
  });

  // Load attendance data when switching to attendance tab
  if (tabId === 'attendance') {
    loadAttendanceData();
  }
}

// ============================================================
// ATTENDANCE MANAGEMENT
// ============================================================

let attendanceData = [];
let attendanceSearchTerm = '';

async function loadAttendanceData() {
  try {
    const data = await adminGet('/admin/attendance');
    attendanceData = data.members || [];
    renderAttendanceStats(data.stats);
    renderAttendance();
    updateAttendanceBadge(data.stats.checked_in);
  } catch (err) {
    console.error('Error loading attendance:', err);
    toastError('Erreur lors du chargement des présences');
  }
}

function renderAttendanceStats(stats) {
  const grid = $('attendance-stats-grid');
  if (!grid) return;

  const percentage = stats.total > 0 ? Math.round((stats.checked_in / stats.total) * 100) : 0;

  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.checked_in}</div>
      <div class="stat-label">Présents</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.not_checked_in}</div>
      <div class="stat-label">Absents</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total}</div>
      <div class="stat-label">Total inscrits</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${percentage}%</div>
      <div class="stat-label">Taux de présence</div>
    </div>
  `;
}

function renderAttendance() {
  const tbody = $('attendance-tbody');
  if (!tbody) return;

  const filterCheckedIn = $('filter-checked-in')?.checked;
  const filterNotCheckedIn = $('filter-not-checked-in')?.checked;

  let filtered = attendanceData;

  // Apply search filter
  if (attendanceSearchTerm) {
    const term = attendanceSearchTerm.toLowerCase();
    filtered = filtered.filter(m =>
      m.first_name.toLowerCase().includes(term) ||
      m.last_name.toLowerCase().includes(term) ||
      m.email.toLowerCase().includes(term) ||
      m.team_name.toLowerCase().includes(term)
    );
  }

  // Apply status filters
  if (filterCheckedIn && !filterNotCheckedIn) {
    filtered = filtered.filter(m => m.checked_in === 1);
  } else if (filterNotCheckedIn && !filterCheckedIn) {
    filtered = filtered.filter(m => m.checked_in === 0 || m.checked_in === null);
  }

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Aucun participant trouvé</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(m => {
    const isCheckedIn = m.checked_in === 1;
    const checkedInTime = m.checked_in_at ? new Date(m.checked_in_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-';

    return `
      <tr class="member-row ${isCheckedIn ? 'checked-in' : ''}" data-member-id="${m.id}">
        <td><strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong></td>
        <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
        <td>${escapeHtml(m.team_name)}</td>
        <td>
          ${isCheckedIn
            ? '<span class="badge badge-success">Présent</span>'
            : '<span class="badge badge-muted">Absent</span>'}
        </td>
        <td>${checkedInTime}</td>
        <td class="actions-col">
          <div class="action-buttons">
            ${isCheckedIn
              ? `<button type="button" class="btn btn-sm btn-danger" onclick="handleCheckOut(${m.id})">Annuler</button>`
              : `<button type="button" class="btn btn-sm btn-primary" onclick="handleCheckIn(${m.id})">Valider</button>`}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function updateAttendanceBadge(count) {
  const badge = $('attendance-badge');
  if (badge) badge.textContent = count || 0;
}

window.handleCheckIn = async function(memberId) {
  try {
    await adminPost(`/admin/attendance/check-in/${memberId}`);
    await loadAttendanceData();
    toastSuccess('Présence validée');
  } catch (err) {
    console.error('Error checking in:', err);
    toastError('Erreur lors de la validation');
  }
};

window.handleCheckOut = async function(memberId) {
  try {
    await adminPost(`/admin/attendance/check-out/${memberId}`);
    await loadAttendanceData();
    toastSuccess('Présence annulée');
  } catch (err) {
    console.error('Error checking out:', err);
    toastError('Erreur lors de l\'annulation');
  }
};

function initAttendance() {
  const searchInput = $('attendance-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      attendanceSearchTerm = e.target.value;
      renderAttendance();
    });
  }

  const filterCheckedIn = $('filter-checked-in');
  const filterNotCheckedIn = $('filter-not-checked-in');

  if (filterCheckedIn) {
    filterCheckedIn.addEventListener('change', renderAttendance);
  }
  if (filterNotCheckedIn) {
    filterNotCheckedIn.addEventListener('change', renderAttendance);
  }

  const refreshBtn = $('refresh-attendance-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadAttendanceData);
  }
}

// ============================================================
// TEAMS SEARCH
// ============================================================

let teamsSearchTerm = '';

function initTeamsSearch() {
  const searchInput = $('teams-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      teamsSearchTerm = e.target.value.toLowerCase();
      filterTeams();
    });
  }
}

function filterTeams() {
  const container = $('teams-container');
  if (!container) return;

  const teamBlocks = container.querySelectorAll('.team-block');

  teamBlocks.forEach(block => {
    const teamName = block.querySelector('.team-header h3')?.textContent.toLowerCase() || '';
    const memberNames = Array.from(block.querySelectorAll('.member-row td:nth-child(2)')).map(td => td.textContent.toLowerCase());
    const memberEmails = Array.from(block.querySelectorAll('.member-row td:nth-child(3)')).map(td => td.textContent.toLowerCase());

    const matchesTeam = teamName.includes(teamsSearchTerm);
    const matchesMember = memberNames.some(name => name.includes(teamsSearchTerm)) ||
                          memberEmails.some(email => email.includes(teamsSearchTerm));

    if (teamsSearchTerm === '' || matchesTeam || matchesMember) {
      block.style.display = '';
      // If search matches a member, expand the team
      if (matchesMember && teamsSearchTerm !== '') {
        block.classList.add('open');
      }
    } else {
      block.style.display = 'none';
    }
  });
}

// ============================================================
// INITIALIZE
// ============================================================

async function init() {
  elements.authBtn.addEventListener('click', handleAuth);
  elements.tokenInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleAuth();
  });
  elements.exportOfficialBtn.addEventListener('click', handleExportOfficial);
  elements.exportAllBtn.addEventListener('click', handleExportAll);
  elements.refreshBtn.addEventListener('click', handleRefresh);
  elements.addTeamBtn.addEventListener('click', openAddTeamModal);
  elements.addMemberBtn.addEventListener('click', openAddMemberModal);
  elements.selectAllBtn.addEventListener('click', selectAllParticipants);
  elements.deleteSelectedBtn.addEventListener('click', deleteSelectedMembers);
  elements.teamForm.addEventListener('submit', handleTeamSubmit);
  elements.memberForm.addEventListener('submit', handleMemberSubmit);

  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  });

  // Initialize tabs and search
  initTabs();
  initTeamsSearch();
  initAttendance();

  if (adminToken) {
    try {
      await loadData();
      showAdmin();
      initSettings();
      initImport();
    } catch (err) {
      showAuth();
      if (err.message === 'Unauthorized') {
        localStorage.removeItem('ndi_admin_token');
        adminToken = '';
      }
    }
  } else {
    showAuth();
  }
}

window.loadData = loadData;

init();
</script>
</AdminLayout>
