---
/**
 * NDI Admin Dashboard
 * Refactored with modular components
 */
import AdminLayout from '../layouts/AdminLayout.astro';
import AdminHeader from '../components/admin/AdminHeader.astro';
import AdminAuth from '../components/admin/AdminAuth.astro';
import RegistrationsTab from '../components/admin/tabs/RegistrationsTab.astro';
import AttendanceTab from '../components/admin/tabs/AttendanceTab.astro';
import PizzaTab from '../components/admin/tabs/PizzaTab.astro';
import RoomsTab from '../components/admin/tabs/RoomsTab.astro';
import ArchivesTab from '../components/admin/tabs/ArchivesTab.astro';
import SettingsTab from '../components/admin/tabs/SettingsTab.astro';
import TeamModal from '../components/admin/modals/TeamModal.astro';
import MemberModal from '../components/admin/modals/MemberModal.astro';
import ConfirmModal from '../components/admin/modals/ConfirmModal.astro';
import CheckinModal from '../components/admin/modals/CheckinModal.astro';
---

<AdminLayout title="NDI Admin - Gestion des équipes - Asso Info Evry">
  <AdminHeader />

  <main class="container-wide admin">
    <AdminAuth />

    <div id="admin-content" class="hidden admin-layout">
      <!-- Sidebar Navigation -->
      <nav class="admin-sidebar" id="admin-sidebar">
        <ul class="admin-sidebar-nav">
          <li>
            <button type="button" class="admin-sidebar-item active" data-tab="registrations">
              <span class="admin-sidebar-icon sf-symbol">@sfs:list.bullet@</span>
              <span class="admin-sidebar-label">Inscriptions</span>
            </button>
          </li>
          <li>
            <button type="button" class="admin-sidebar-item" data-tab="attendance">
              <span class="admin-sidebar-icon sf-symbol">@sfs:person.badge.clock@</span>
              <span class="admin-sidebar-label">Présences</span>
              <span id="attendance-badge" class="admin-sidebar-badge">0</span>
            </button>
          </li>
          <li>
            <button type="button" class="admin-sidebar-item" data-tab="pizza">
              <span class="admin-sidebar-icon sf-symbol">@sfs:fork.knife@</span>
              <span class="admin-sidebar-label">Pizzas</span>
              <span id="pizza-badge" class="admin-sidebar-badge">0</span>
            </button>
          </li>
          <li>
            <button type="button" class="admin-sidebar-item" data-tab="rooms">
              <span class="admin-sidebar-icon sf-symbol">@sfs:building.2@</span>
              <span class="admin-sidebar-label">Salles</span>
              <span id="rooms-badge" class="admin-sidebar-badge">0</span>
            </button>
          </li>
          <li>
            <button type="button" class="admin-sidebar-item" data-tab="archives">
              <span class="admin-sidebar-icon sf-symbol">@sfs:archivebox@</span>
              <span class="admin-sidebar-label">Archives</span>
              <span id="archives-badge" class="admin-sidebar-badge hidden">0</span>
            </button>
          </li>
          <li>
            <button type="button" class="admin-sidebar-item" data-tab="settings">
              <span class="admin-sidebar-icon sf-symbol">@sfs:gear@</span>
              <span class="admin-sidebar-label">Paramètres</span>
            </button>
          </li>
        </ul>
      </nav>

      <!-- Main Content Area -->
      <div class="admin-main">
        <RegistrationsTab />
        <AttendanceTab />
        <PizzaTab />
        <RoomsTab />
        <ArchivesTab />
        <SettingsTab />
      </div>
    </div>

    <!-- Modals -->
    <TeamModal />
    <MemberModal />
    <ConfirmModal />
    <CheckinModal />
  </main>

<script define:vars={{ baseUrl: import.meta.env.BASE_URL }}>
/**
 * NDI Admin Dashboard
 * Full CRUD functionality for teams and members
 */

// API base URL (from Astro's BASE_URL)
const API_BASE = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function $(id) {
  return document.getElementById(id);
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function truncateText(str, maxLength = 40) {
  if (!str || str.length <= maxLength) return str;
  return str.substring(0, maxLength - 1) + '…';
}

function formatTeamWithRoom(teamName, teamRoom, maxLength = 40) {
  if (!teamName) return { truncated: '-', full: '-' };
  const fullText = teamRoom ? `${teamName} (${teamRoom})` : teamName;
  const truncated = truncateText(fullText, maxLength);
  return { truncated, full: fullText };
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================

function showToast(message, type = 'success', duration = 3000) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function toastSuccess(message) {
  showToast(message, 'success');
}

function toastError(message) {
  showToast(message, 'error');
}

// ============================================================
// API FUNCTIONS
// ============================================================

let adminToken = localStorage.getItem('ndi_admin_token') || '';

async function api(endpoint, options = {}) {
  const response = await fetch(`${API_BASE}/api${endpoint}`, {
    headers: {
      'Authorization': `Bearer ${adminToken}`,
      'Content-Type': 'application/json',
      ...options.headers
    },
    ...options
  });

  if (response.status === 401) {
    throw new Error('Unauthorized');
  }

  // Handle CSV downloads
  if (response.headers.get('Content-Type')?.includes('text/csv')) {
    return response;
  }

  if (!response.ok) {
    const data = await response.json();
    throw new Error(data.error || 'Request failed');
  }

  return response.json();
}

function adminGet(endpoint) {
  return api(endpoint, { method: 'GET' });
}

function adminPost(endpoint, body) {
  return api(endpoint, { method: 'POST', body: JSON.stringify(body) });
}

function adminPut(endpoint, body) {
  return api(endpoint, { method: 'PUT', body: JSON.stringify(body) });
}

// ============================================================
// STATE
// ============================================================

let teamsData = [];
let selectedMembers = new Set();
let pizzasConfig = [];

// Settings state
let settingsState = {
  maxTeamSize: 15,
  maxTotalParticipants: 200,
  minTeamSize: 1,
  schoolName: "Université d'Evry",
  pizzas: [],
  bacLevels: [],
  isDirty: false
};

// Import state
let csvData = null;
let parsedRows = [];

// DOM Elements
const elements = {
  authSection: $('auth-section'),
  adminContent: $('admin-content'),
  tokenInput: $('admin-token'),
  authBtn: $('auth-btn'),
  authError: $('auth-error'),
  statsGrid: $('stats-grid'),
  foodStats: $('food-stats'),
  teamsContainer: $('teams-container'),
  exportOfficialBtn: $('export-official-btn'),
  exportAllBtn: $('export-all-btn'),
  refreshBtn: $('refresh-btn'),
  addTeamBtn: $('add-team-btn'),
  addMemberBtn: $('add-member-btn'),
  selectAllBtn: $('select-all-btn'),
  deleteSelectedBtn: $('delete-selected-btn'),
  teamModal: $('team-modal'),
  memberModal: $('member-modal'),
  confirmModal: $('confirm-modal'),
  teamForm: $('team-form'),
  memberForm: $('member-form'),
  confirmDeleteBtn: $('confirm-delete-btn')
};

// ============================================================
// MODAL & DISCLOSURE FUNCTIONS
// ============================================================

window.closeModal = function(modalId) {
  $(modalId).classList.add('hidden');
};

function openModal(modalId) {
  $(modalId).classList.remove('hidden');
}

window.toggleDisclosure = function(name) {
  const group = document.querySelector(`[data-disclosure="${name}"]`);
  if (group) {
    group.classList.toggle('open');
  }
};

// ============================================================
// RENDER FUNCTIONS
// ============================================================

function renderStats(stats) {
  elements.statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.total_teams}</div>
      <div class="stat-label">Équipes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total_participants}</div>
      <div class="stat-label">Participants</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.max_participants}</div>
      <div class="stat-label">Capacité max</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.available_spots}</div>
      <div class="stat-label">Places restantes</div>
    </div>
  `;
}

function renderFoodStats(foodPreferences) {
  if (!foodPreferences || foodPreferences.length === 0) {
    elements.foodStats.innerHTML = '<p>Aucune préférence enregistrée</p>';
    return;
  }

  elements.foodStats.innerHTML = foodPreferences
    .map(item => `
      <div class="food-item">
        <span class="count">${item.count}</span> ${escapeHtml(item.food_diet)}
      </div>
    `)
    .join('');
}

function renderTeams(teams) {
  teamsData = teams;
  updateTeamSelect();

  if (!teams || teams.length === 0) {
    elements.teamsContainer.innerHTML = '<p>Aucune équipe inscrite</p>';
    return;
  }

  elements.teamsContainer.innerHTML = teams.map(team => `
    <div class="team-block" data-team-id="${team.id}">
      <div class="team-header" onclick="toggleTeam(${team.id})">
        <h3>${escapeHtml(team.name)}${team.room ? ` <span class="badge badge-muted">${escapeHtml(team.room)}</span>` : ''}</h3>
        <div class="team-info">
          <span>${team.members?.length || 0} membre(s)</span>
        </div>
      </div>
      <div class="team-body">
        ${team.description ? `<p><em>${escapeHtml(team.description)}</em></p>` : ''}
        <div class="team-actions action-buttons">
          <button type="button" class="icon-btn" onclick="editTeam(${team.id})" title="Modifier" aria-label="Modifier l'équipe">􀈊</button>
          <button type="button" class="action-btn" onclick="exportTeam(${team.id}, '${escapeHtml(team.name)}')">Exporter CSV</button>
          <button type="button" class="action-btn primary" onclick="exportTeamOfficial(${team.id}, '${escapeHtml(team.name)}')">Export Officiel</button>
          ${team.name !== 'Organisation' ? `<button type="button" class="icon-btn danger" onclick="confirmDeleteTeam(${team.id}, '${escapeHtml(team.name)}')" title="Supprimer" aria-label="Supprimer l'équipe">􀈑</button>` : ''}
        </div>
        ${renderMembersTable(team.members, team.id)}
      </div>
    </div>
  `).join('');
}

function renderMembersTable(members, teamId) {
  if (!members || members.length === 0) {
    return '<p>Aucun membre</p>';
  }

  // Sort members by name by default
  const sortedMembers = [...members].sort((a, b) => {
    const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
    const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
    return nameA.localeCompare(nameB);
  });

  return `
    <div class="table-container">
    <table class="members-table" data-team-id="${teamId}">
      <thead>
        <tr>
          <th class="checkbox-col">
            <label class="select-all-label">
              <input type="checkbox" onchange="toggleSelectAll(${teamId}, this.checked)">
            </label>
          </th>
          <th class="sortable-header" data-sort="name" onclick="sortTeamMembers(${teamId}, 'name', this)">Nom <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
          <th class="sortable-header" data-sort="email" onclick="sortTeamMembers(${teamId}, 'email', this)">Email <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
          <th class="sortable-header" data-sort="bac" onclick="sortTeamMembers(${teamId}, 'bac', this)">Niveau <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
          <th>Pizza</th>
          <th>Rôle</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${sortedMembers.map(m => `
          <tr class="member-row" data-member-id="${m.id}">
            <td class="checkbox-col">
              <input type="checkbox" onchange="toggleMemberSelect(${m.id}, this.checked)" ${selectedMembers.has(m.id) ? 'checked' : ''}>
            </td>
            <td>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</td>
            <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
            <td><span class="badge badge-bac">BAC+${m.bac_level}</span></td>
            <td>${escapeHtml(m.food_diet) || '-'}</td>
            <td>${m.is_leader ? '<span class="badge badge-leader">􀋀 Chef</span>' : ''}</td>
            <td class="actions-col">
              <div class="action-buttons">
                <button type="button" class="icon-btn" onclick="editMember(${m.id}, ${teamId})" title="Modifier" aria-label="Modifier le membre">􀈊</button>
                <button type="button" class="icon-btn danger" onclick="confirmDeleteMember(${m.id}, '${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}')" title="Supprimer" aria-label="Supprimer le membre">􀈑</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    </div>
  `;
}

function updateTeamSelect() {
  const select = $('member-form-team');
  if (select) {
    select.innerHTML = teamsData.map(t =>
      `<option value="${t.id}">${escapeHtml(t.name)}</option>`
    ).join('');
  }
}

// ============================================================
// UI HELPERS
// ============================================================

function showAuth() {
  elements.authSection.classList.remove('hidden');
  elements.adminContent.classList.add('hidden');
}

function showAdmin() {
  elements.authSection.classList.add('hidden');
  elements.adminContent.classList.remove('hidden');
}

function showAuthError(message) {
  elements.authError.textContent = message;
  elements.authError.classList.remove('hidden');
}

function hideAuthError() {
  elements.authError.classList.add('hidden');
}

function updateDeleteButton() {
  elements.deleteSelectedBtn.disabled = selectedMembers.size === 0;
  elements.deleteSelectedBtn.textContent = selectedMembers.size > 0
    ? `Supprimer sélection (${selectedMembers.size})`
    : 'Supprimer sélection';
}

// ============================================================
// GLOBAL FUNCTIONS FOR ONCLICK HANDLERS
// ============================================================

window.toggleTeam = function(teamId) {
  const block = document.querySelector(`[data-team-id="${teamId}"]`);
  if (block) block.classList.toggle('open');
};

window.toggleSelectAll = function(teamId, checked) {
  const block = document.querySelector(`[data-team-id="${teamId}"]`);
  block.querySelectorAll('.member-row input[type="checkbox"]').forEach(cb => {
    cb.checked = checked;
    const memberId = parseInt(cb.closest('.member-row').dataset.memberId);
    if (checked) {
      selectedMembers.add(memberId);
    } else {
      selectedMembers.delete(memberId);
    }
  });
  updateDeleteButton();
};

window.toggleMemberSelect = function(memberId, checked) {
  if (checked) {
    selectedMembers.add(memberId);
  } else {
    selectedMembers.delete(memberId);
  }
  updateDeleteButton();
};

// Team members sorting
const teamSortState = {}; // { teamId: { key: 'name', dir: 'asc' } }

window.sortTeamMembers = function(teamId, sortKey, headerElement) {
  const team = teamsData.find(t => t.id === teamId);
  if (!team || !team.members) return;

  // Update sort state
  if (!teamSortState[teamId]) {
    teamSortState[teamId] = { key: sortKey, dir: 'asc' };
  } else if (teamSortState[teamId].key === sortKey) {
    teamSortState[teamId].dir = teamSortState[teamId].dir === 'asc' ? 'desc' : 'asc';
  } else {
    teamSortState[teamId] = { key: sortKey, dir: 'asc' };
  }

  const { key, dir } = teamSortState[teamId];

  // Sort members
  team.members.sort((a, b) => {
    let valA, valB;
    switch (key) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'email':
        valA = a.email.toLowerCase();
        valB = b.email.toLowerCase();
        break;
      case 'bac':
        valA = a.bac_level || 0;
        valB = b.bac_level || 0;
        break;
      default:
        valA = a.first_name.toLowerCase();
        valB = b.first_name.toLowerCase();
    }

    if (valA < valB) return dir === 'asc' ? -1 : 1;
    if (valA > valB) return dir === 'asc' ? 1 : -1;
    return 0;
  });

  // Update sort indicators in the table
  const table = headerElement.closest('table');
  table.querySelectorAll('.sortable-header').forEach(h => {
    if (h.dataset.sort === key) {
      h.setAttribute('data-sort-dir', dir);
      h.querySelector('.sort-indicator').textContent = dir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      h.removeAttribute('data-sort-dir');
      h.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });

  // Re-render the table body
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = team.members.map(m => `
    <tr class="member-row" data-member-id="${m.id}">
      <td class="checkbox-col">
        <input type="checkbox" onchange="toggleMemberSelect(${m.id}, this.checked)" ${selectedMembers.has(m.id) ? 'checked' : ''}>
      </td>
      <td>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</td>
      <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
      <td><span class="badge badge-bac">BAC+${m.bac_level}</span></td>
      <td>${escapeHtml(m.food_diet) || '-'}</td>
      <td>${m.is_leader ? '<span class="badge badge-leader">􀋀 Chef</span>' : ''}</td>
      <td class="actions-col">
        <div class="action-buttons">
          <button type="button" class="icon-btn" onclick="editMember(${m.id}, ${teamId})" title="Modifier" aria-label="Modifier le membre">􀈊</button>
          <button type="button" class="icon-btn danger" onclick="confirmDeleteMember(${m.id}, '${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}')" title="Supprimer" aria-label="Supprimer le membre">􀈑</button>
        </div>
      </td>
    </tr>
  `).join('');
};

window.exportTeam = async function(teamId, teamName) {
  try {
    const response = await api(`/admin/export/${teamId}`);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `participants_${teamName.replace(/[^a-z0-9]/gi, '_')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
};

window.exportTeamOfficial = async function(teamId, teamName) {
  try {
    const response = await api(`/admin/export-official/${teamId}`);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `participants_officiel_${teamName.replace(/[^a-z0-9]/gi, '_')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastSuccess('Export officiel téléchargé');
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
};

// ============================================================
// TEAM CRUD
// ============================================================

window.editTeam = function(teamId) {
  const team = teamsData.find(t => t.id === teamId);
  if (!team) return;

  $('team-modal-title').textContent = 'Modifier l\'équipe';
  $('team-form-id').value = teamId;
  $('team-form-name').value = team.name;
  $('team-form-desc').value = team.description || '';
  $('team-form-password').value = '';
  openModal('team-modal');
};

function openAddTeamModal() {
  $('team-modal-title').textContent = 'Nouvelle équipe';
  $('team-form-id').value = '';
  $('team-form-name').value = '';
  $('team-form-desc').value = '';
  $('team-form-password').value = '';
  openModal('team-modal');
}

window.confirmDeleteTeam = function(teamId, teamName) {
  $('confirm-message').textContent =
    `Êtes-vous sûr de vouloir supprimer l'équipe "${teamName}" et tous ses membres ?`;
  elements.confirmDeleteBtn.onclick = () => deleteTeam(teamId);
  openModal('confirm-modal');
};

async function deleteTeam(teamId) {
  try {
    await api(`/admin/teams/${teamId}`, { method: 'DELETE' });
    toastSuccess('Équipe supprimée');
    closeModal('confirm-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

// ============================================================
// MEMBER CRUD
// ============================================================

window.editMember = function(memberId, teamId) {
  const team = teamsData.find(t => t.id === teamId);
  const member = team?.members?.find(m => m.id === memberId);
  if (!member) return;

  $('member-modal-title').textContent = 'Modifier le membre';
  $('member-form-id').value = memberId;
  $('member-form-team').value = teamId;
  $('member-form-firstname').value = member.first_name;
  $('member-form-lastname').value = member.last_name;
  $('member-form-email').value = member.email;
  $('member-form-bac').value = member.bac_level;
  $('member-form-food').value = member.food_diet || '';
  $('member-form-leader').checked = !!member.is_leader;
  openModal('member-modal');
};

function openAddMemberModal() {
  $('member-modal-title').textContent = 'Nouveau membre';
  $('member-form-id').value = '';
  $('member-form-team').value = teamsData[0]?.id || '';
  $('member-form-firstname').value = '';
  $('member-form-lastname').value = '';
  $('member-form-email').value = '';
  $('member-form-bac').value = '0';
  $('member-form-food').value = '';
  $('member-form-leader').checked = false;
  openModal('member-modal');
}

window.confirmDeleteMember = function(memberId, memberName) {
  $('confirm-message').textContent =
    `Êtes-vous sûr de vouloir supprimer ${memberName} ?`;
  elements.confirmDeleteBtn.onclick = () => deleteMember(memberId);
  openModal('confirm-modal');
};

async function deleteMember(memberId) {
  try {
    await api(`/admin/members/${memberId}`, { method: 'DELETE' });
    toastSuccess('Membre supprimé');
    closeModal('confirm-modal');
    selectedMembers.delete(memberId);
    updateDeleteButton();
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

async function deleteSelectedMembers() {
  if (selectedMembers.size === 0) return;

  $('confirm-message').textContent =
    `Êtes-vous sûr de vouloir supprimer ${selectedMembers.size} membre(s) ?`;
  elements.confirmDeleteBtn.onclick = async () => {
    try {
      await api('/admin/members/delete-batch', {
        method: 'POST',
        body: JSON.stringify({ memberIds: Array.from(selectedMembers) })
      });
      toastSuccess(`${selectedMembers.size} membre(s) supprimé(s)`);
      closeModal('confirm-modal');
      selectedMembers.clear();
      updateDeleteButton();
      loadData();
    } catch (err) {
      toastError('Erreur: ' + err.message);
    }
  };
  openModal('confirm-modal');
}

function selectAllParticipants() {
  // Get all member checkboxes across all teams
  const allCheckboxes = document.querySelectorAll('.member-row input[type="checkbox"]');
  const allSelected = selectedMembers.size === allCheckboxes.length && allCheckboxes.length > 0;

  // Toggle: if all are selected, deselect all; otherwise select all
  allCheckboxes.forEach(cb => {
    const memberId = parseInt(cb.closest('.member-row').dataset.memberId);
    if (allSelected) {
      cb.checked = false;
      selectedMembers.delete(memberId);
    } else {
      cb.checked = true;
      selectedMembers.add(memberId);
    }
  });

  // Also update the team-level "select all" checkboxes
  document.querySelectorAll('.team-block input[type="checkbox"]').forEach(cb => {
    if (!cb.closest('.member-row')) {
      cb.checked = !allSelected;
    }
  });

  updateDeleteButton();
  updateSelectAllButton();
}

function updateSelectAllButton() {
  const allCheckboxes = document.querySelectorAll('.member-row input[type="checkbox"]');
  const allSelected = selectedMembers.size === allCheckboxes.length && allCheckboxes.length > 0;
  elements.selectAllBtn.textContent = allSelected ? 'Tout désélectionner' : 'Tout sélectionner';
}

// ============================================================
// FORM HANDLERS
// ============================================================

async function handleTeamSubmit(e) {
  e.preventDefault();
  const id = $('team-form-id').value;
  const name = $('team-form-name').value;
  const description = $('team-form-desc').value;
  const password = $('team-form-password').value;

  try {
    if (id) {
      await api(`/admin/teams/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ name, description, password })
      });
      toastSuccess('Équipe mise à jour');
    } else {
      await api('/admin/teams', {
        method: 'POST',
        body: JSON.stringify({ name, description, password })
      });
      toastSuccess('Équipe créée');
    }
    closeModal('team-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

async function handleMemberSubmit(e) {
  e.preventDefault();
  const id = $('member-form-id').value;
  const teamId = parseInt($('member-form-team').value);
  const firstName = $('member-form-firstname').value;
  const lastName = $('member-form-lastname').value;
  const email = $('member-form-email').value;
  const bacLevel = parseInt($('member-form-bac').value);
  const foodDiet = $('member-form-food').value;
  const isLeader = $('member-form-leader').checked;

  try {
    if (id) {
      await api(`/admin/members/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ teamId, firstName, lastName, email, bacLevel, foodDiet, isLeader })
      });
      toastSuccess('Membre mis à jour');
    } else {
      await api('/admin/members', {
        method: 'POST',
        body: JSON.stringify({ teamId, firstName, lastName, email, bacLevel, foodDiet, isLeader })
      });
      toastSuccess('Membre ajouté');
    }
    closeModal('member-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

// ============================================================
// AUTH & DATA LOADING
// ============================================================

async function handleAuth() {
  const token = elements.tokenInput.value.trim();
  if (!token) {
    showAuthError('Token requis');
    return;
  }

  adminToken = token;
  hideAuthError();

  try {
    await loadData();
    localStorage.setItem('ndi_admin_token', token);
    showAdmin();
    initSettings();
    initImport();
    initAllParticipants();
    initArchives();
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuthError('Token invalide');
      adminToken = '';
      localStorage.removeItem('ndi_admin_token');
    } else {
      showAuthError('Erreur: ' + err.message);
    }
  }
}

async function loadData() {
  const { stats, teams } = await api('/admin/stats');
  renderStats(stats);
  renderFoodStats(stats.food_preferences);
  renderTeams(teams);
  renderAllParticipants();
  await loadSettings();
  await loadPizzasConfig();
}

async function loadPizzasConfig() {
  try {
    const response = await fetch('./api/config');
    const { config } = await response.json();
    pizzasConfig = config.pizzas || [];
    updatePizzaSelect();
  } catch (err) {
    console.error('Error loading pizzas config:', err);
  }
}

function updatePizzaSelect() {
  const select = $('member-form-food');
  if (!select) return;

  select.innerHTML = '<option value="">Aucune</option>' +
    pizzasConfig.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('');
}

async function handleExportAll() {
  try {
    const response = await api('/admin/export');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'participants.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
}

async function handleExportOfficial() {
  try {
    const response = await api('/admin/export-official');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'participants_officiel.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastSuccess('Export officiel téléchargé');
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
}

async function handleRefresh() {
  try {
    await loadData();
    toastSuccess('Données actualisées');
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuth();
      showAuthError('Session expirée');
    } else {
      toastError('Erreur: ' + err.message);
    }
  }
}

// ============================================================
// ALL PARTICIPANTS LIST MODULE
// ============================================================

let allParticipantsData = [];
let allParticipantsSearchTerm = '';
let allParticipantsSortKey = 'name';
let allParticipantsSortDir = 'asc';

function renderAllParticipants() {
  const tbody = $('all-participants-tbody');
  if (!tbody) return;

  // Build flat list from teamsData
  allParticipantsData = [];
  teamsData.forEach(team => {
    if (team.members) {
      team.members.forEach(member => {
        allParticipantsData.push({
          ...member,
          team_name: team.name
        });
      });
    }
  });

  let filtered = [...allParticipantsData];

  // Apply search filter
  if (allParticipantsSearchTerm) {
    const term = allParticipantsSearchTerm.toLowerCase();
    filtered = filtered.filter(m =>
      m.first_name.toLowerCase().includes(term) ||
      m.last_name.toLowerCase().includes(term) ||
      m.email.toLowerCase().includes(term) ||
      m.team_name.toLowerCase().includes(term)
    );
  }

  // Apply sorting
  filtered.sort((a, b) => {
    let valA, valB;
    switch (allParticipantsSortKey) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'email':
        valA = a.email.toLowerCase();
        valB = b.email.toLowerCase();
        break;
      case 'team':
        valA = a.team_name.toLowerCase();
        valB = b.team_name.toLowerCase();
        break;
      case 'pizza':
        valA = (a.food_diet || '').toLowerCase();
        valB = (b.food_diet || '').toLowerCase();
        break;
      case 'bac':
        valA = a.bac_level || 0;
        valB = b.bac_level || 0;
        break;
      case 'manager':
        valA = a.is_leader ? 1 : 0;
        valB = b.is_leader ? 1 : 0;
        break;
      default:
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
    }

    if (valA < valB) return allParticipantsSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return allParticipantsSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Aucun participant trouvé</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(m => {
    const teamInfo = formatTeamWithRoom(m.team_name, m.team_room, 40);
    return `
    <tr class="member-row" data-member-id="${m.id}">
      <td><strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong></td>
      <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
      <td class="team-col" title="${escapeHtml(teamInfo.full)}">${escapeHtml(teamInfo.truncated)}</td>
      <td>${escapeHtml(m.food_diet) || '-'}</td>
      <td><span class="badge badge-bac">BAC+${m.bac_level || '?'}</span></td>
      <td>${m.is_leader ? '<span class="badge badge-leader">􀋀 Chef</span>' : '<span class="badge badge-muted">Membre</span>'}</td>
    </tr>
  `;}).join('');
}

window.sortAllParticipants = function(key) {
  if (allParticipantsSortKey === key) {
    allParticipantsSortDir = allParticipantsSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    allParticipantsSortKey = key;
    allParticipantsSortDir = 'asc';
  }

  // Update sort indicators
  document.querySelectorAll('#all-participants-table .sortable-header').forEach(h => {
    const indicator = h.querySelector('.sort-indicator');
    if (h.dataset.sort === allParticipantsSortKey) {
      indicator.textContent = allParticipantsSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      indicator.textContent = '@sfs:arrow.up.arrow.down@';
    }
  });

  renderAllParticipants();
};

function initAllParticipants() {
  const searchInput = $('all-participants-search');
  if (searchInput) {
    searchInput.addEventListener('input', e => {
      allParticipantsSearchTerm = e.target.value;
      renderAllParticipants();
    });
  }
}

// ============================================================
// SETTINGS MODULE
// ============================================================

async function loadSettings() {
  try {
    const data = await adminGet('/admin/settings');
    settingsState.maxTeamSize = parseInt(data.settings.max_team_size, 10) || 15;
    settingsState.maxTotalParticipants = parseInt(data.settings.max_total_participants, 10) || 200;
    settingsState.minTeamSize = parseInt(data.settings.min_team_size, 10) || 1;
    settingsState.schoolName = data.settings.school_name || "Université d'Evry";
    settingsState.pizzas = data.settings.pizzas || [];
    settingsState.bacLevels = data.settings.bac_levels || [];
    settingsState.isDirty = false;

    // Load on-site pricing settings
    pricingSettings.priceAssoMember = parseInt(data.settings.price_asso_member, 10) || 500;
    pricingSettings.priceNonMember = parseInt(data.settings.price_non_member, 10) || 800;
    pricingSettings.priceLate = parseInt(data.settings.price_late, 10) || 1000;
    pricingSettings.lateCutoffTime = data.settings.late_cutoff_time || '19:00';

    // Load online payment settings
    pricingSettings.paymentEnabled = data.settings.payment_enabled === 'true' || data.settings.payment_enabled === true;
    pricingSettings.priceTier1 = parseInt(data.settings.price_tier1, 10) || 500;
    pricingSettings.priceTier2 = parseInt(data.settings.price_tier2, 10) || 700;
    pricingSettings.tier1CutoffDays = parseInt(data.settings.tier1_cutoff_days, 10) || 7;
    pricingSettings.registrationDeadline = data.settings.registration_deadline || '';

    // Load GDPR settings
    settingsState.gdprRetentionYears = parseInt(data.settings.gdpr_retention_years, 10) || 3;

    renderSettings();
  } catch (err) {
    console.error('Error loading settings:', err);
  }
}

function renderSettings() {
  const schoolNameInput = $('setting-school-name');
  if (schoolNameInput) schoolNameInput.value = settingsState.schoolName;

  const maxTeamInput = $('setting-max-team');
  const maxParticipantsInput = $('setting-max-participants');
  const minTeamInput = $('setting-min-team');

  if (maxTeamInput) maxTeamInput.value = settingsState.maxTeamSize;
  if (maxParticipantsInput) maxParticipantsInput.value = settingsState.maxTotalParticipants;
  if (minTeamInput) minTeamInput.value = settingsState.minTeamSize;

  // Render on-site pricing settings (convert cents to euros for display)
  const priceAssoInput = $('setting-price-asso-member');
  const priceNonMemberInput = $('setting-price-non-member');
  const priceLateInput = $('setting-price-late');
  const lateCutoffInput = $('setting-late-cutoff');

  if (priceAssoInput) priceAssoInput.value = (pricingSettings.priceAssoMember / 100).toFixed(2);
  if (priceNonMemberInput) priceNonMemberInput.value = (pricingSettings.priceNonMember / 100).toFixed(2);
  if (priceLateInput) priceLateInput.value = (pricingSettings.priceLate / 100).toFixed(2);
  if (lateCutoffInput) lateCutoffInput.value = pricingSettings.lateCutoffTime;

  // Render online payment settings
  const paymentEnabledInput = $('setting-payment-enabled');
  const priceTier1Input = $('setting-price-tier1');
  const priceTier2Input = $('setting-price-tier2');
  const tier1CutoffDaysInput = $('setting-tier1-cutoff-days');
  const registrationDeadlineInput = $('setting-registration-deadline');

  if (paymentEnabledInput) paymentEnabledInput.checked = pricingSettings.paymentEnabled;
  if (priceTier1Input) priceTier1Input.value = (pricingSettings.priceTier1 / 100).toFixed(2);
  if (priceTier2Input) priceTier2Input.value = (pricingSettings.priceTier2 / 100).toFixed(2);
  if (tier1CutoffDaysInput) tier1CutoffDaysInput.value = pricingSettings.tier1CutoffDays;
  if (registrationDeadlineInput && pricingSettings.registrationDeadline) {
    // Convert ISO string to datetime-local format (YYYY-MM-DDTHH:MM)
    const deadline = new Date(pricingSettings.registrationDeadline);
    if (!isNaN(deadline.getTime())) {
      const localDatetime = deadline.toISOString().slice(0, 16);
      registrationDeadlineInput.value = localDatetime;
    }
  }

  // Render GDPR settings
  const gdprRetentionInput = $('setting-gdpr-retention');
  if (gdprRetentionInput) gdprRetentionInput.value = settingsState.gdprRetentionYears || 3;

  renderPizzasList();
  updateSaveButton();
}

function renderPizzasList() {
  const container = $('pizzas-list');
  if (!container) return;

  if (settingsState.pizzas.length === 0) {
    container.innerHTML = '<p class="text-muted">Aucune pizza configurée</p>';
    return;
  }

  container.innerHTML = settingsState.pizzas.map((pizza, index) => `
    <div class="pizza-item" data-index="${index}">
      <div class="pizza-item-info">
        <span class="pizza-item-id">${escapeHtml(pizza.id)}</span>
        <span class="pizza-item-name">${escapeHtml(pizza.name)}</span>
        <span class="pizza-item-desc">${escapeHtml(pizza.description || '')}</span>
      </div>
      <div class="pizza-item-actions action-buttons">
        <button type="button" class="icon-btn sm edit-pizza-btn" data-index="${index}" title="Modifier" aria-label="Modifier la pizza">􀈊</button>
        <button type="button" class="icon-btn sm danger delete-pizza-btn" data-index="${index}" title="Supprimer" aria-label="Supprimer la pizza">􀈑</button>
      </div>
    </div>
  `).join('');

  container.querySelectorAll('.edit-pizza-btn').forEach(btn => {
    btn.addEventListener('click', () => editPizza(parseInt(btn.dataset.index, 10)));
  });

  container.querySelectorAll('.delete-pizza-btn').forEach(btn => {
    btn.addEventListener('click', () => deletePizza(parseInt(btn.dataset.index, 10)));
  });
}

function initSettings() {
  // All settings inputs that should trigger dirty state
  const settingsInputs = [
    'setting-max-team', 'setting-max-participants', 'setting-min-team', 'setting-school-name',
    'setting-price-asso-member', 'setting-price-non-member', 'setting-price-late', 'setting-late-cutoff',
    // Online payment settings
    'setting-payment-enabled', 'setting-price-tier1', 'setting-price-tier2',
    'setting-tier1-cutoff-days', 'setting-registration-deadline'
  ];

  settingsInputs.forEach(id => {
    const input = $(id);
    if (input) {
      input.addEventListener('change', markDirty);
      input.addEventListener('input', markDirty);
    }
  });

  const saveBtn = $('save-settings-btn');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveSettings);
  }

  const addPizzaForm = $('add-pizza-form-element');
  if (addPizzaForm) {
    addPizzaForm.addEventListener('submit', (e) => {
      e.preventDefault();
      addPizzaFromForm();
    });
  }
}

function markDirty() {
  settingsState.isDirty = true;
  updateSaveButton();
}

function updateSaveButton() {
  const saveBtn = $('save-settings-btn');
  if (saveBtn) {
    saveBtn.disabled = !settingsState.isDirty;
    saveBtn.textContent = settingsState.isDirty ? 'Enregistrer *' : 'Enregistrer';
  }
}

function addPizzaFromForm() {
  const idInput = $('new-pizza-id');
  const nameInput = $('new-pizza-name');
  const descInput = $('new-pizza-desc');

  if (!idInput || !nameInput) return;

  const id = idInput.value.trim().toLowerCase().replace(/\s+/g, '_');
  const name = nameInput.value.trim();
  const description = descInput?.value.trim() || '';

  if (!id || !name) {
    toastError('ID et nom requis');
    return;
  }

  if (settingsState.pizzas.some(p => p.id === id)) {
    toastError('Une pizza avec cet ID existe déjà');
    return;
  }

  settingsState.pizzas.push({ id, name, description });
  markDirty();
  renderPizzasList();

  idInput.value = '';
  nameInput.value = '';
  if (descInput) descInput.value = '';

  toastSuccess('Pizza ajoutée (non sauvegardée)');
}

function editPizza(index) {
  const pizza = settingsState.pizzas[index];
  if (!pizza) return;

  const newName = prompt('Nom de la pizza:', pizza.name);
  if (newName === null) return;

  const newDesc = prompt('Description:', pizza.description || '');
  if (newDesc === null) return;

  settingsState.pizzas[index] = {
    ...pizza,
    name: newName.trim() || pizza.name,
    description: newDesc.trim()
  };

  markDirty();
  renderPizzasList();
}

function deletePizza(index) {
  const pizza = settingsState.pizzas[index];
  if (!pizza) return;

  if (!confirm(`Supprimer la pizza "${pizza.name}" ?`)) return;

  settingsState.pizzas.splice(index, 1);
  markDirty();
  renderPizzasList();
}

async function saveSettings() {
  try {
    const maxTeamSize = parseInt($('setting-max-team')?.value, 10);
    const maxTotalParticipants = parseInt($('setting-max-participants')?.value, 10);
    const minTeamSize = parseInt($('setting-min-team')?.value, 10);
    const schoolName = $('setting-school-name')?.value?.trim() || "Université d'Evry";

    // On-site pricing settings (convert euros to cents)
    const priceAssoMember = Math.round(parseFloat($('setting-price-asso-member')?.value || '5') * 100);
    const priceNonMember = Math.round(parseFloat($('setting-price-non-member')?.value || '8') * 100);
    const priceLate = Math.round(parseFloat($('setting-price-late')?.value || '10') * 100);
    const lateCutoffTime = $('setting-late-cutoff')?.value || '19:00';

    // Online payment settings
    const paymentEnabled = $('setting-payment-enabled')?.checked || false;
    const priceTier1 = Math.round(parseFloat($('setting-price-tier1')?.value || '5') * 100);
    const priceTier2 = Math.round(parseFloat($('setting-price-tier2')?.value || '7') * 100);
    const tier1CutoffDays = parseInt($('setting-tier1-cutoff-days')?.value, 10) || 7;
    const registrationDeadlineValue = $('setting-registration-deadline')?.value || '';
    // Convert datetime-local value to ISO string
    const registrationDeadline = registrationDeadlineValue ? new Date(registrationDeadlineValue).toISOString() : '';

    // GDPR settings
    const gdprRetentionYears = parseInt($('setting-gdpr-retention')?.value, 10) || 3;

    if (isNaN(maxTeamSize) || maxTeamSize < 1 || maxTeamSize > 100) {
      toastError('Taille max d\'équipe invalide (1-100)');
      return;
    }
    if (isNaN(maxTotalParticipants) || maxTotalParticipants < 1 || maxTotalParticipants > 10000) {
      toastError('Participants max invalide (1-10000)');
      return;
    }
    if (isNaN(minTeamSize) || minTeamSize < 1 || minTeamSize > 50) {
      toastError('Taille min d\'équipe invalide (1-50)');
      return;
    }
    if (isNaN(priceAssoMember) || priceAssoMember < 0) {
      toastError('Prix membre asso invalide');
      return;
    }
    if (isNaN(priceNonMember) || priceNonMember < 0) {
      toastError('Prix non-membre invalide');
      return;
    }
    if (isNaN(priceLate) || priceLate < 0) {
      toastError('Prix retardataire invalide');
      return;
    }
    if (isNaN(priceTier1) || priceTier1 < 0) {
      toastError('Prix anticipé invalide');
      return;
    }
    if (isNaN(priceTier2) || priceTier2 < 0) {
      toastError('Prix dernière semaine invalide');
      return;
    }
    if (isNaN(tier1CutoffDays) || tier1CutoffDays < 1 || tier1CutoffDays > 30) {
      toastError('Jours avant deadline invalide (1-30)');
      return;
    }

    const saveBtn = $('save-settings-btn');
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Enregistrement...';
    }

    await adminPut('/admin/settings', {
      max_team_size: maxTeamSize,
      max_total_participants: maxTotalParticipants,
      min_team_size: minTeamSize,
      school_name: schoolName,
      pizzas: settingsState.pizzas,
      price_asso_member: priceAssoMember,
      price_non_member: priceNonMember,
      price_late: priceLate,
      late_cutoff_time: lateCutoffTime,
      // Online payment settings
      payment_enabled: paymentEnabled,
      price_tier1: priceTier1,
      price_tier2: priceTier2,
      tier1_cutoff_days: tier1CutoffDays,
      registration_deadline: registrationDeadline,
      // GDPR settings
      gdpr_retention_years: gdprRetentionYears
    });

    settingsState.isDirty = false;
    settingsState.maxTeamSize = maxTeamSize;
    settingsState.maxTotalParticipants = maxTotalParticipants;
    settingsState.minTeamSize = minTeamSize;
    settingsState.schoolName = schoolName;

    // Update on-site pricing settings
    pricingSettings.priceAssoMember = priceAssoMember;
    pricingSettings.priceNonMember = priceNonMember;
    pricingSettings.priceLate = priceLate;
    pricingSettings.lateCutoffTime = lateCutoffTime;

    // Update online payment settings
    pricingSettings.paymentEnabled = paymentEnabled;
    pricingSettings.priceTier1 = priceTier1;
    pricingSettings.priceTier2 = priceTier2;
    pricingSettings.tier1CutoffDays = tier1CutoffDays;
    pricingSettings.registrationDeadline = registrationDeadline;

    updateSaveButton();
    toastSuccess('Paramètres enregistrés');
  } catch (err) {
    console.error('Error saving settings:', err);
    toastError(err.message || 'Erreur lors de la sauvegarde');
    updateSaveButton();
  }
}

// ============================================================
// IMPORT MODULE
// ============================================================

function initImport() {
  const fileInput = $('import-file');
  const importBtn = $('import-btn');

  if (fileInput) {
    fileInput.addEventListener('change', handleFileSelect);
  }

  if (importBtn) {
    importBtn.addEventListener('click', handleImport);
  }
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) {
    resetImport();
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    csvData = e.target.result;
    parseAndPreview(csvData);
  };
  reader.onerror = () => {
    toastError('Erreur lors de la lecture du fichier');
    resetImport();
  };
  reader.readAsText(file);
}

function parseAndPreview(csv) {
  try {
    const lines = csv.trim().split('\n');
    if (lines.length < 2) {
      throw new Error('Le fichier doit contenir au moins une ligne de données');
    }

    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    parsedRows = [];

    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLine(lines[i]);
      if (values.length === headers.length) {
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx].trim();
        });
        parsedRows.push(row);
      }
    }

    const teams = new Set(parsedRows.map(r => r.teamname || 'Sans équipe'));

    const preview = $('import-preview');
    const previewContent = $('import-preview-content');
    const importBtn = $('import-btn');
    const status = $('import-status');

    if (preview && previewContent) {
      previewContent.innerHTML = `
        <p><strong>${parsedRows.length}</strong> membres dans <strong>${teams.size}</strong> équipes</p>
        <table class="import-preview-table">
          <thead>
            <tr>
              <th>Équipe</th>
              <th>Prénom</th>
              <th>Nom</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody>
            ${parsedRows.slice(0, 5).map(row => `
              <tr>
                <td>${escapeHtml(row.teamname || '-')}</td>
                <td>${escapeHtml(row.firstname || '-')}</td>
                <td>${escapeHtml(row.lastname || '-')}</td>
                <td>${escapeHtml(row.email || '-')}</td>
              </tr>
            `).join('')}
            ${parsedRows.length > 5 ? `<tr><td colspan="4" style="text-align:center;color:var(--color-text-muted)">... et ${parsedRows.length - 5} autres</td></tr>` : ''}
          </tbody>
        </table>
      `;
      preview.classList.remove('hidden');
    }

    if (importBtn) {
      importBtn.disabled = false;
    }

    if (status) {
      status.textContent = '';
      status.className = 'import-status';
    }

  } catch (err) {
    toastError(err.message);
    resetImport();
  }
}

function parseCSVLine(line) {
  const values = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      values.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  values.push(current);

  return values;
}

async function handleImport() {
  if (!csvData) {
    toastError('Veuillez sélectionner un fichier');
    return;
  }

  const importBtn = $('import-btn');
  const status = $('import-status');

  if (importBtn) {
    importBtn.disabled = true;
    importBtn.textContent = 'Import en cours...';
  }

  if (status) {
    status.textContent = 'Import en cours...';
    status.className = 'import-status';
  }

  try {
    const result = await adminPost('/admin/import', { csv: csvData });

    if (result.success) {
      const { stats } = result;
      toastSuccess(`Import terminé: ${stats.membersImported} membres, ${stats.teamsCreated} équipes créées`);

      if (status) {
        status.innerHTML = `<span class="sf-symbol">@sfs:checkmark@</span> ${stats.membersImported} importés, ${stats.membersSkipped} ignorés, ${stats.teamsCreated} équipes créées`;
        status.className = 'import-status success';
      }

      loadData();
    } else {
      throw new Error(result.error || 'Erreur lors de l\'import');
    }

  } catch (err) {
    console.error('Import error:', err);
    toastError(err.message || 'Erreur lors de l\'import');

    if (status) {
      status.innerHTML = `<span class="sf-symbol">@sfs:xmark@</span> Erreur: ${err.message}`;
      status.className = 'import-status error';
    }
  } finally {
    if (importBtn) {
      importBtn.disabled = false;
      importBtn.textContent = 'Importer';
    }
  }
}

function resetImport() {
  csvData = null;
  parsedRows = [];

  const preview = $('import-preview');
  const importBtn = $('import-btn');
  const status = $('import-status');

  if (preview) {
    preview.classList.add('hidden');
  }

  if (importBtn) {
    importBtn.disabled = true;
  }

  if (status) {
    status.textContent = '';
    status.className = 'import-status';
  }
}

// ============================================================
// ARCHIVES MODULE
// ============================================================

let archivesData = [];
let selectedArchive = null;

async function loadArchives() {
  try {
    const response = await api('/admin/archives');
    archivesData = response.archives || [];
    renderArchivesList();
    updateArchivesBadge();
  } catch (err) {
    console.error('Failed to load archives:', err);
    const container = $('archives-container');
    if (container) {
      container.innerHTML = '<div class="no-archives"><p>Erreur lors du chargement des archives</p></div>';
    }
  }
}

function updateArchivesBadge() {
  const badge = $('archives-badge');
  if (badge) {
    badge.textContent = archivesData.length;
    badge.classList.toggle('hidden', archivesData.length === 0);
  }
}

function renderArchivesList() {
  const container = $('archives-container');
  if (!container) return;

  if (archivesData.length === 0) {
    container.innerHTML = `
      <div class="no-archives">
        <p>📁 Aucune archive</p>
        <p>Créez une archive depuis l'onglet Paramètres pour sauvegarder les données d'une édition.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = archivesData.map(archive => `
    <div class="archive-card ${archive.is_expired ? 'expired' : ''}" data-year="${archive.event_year}">
      <div class="archive-card-info">
        <h3 class="archive-card-year">Édition ${archive.event_year}</h3>
        <div class="archive-card-stats">
          <span>👥 ${archive.total_teams} équipes</span>
          <span>🎓 ${archive.total_participants} participants</span>
          ${archive.total_revenue ? `<span>💰 ${(archive.total_revenue / 100).toFixed(2)}€</span>` : ''}
        </div>
        <p class="archive-card-date">Archivé le ${new Date(archive.archived_at).toLocaleDateString('fr-FR')}</p>
      </div>
      <div class="archive-card-actions">
        <button type="button" class="btn btn-secondary btn-sm" onclick="viewArchive(${archive.event_year})">
          👁️ Consulter
        </button>
      </div>
    </div>
  `).join('');
}

async function viewArchive(year) {
  try {
    const response = await api(`/admin/archives/${year}`);
    selectedArchive = response.archive;
    renderArchiveDetail();
    
    // Show the detail section
    const detailSection = $('archive-detail');
    if (detailSection) {
      detailSection.classList.remove('hidden');
      detailSection.scrollIntoView({ behavior: 'smooth' });
    }
  } catch (err) {
    toastError('Erreur lors du chargement de l\'archive');
  }
}

function renderArchiveDetail() {
  if (!selectedArchive) return;

  // Update title
  const title = $('archive-detail-title');
  if (title) {
    title.textContent = `Édition ${selectedArchive.event_year}`;
  }

  // Parse JSON data
  const teams = JSON.parse(selectedArchive.teams_json || '[]');
  const members = JSON.parse(selectedArchive.members_json || '[]');
  const stats = JSON.parse(selectedArchive.stats_json || '{}');

  // Render stats grid
  const statsGrid = $('archive-stats-grid');
  if (statsGrid) {
    statsGrid.innerHTML = `
      <div class="archive-stat-card">
        <div class="archive-stat-value">${selectedArchive.total_teams}</div>
        <div class="archive-stat-label">Équipes</div>
      </div>
      <div class="archive-stat-card">
        <div class="archive-stat-value">${selectedArchive.total_participants}</div>
        <div class="archive-stat-label">Participants</div>
      </div>
      <div class="archive-stat-card">
        <div class="archive-stat-value">${(selectedArchive.total_revenue / 100).toFixed(2)}€</div>
        <div class="archive-stat-label">Revenus</div>
      </div>
      <div class="archive-stat-card">
        <div class="archive-stat-value">${new Date(selectedArchive.archived_at).toLocaleDateString('fr-FR')}</div>
        <div class="archive-stat-label">Date d'archivage</div>
      </div>
    `;
  }

  // Render teams table
  const teamsBody = $('archive-teams-tbody');
  if (teamsBody) {
    teamsBody.innerHTML = teams.map(team => `
      <tr>
        <td>${escapeHtml(team.name)}</td>
        <td>${team.member_count || '-'}</td>
        <td>${escapeHtml(team.room_name) || '-'}</td>
      </tr>
    `).join('');
  }

  // Render members table
  const membersBody = $('archive-members-tbody');
  if (membersBody) {
    membersBody.innerHTML = members.map(member => {
      const team = teams.find(t => t.id === member.team_id);
      return `
        <tr>
          <td>${escapeHtml(member.first_name)} ${escapeHtml(member.last_name)}</td>
          <td>${escapeHtml(member.email) || '<em>anonymisé</em>'}</td>
          <td>${escapeHtml(team?.name) || '-'}</td>
          <td>BAC+${member.bac_level || 0}</td>
        </tr>
      `;
    }).join('');
  }

  // Show GDPR notice if expired
  const gdprNotice = $('archive-gdpr-notice');
  if (gdprNotice) {
    gdprNotice.classList.toggle('hidden', !selectedArchive.is_expired);
  }
}

function closeArchiveDetail() {
  const detailSection = $('archive-detail');
  if (detailSection) {
    detailSection.classList.add('hidden');
  }
  selectedArchive = null;
}

async function exportArchiveJson() {
  if (!selectedArchive) return;
  try {
    const response = await fetch(`${API_BASE}/api/admin/archives/${selectedArchive.event_year}/export?format=json`, {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    const data = await response.json();
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ndi-${selectedArchive.event_year}-archive.json`;
    a.click();
    URL.revokeObjectURL(url);
    toastSuccess('Export JSON téléchargé');
  } catch (err) {
    toastError('Erreur lors de l\'export');
  }
}

async function exportArchiveZip() {
  if (!selectedArchive) return;
  try {
    const response = await fetch(`${API_BASE}/api/admin/archives/${selectedArchive.event_year}/export?format=zip`, {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    const blob = await response.blob();
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ndi-${selectedArchive.event_year}-archive.zip`;
    a.click();
    URL.revokeObjectURL(url);
    toastSuccess('Export ZIP téléchargé');
  } catch (err) {
    toastError('Erreur lors de l\'export');
  }
}

async function createArchive() {
  const yearEl = $('current-event-year');
  const year = yearEl ? yearEl.textContent : new Date().getFullYear();
  
  if (!confirm(`Créer une archive pour l'édition ${year} ?\n\nCette action sauvegardera toutes les données actuelles (équipes, participants, statistiques).`)) {
    return;
  }

  try {
    const response = await api('/admin/archives', {
      method: 'POST',
      body: JSON.stringify({ year: parseInt(year) })
    });
    
    toastSuccess(`Archive ${year} créée avec succès`);
    await loadArchives();
    await loadResetSafetyCheck();
  } catch (err) {
    if (err.message.includes('already exists')) {
      toastError(`Une archive pour ${year} existe déjà`);
    } else if (err.message.includes('No data')) {
      toastError('Aucune donnée à archiver');
    } else {
      toastError('Erreur lors de la création de l\'archive');
    }
  }
}

async function checkExpiration() {
  const resultEl = $('expiration-result');
  try {
    const response = await api('/admin/expiration-check', { method: 'POST' });
    
    if (resultEl) {
      resultEl.classList.remove('hidden');
      if (response.updated > 0) {
        resultEl.className = 'result-text warning';
        resultEl.textContent = `${response.updated} archive(s) ont été anonymisées.`;
        await loadArchives();
      } else {
        resultEl.className = 'result-text success';
        resultEl.textContent = `${response.checked} archive(s) vérifiées. Aucune expiration.`;
      }
    }
  } catch (err) {
    if (resultEl) {
      resultEl.classList.remove('hidden');
      resultEl.className = 'result-text warning';
      resultEl.textContent = 'Erreur lors de la vérification';
    }
  }
}

async function loadResetSafetyCheck() {
  const container = $('reset-safety-check');
  const resetBtn = $('reset-data-btn');
  
  if (!container) return;

  try {
    const response = await api('/admin/reset/check');
    
    if (response.needsArchive) {
      container.className = 'reset-safety-check warning';
      container.innerHTML = `
        <p><strong><span class="sf-symbol">@sfs:exclamationmark.triangle@</span> Données non archivées</strong></p>
        <p>Il y a actuellement ${response.teamsCount} équipes et ${response.membersCount} participants.</p>
        <p>Créez une archive avant de réinitialiser pour ne pas perdre ces données.</p>
      `;
      if (resetBtn) resetBtn.disabled = true;
    } else if (response.hasData) {
      container.className = 'reset-safety-check safe';
      container.innerHTML = `
        <p><strong><span class="sf-symbol">@sfs:checkmark.circle@</span> Prêt à réinitialiser</strong></p>
        <p>Les données ont été archivées. Vous pouvez réinitialiser en toute sécurité.</p>
        <p>Dernière archive : ${response.latestArchiveYear || 'N/A'}</p>
      `;
      if (resetBtn) resetBtn.disabled = false;
    } else {
      container.className = 'reset-safety-check safe';
      container.innerHTML = `
        <p><strong><span class="sf-symbol">@sfs:info.circle@</span> Aucune donnée</strong></p>
        <p>La base de données est vide. Rien à réinitialiser.</p>
      `;
      if (resetBtn) resetBtn.disabled = true;
    }
  } catch (err) {
    container.innerHTML = '<p>Erreur lors de la vérification</p>';
  }
}

async function loadEventInfo() {
  try {
    const response = await api('/admin/event-year');
    const yearEl = $('current-event-year');
    if (yearEl) {
      yearEl.textContent = response.year;
    }
    
    // Also update counts from current data
    const teamsEl = $('current-teams-count');
    const participantsEl = $('current-participants-count');
    if (teamsEl && teamsData) {
      teamsEl.textContent = teamsData.length;
    }
    if (participantsEl && membersData) {
      participantsEl.textContent = membersData.length;
    }
  } catch (err) {
    console.error('Failed to load event info:', err);
  }
}

async function resetData() {
  if (!confirm('⚠️ ATTENTION ⚠️\n\nVous êtes sur le point de SUPPRIMER DÉFINITIVEMENT toutes les données :\n- Toutes les équipes\n- Tous les participants\n- Tous les paiements\n\nCette action est IRRÉVERSIBLE.\n\nÊtes-vous absolument sûr ?')) {
    return;
  }

  // Double confirmation
  const confirmText = prompt('Pour confirmer, tapez "SUPPRIMER" :');
  if (confirmText !== 'SUPPRIMER') {
    toastError('Réinitialisation annulée');
    return;
  }

  try {
    await api('/admin/reset', { method: 'POST' });
    toastSuccess('Données réinitialisées avec succès');
    await loadData();
    await loadResetSafetyCheck();
  } catch (err) {
    if (err.message.includes('archive')) {
      toastError('Créez d\'abord une archive avant de réinitialiser');
    } else {
      toastError('Erreur lors de la réinitialisation');
    }
  }
}

function initArchives() {
  // Refresh button
  const refreshBtn = $('refresh-archives-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadArchives);
  }

  // Close detail button
  const closeBtn = $('close-archive-detail-btn');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeArchiveDetail);
  }

  // Export buttons
  const exportJsonBtn = $('export-archive-json-btn');
  if (exportJsonBtn) {
    exportJsonBtn.addEventListener('click', exportArchiveJson);
  }

  const exportZipBtn = $('export-archive-zip-btn');
  if (exportZipBtn) {
    exportZipBtn.addEventListener('click', exportArchiveZip);
  }

  // Create archive button
  const createBtn = $('create-archive-btn');
  if (createBtn) {
    createBtn.addEventListener('click', createArchive);
  }

  // Check expiration button
  const expirationBtn = $('check-expiration-btn');
  if (expirationBtn) {
    expirationBtn.addEventListener('click', checkExpiration);
  }

  // Reset button
  const resetBtn = $('reset-data-btn');
  if (resetBtn) {
    resetBtn.addEventListener('click', resetData);
  }

  // Load initial data
  loadArchives();
  loadResetSafetyCheck();
  loadEventInfo();
}

// Make viewArchive available globally for onclick
window.viewArchive = viewArchive;

// ============================================================
// TAB NAVIGATION
// ============================================================

let activeTab = 'registrations';

function initTabs() {
  // Sidebar navigation
  document.querySelectorAll('.admin-sidebar-item').forEach(item => {
    item.addEventListener('click', () => switchTab(item.dataset.tab));
  });
  
  // Fallback for horizontal tab nav (if present)
  document.querySelectorAll('.tab-item').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });
}

function switchTab(tabId) {
  activeTab = tabId;

  // Update sidebar items
  document.querySelectorAll('.admin-sidebar-item').forEach(item => {
    const isActive = item.dataset.tab === tabId;
    item.classList.toggle('active', isActive);
  });

  // Update horizontal tab buttons (fallback)
  document.querySelectorAll('.tab-item').forEach(tab => {
    const isActive = tab.dataset.tab === tabId;
    tab.classList.toggle('active', isActive);
    tab.setAttribute('aria-selected', isActive);
  });

  // Update panels
  document.querySelectorAll('.tab-panel').forEach(panel => {
    const isActive = panel.id === `panel-${tabId}`;
    panel.classList.toggle('hidden', !isActive);
  });

  // Load data when switching tabs
  if (tabId === 'attendance') {
    loadAttendanceData();
  } else if (tabId === 'pizza') {
    loadPizzaData();
  } else if (tabId === 'rooms') {
    loadRoomsData();
  }
}

// ============================================================
// ATTENDANCE MANAGEMENT
// ============================================================

let attendanceData = [];
let attendanceSearchTerm = '';
let attendanceFilter = 'all'; // 'all', 'present', 'absent'
let attendanceSortKey = 'name';
let attendanceSortDir = 'asc';

// Pricing settings (loaded from settings, defaults if not set)
let pricingSettings = {
  priceAssoMember: 500,   // cents
  priceNonMember: 800,    // cents
  priceLate: 1000,        // cents
  lateCutoffTime: '19:00' // HH:MM format
};
let checkInMemberId = null;

function formatCurrency(cents) {
  return (cents / 100).toLocaleString('fr-FR', {
    style: 'currency',
    currency: 'EUR'
  });
}

async function loadAttendanceData() {
  try {
    const data = await adminGet('/admin/attendance');
    attendanceData = data.members || [];
    renderAttendanceStats(data.stats);
    renderAttendance();
    updateAttendanceBadge(data.stats.checked_in);
  } catch (err) {
    console.error('Error loading attendance:', err);
    toastError('Erreur lors du chargement des présences');
  }
}

function renderAttendanceStats(stats) {
  const grid = $('attendance-stats-grid');
  if (!grid) return;

  const percentage = stats.total > 0 ? Math.round((stats.checked_in / stats.total) * 100) : 0;
  const payment = stats.payment || {};

  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.checked_in}</div>
      <div class="stat-label">Présents</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.not_checked_in}</div>
      <div class="stat-label">Absents</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total}</div>
      <div class="stat-label">Total inscrits</div>
    </div>
    <div class="stat-card stat-card-highlight">
      <div class="stat-value">${formatCurrency(payment.total_revenue || 0)}</div>
      <div class="stat-label">Recettes</div>
    </div>
  `;

  // Add payment breakdown if there are any payments
  if (payment.total_paid > 0) {
    const breakdownHtml = `
      <div class="stats-grid" style="margin-top: var(--space-4);">
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${payment.asso_members || 0}</div>
          <div class="stat-label">Membres asso</div>
          <div class="stat-sublabel">${formatCurrency(payment.asso_revenue || 0)}</div>
        </div>
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${payment.non_members || 0}</div>
          <div class="stat-label">Non-membres</div>
          <div class="stat-sublabel">${formatCurrency(payment.non_member_revenue || 0)}</div>
        </div>
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${payment.late_arrivals || 0}</div>
          <div class="stat-label">Retardataires</div>
          <div class="stat-sublabel">${formatCurrency(payment.late_revenue || 0)}</div>
        </div>
      </div>
    `;
    grid.insertAdjacentHTML('afterend', breakdownHtml);
  }
}

function renderAttendance() {
  const tbody = $('attendance-tbody');
  if (!tbody) return;

  let filtered = [...attendanceData];

  // Apply search filter
  if (attendanceSearchTerm) {
    const term = attendanceSearchTerm.toLowerCase();
    filtered = filtered.filter(m =>
      m.first_name.toLowerCase().includes(term) ||
      m.last_name.toLowerCase().includes(term) ||
      m.email.toLowerCase().includes(term) ||
      m.team_name.toLowerCase().includes(term)
    );
  }

  // Apply status filter
  if (attendanceFilter === 'present') {
    filtered = filtered.filter(m => m.checked_in === 1);
  } else if (attendanceFilter === 'absent') {
    filtered = filtered.filter(m => m.checked_in === 0 || m.checked_in === null);
  }

  // Apply sorting
  filtered.sort((a, b) => {
    let valA, valB;
    switch (attendanceSortKey) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'email':
        valA = a.email.toLowerCase();
        valB = b.email.toLowerCase();
        break;
      case 'team':
        valA = a.team_name.toLowerCase();
        valB = b.team_name.toLowerCase();
        break;
      case 'status':
        valA = a.checked_in || 0;
        valB = b.checked_in || 0;
        break;
      case 'time':
        valA = a.checked_in_at || '';
        valB = b.checked_in_at || '';
        break;
      case 'payment':
        valA = a.payment_tier || '';
        valB = b.payment_tier || '';
        break;
      default:
        valA = a.first_name.toLowerCase();
        valB = b.first_name.toLowerCase();
    }

    if (valA < valB) return attendanceSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return attendanceSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Aucun participant trouvé</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(m => {
    const isCheckedIn = m.checked_in === 1;
    const checkedInTime = m.checked_in_at ? new Date(m.checked_in_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-';
    const teamInfo = formatTeamWithRoom(m.team_name, m.team_room, 40);

    // Payment badge - check for online payment status first, then on-site payment tier
    let paymentBadge = '<span class="badge badge-muted">-</span>';

    // Online payment status (new columns from payment integration)
    if (m.payment_status === 'paid') {
      // Paid online
      const tierLabels = { 'tier1': 'Anticipé', 'tier2': 'Standard' };
      const tierLabel = tierLabels[m.registration_tier] || 'En ligne';
      const amount = m.payment_amount ? formatCurrency(m.payment_amount) : '';
      paymentBadge = `<span class="badge badge-success"><span class="sf-symbol">@sfs:creditcard@</span> ${tierLabel}</span>`;
      if (amount) {
        paymentBadge += ` <span class="text-muted text-sm">${amount}</span>`;
      }
    } else if (m.payment_status === 'delayed') {
      // Chose to pay on-site
      paymentBadge = '<span class="badge badge-warning"><span class="sf-symbol">@sfs:calendar@</span> À payer</span>';
    } else if (m.payment_status === 'pending') {
      // Payment in progress
      paymentBadge = '<span class="badge badge-info"><span class="sf-symbol">@sfs:hourglass@</span> En cours</span>';
    } else if (m.payment_tier) {
      // On-site payment (existing logic for backward compatibility)
      const tierLabels = {
        'asso_member': '<span class="sf-symbol">@sfs:checkmark@</span> Membre asso',
        'non_member': '<span class="sf-symbol">@sfs:checkmark@</span> Non-membre',
        'late': '<span class="sf-symbol">@sfs:clock@</span> Retardataire'
      };
      const tierLabel = tierLabels[m.payment_tier] || m.payment_tier;
      const amount = m.payment_amount ? formatCurrency(m.payment_amount) : '';
      paymentBadge = `<span class="badge badge-success">${tierLabel}</span>`;
      if (amount) {
        paymentBadge += ` <span class="text-muted text-sm">${amount}</span>`;
      }
    }

    return `
      <tr class="member-row ${isCheckedIn ? 'checked-in' : ''}" data-member-id="${m.id}">
        <td><strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong></td>
        <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
        <td class="team-col" title="${escapeHtml(teamInfo.full)}">${escapeHtml(teamInfo.truncated)}</td>
        <td class="status-col">
          ${isCheckedIn
            ? '<span class="badge badge-success">􀁣 Présent</span>'
            : '<span class="badge badge-muted">􀁡 Absent</span>'}
        </td>
        <td class="time-col">${checkedInTime}</td>
        <td>${paymentBadge}</td>
        <td class="actions-col">
          <div class="action-buttons">
            ${isCheckedIn
              ? `<button type="button" class="icon-btn danger" onclick="handleCheckOut(${m.id})" title="Annuler la présence" aria-label="Annuler la présence">􀁡</button>`
              : `<button type="button" class="icon-btn success" onclick="handleCheckIn(${m.id})" title="Valider la présence" aria-label="Valider la présence">􀁣</button>`}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function updateAttendanceBadge(count) {
  const badge = $('attendance-badge');
  if (badge) badge.textContent = count || 0;
}

window.handleCheckIn = async function(memberId) {
  const member = attendanceData.find(m => m.id === memberId);
  if (!member) return;

  // If member already paid online, skip the payment modal and check in directly
  if (member.payment_status === 'paid') {
    try {
      await adminPost(`/admin/attendance/check-in/${memberId}`, {
        paymentTier: member.registration_tier === 'tier1' ? 'online_tier1' : 'online_tier2',
        paymentAmount: member.payment_amount,
        skipPayment: true  // Indicate payment was already collected online
      });
      await loadAttendanceData();
      toastSuccess(`${member.first_name} ${member.last_name} enregistré(e) (déjà payé en ligne)`);
    } catch (err) {
      console.error('Error checking in:', err);
      toastError(err.message || 'Erreur lors de l\'enregistrement');
    }
    return;
  }

  checkInMemberId = memberId;
  $('checkin-member-id').value = memberId;
  $('checkin-member-name').textContent = `${member.first_name} ${member.last_name}`;

  // Check if after cutoff time
  const now = new Date();
  const [hours, minutes] = pricingSettings.lateCutoffTime.split(':').map(Number);
  const cutoff = new Date();
  cutoff.setHours(hours, minutes, 0, 0);
  const isAfterCutoff = now >= cutoff;

  // Show/hide late option based on cutoff
  const lateOption = $('option-late');
  const nonMemberOption = $('option-non-member');

  if (isAfterCutoff) {
    // After cutoff: show asso + late, hide non-member
    lateOption.classList.remove('hidden');
    nonMemberOption.classList.add('hidden');
  } else {
    // Before cutoff: show asso + non-member, hide late
    lateOption.classList.add('hidden');
    nonMemberOption.classList.remove('hidden');
  }

  // Update prices display
  $('price-asso').textContent = formatCurrency(pricingSettings.priceAssoMember);
  $('price-non-member').textContent = formatCurrency(pricingSettings.priceNonMember);
  $('price-late').textContent = formatCurrency(pricingSettings.priceLate);

  // If member chose delayed payment, show a message and pre-select a tier
  if (member.payment_status === 'delayed') {
    $('checkin-member-name').textContent = `${member.first_name} ${member.last_name} (paiement sur place)`;
  }

  // Reset to asso member option
  document.querySelector('input[name="payment-tier"][value="asso_member"]').checked = true;

  openModal('checkin-modal');
};

window.confirmCheckIn = async function() {
  const tier = document.querySelector('input[name="payment-tier"]:checked').value;
  let amount;

  switch (tier) {
    case 'asso_member':
      amount = pricingSettings.priceAssoMember;
      break;
    case 'non_member':
      amount = pricingSettings.priceNonMember;
      break;
    case 'late':
      amount = pricingSettings.priceLate;
      break;
  }

  try {
    await adminPost(`/admin/attendance/check-in/${checkInMemberId}`, {
      paymentTier: tier,
      paymentAmount: amount
    });
    closeModal('checkin-modal');
    await loadAttendanceData();
    toastSuccess(`Présence validée - ${formatCurrency(amount)}`);
  } catch (err) {
    console.error('Error checking in:', err);
    toastError('Erreur lors de la validation');
  }
};

window.handleCheckOut = async function(memberId) {
  try {
    await adminPost(`/admin/attendance/check-out/${memberId}`);
    await loadAttendanceData();
    toastSuccess('Présence annulée');
  } catch (err) {
    console.error('Error checking out:', err);
    toastError('Erreur lors de l\'annulation');
  }
};

function initAttendance() {
  const searchInput = $('attendance-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      attendanceSearchTerm = e.target.value;
      renderAttendance();
    });
  }

  // Filter pills
  const filterRadios = document.querySelectorAll('input[name="attendance-filter"]');
  filterRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      attendanceFilter = e.target.value;
      updateFilterPills();
      renderAttendance();
    });
  });

  // Sortable headers
  const sortableHeaders = document.querySelectorAll('#attendance-table .sortable-header');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.dataset.sort;
      if (attendanceSortKey === sortKey) {
        attendanceSortDir = attendanceSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        attendanceSortKey = sortKey;
        attendanceSortDir = 'asc';
      }
      updateSortIndicators();
      renderAttendance();
    });
  });

  const refreshBtn = $('refresh-attendance-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadAttendanceData);
  }

  // Initialize filter pills state
  updateFilterPills();
}

function updateFilterPills() {
  const pills = document.querySelectorAll('.filter-pill');
  pills.forEach(pill => {
    const radio = pill.querySelector('input[type="radio"]');
    if (radio?.checked) {
      pill.classList.add('active');
    } else {
      pill.classList.remove('active');
    }
  });
}

function updateSortIndicators() {
  const headers = document.querySelectorAll('#attendance-table .sortable-header');
  headers.forEach(header => {
    const sortKey = header.dataset.sort;
    if (sortKey === attendanceSortKey) {
      header.setAttribute('data-sort-dir', attendanceSortDir);
      header.querySelector('.sort-indicator').textContent = attendanceSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      header.removeAttribute('data-sort-dir');
      header.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });
}

// ============================================================
// PIZZA DISTRIBUTION MANAGEMENT
// ============================================================

let pizzaData = [];
let pizzaSearchTerm = '';
let pizzaFilter = 'all'; // 'all', 'pending', 'received', 'checkedin'
let pizzaTypeFilter = '';
let pizzaSortKey = 'name';
let pizzaSortDir = 'asc';
let pizzaTypes = {}; // { id: name } mapping from settings

async function loadPizzaData() {
  try {
    const data = await adminGet('/admin/pizza');
    pizzaData = data.members || [];
    renderPizzaStats(data.stats);
    renderPizza();
    updatePizzaBadge(data.stats.pending);
  } catch (err) {
    console.error('Error loading pizza data:', err);
    toastError('Erreur lors du chargement des pizzas');
  }
}

function renderPizzaStats(stats) {
  // All members stats
  const grid = $('pizza-stats-grid');
  if (!grid) return;

  const percentage = stats.total > 0 ? Math.round((stats.received / stats.total) * 100) : 0;

  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.received}</div>
      <div class="stat-label">Servis</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.pending}</div>
      <div class="stat-label">En attente</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total}</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${percentage}%</div>
      <div class="stat-label">Progression</div>
    </div>
  `;

  // By type stats (all members)
  const typeGrid = $('pizza-by-type-grid');
  if (typeGrid && stats.by_type && stats.by_type.length > 0) {
    typeGrid.innerHTML = stats.by_type.map(t => {
      const toServe = t.total - t.received;
      return `
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${t.total}</div>
          <div class="stat-label">${pizzaTypes[t.food_diet] || t.food_diet}</div>
          <div class="stat-sublabel">${t.received} servis${toServe > 0 ? `, ${toServe} restants` : ''}</div>
        </div>
      `;
    }).join('');
  }

  // Present members stats
  const presentGrid = $('pizza-present-stats-grid');
  if (presentGrid && stats.present) {
    const present = stats.present;
    const presentPercentage = present.total > 0 ? Math.round((present.received / present.total) * 100) : 0;

    presentGrid.innerHTML = `
      <div class="stat-card">
        <div class="stat-value">${present.received}</div>
        <div class="stat-label">Servis</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${present.pending}</div>
        <div class="stat-label">À servir</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${present.total}</div>
        <div class="stat-label">Présents</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${presentPercentage}%</div>
        <div class="stat-label">Progression</div>
      </div>
    `;
  }

  // By type stats (present members only) - show total present and how many still need pizza
  const presentTypeGrid = $('pizza-present-by-type-grid');
  if (presentTypeGrid && stats.present?.by_type && stats.present.by_type.length > 0) {
    presentTypeGrid.innerHTML = stats.present.by_type.map(t => {
      const toServe = t.total - t.received;
      return `
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${t.total}</div>
          <div class="stat-label">${pizzaTypes[t.food_diet] || t.food_diet}</div>
          <div class="stat-sublabel">${toServe > 0 ? `${toServe} à servir` : 'Tous servis'}</div>
        </div>
      `;
    }).join('');
  }
}

function renderPizza() {
  const tbody = $('pizza-tbody');
  if (!tbody) return;

  let filtered = [...pizzaData];

  // Apply search filter
  if (pizzaSearchTerm) {
    const term = pizzaSearchTerm.toLowerCase();
    filtered = filtered.filter(m =>
      m.first_name.toLowerCase().includes(term) ||
      m.last_name.toLowerCase().includes(term) ||
      m.email.toLowerCase().includes(term) ||
      (m.team_name || '').toLowerCase().includes(term)
    );
  }

  // Apply status filter
  if (pizzaFilter === 'pending') {
    filtered = filtered.filter(m => m.pizza_received === 0 || m.pizza_received === null);
  } else if (pizzaFilter === 'received') {
    filtered = filtered.filter(m => m.pizza_received === 1);
  } else if (pizzaFilter === 'checkedin') {
    filtered = filtered.filter(m => m.checked_in === 1);
  }

  // Apply pizza type filter
  if (pizzaTypeFilter) {
    filtered = filtered.filter(m => m.food_diet === pizzaTypeFilter);
  }

  // Apply sorting
  filtered.sort((a, b) => {
    let valA, valB;
    switch (pizzaSortKey) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'team':
        valA = (a.team_name || '').toLowerCase();
        valB = (b.team_name || '').toLowerCase();
        break;
      case 'pizza':
        valA = a.food_diet || '';
        valB = b.food_diet || '';
        break;
      case 'checkin':
        valA = a.checked_in || 0;
        valB = b.checked_in || 0;
        break;
      case 'status':
        valA = a.pizza_received || 0;
        valB = b.pizza_received || 0;
        break;
      case 'time':
        valA = a.pizza_received_at || '';
        valB = b.pizza_received_at || '';
        break;
      default:
        valA = a.first_name.toLowerCase();
        valB = b.first_name.toLowerCase();
    }

    if (valA < valB) return pizzaSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return pizzaSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Aucun participant trouvé</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(m => {
    const isPizzaReceived = m.pizza_received === 1;
    const isCheckedIn = m.checked_in === 1;
    const pizzaTime = m.pizza_received_at ? new Date(m.pizza_received_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-';
    const teamInfo = formatTeamWithRoom(m.team_name, m.team_room, 40);

    return `
      <tr class="member-row ${isPizzaReceived ? 'checked-in' : ''}" data-member-id="${m.id}">
        <td><strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong></td>
        <td class="team-col" title="${escapeHtml(teamInfo.full)}">${escapeHtml(teamInfo.truncated)}</td>
        <td>${pizzaTypes[m.food_diet] || escapeHtml(m.food_diet) || '-'}</td>
        <td class="status-col">
          ${isCheckedIn
            ? '<span class="badge badge-success">Présent</span>'
            : '<span class="badge badge-muted">Absent</span>'}
        </td>
        <td class="status-col">
          ${isPizzaReceived
            ? '<span class="badge badge-success">􀁣 Servi</span>'
            : '<span class="badge badge-muted">􀁡 En attente</span>'}
        </td>
        <td class="time-col">${pizzaTime}</td>
        <td class="actions-col">
          <div class="action-buttons">
            ${isPizzaReceived
              ? `<button type="button" class="icon-btn danger" onclick="handleRevokePizza(${m.id})" title="Annuler" aria-label="Annuler la distribution">􀁡</button>`
              : `<button type="button" class="icon-btn success" onclick="handleGivePizza(${m.id})" title="Donner pizza" aria-label="Donner pizza">􀁣</button>`}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function updatePizzaBadge(pending) {
  const badge = $('pizza-badge');
  if (badge) badge.textContent = pending || 0;
}

window.handleGivePizza = async function(memberId) {
  try {
    await adminPost(`/admin/pizza/give/${memberId}`);
    await loadPizzaData();
    toastSuccess('Pizza distribuée');
  } catch (err) {
    console.error('Error giving pizza:', err);
    toastError('Erreur lors de la distribution');
  }
};

window.handleRevokePizza = async function(memberId) {
  try {
    await adminPost(`/admin/pizza/revoke/${memberId}`);
    await loadPizzaData();
    toastSuccess('Distribution annulée');
  } catch (err) {
    console.error('Error revoking pizza:', err);
    toastError('Erreur lors de l\'annulation');
  }
};

function initPizza() {
  // Load pizza types from settings
  if (settingsState.pizzas) {
    settingsState.pizzas.forEach(p => { pizzaTypes[p.id] = p.name; });
  }

  // Also try from pizzasConfig
  if (pizzasConfig && pizzasConfig.length > 0) {
    pizzasConfig.forEach(p => { pizzaTypes[p.id] = p.name; });
  }

  // Populate type filter
  const typeFilter = $('pizza-type-filter');
  if (typeFilter) {
    const pizzaList = settingsState.pizzas || pizzasConfig || [];
    typeFilter.innerHTML = '<option value="">Toutes les pizzas</option>' +
      pizzaList.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('');
  }

  // Search
  const searchInput = $('pizza-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      pizzaSearchTerm = e.target.value;
      renderPizza();
    });
  }

  // Filter pills
  const filterRadios = document.querySelectorAll('input[name="pizza-filter"]');
  filterRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      pizzaFilter = e.target.value;
      updatePizzaFilterPills();
      renderPizza();
    });
  });

  // Type filter
  const typeFilterSelect = $('pizza-type-filter');
  if (typeFilterSelect) {
    typeFilterSelect.addEventListener('change', (e) => {
      pizzaTypeFilter = e.target.value;
      renderPizza();
    });
  }

  // Sortable headers
  const sortableHeaders = document.querySelectorAll('#pizza-table .sortable-header');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.dataset.sort;
      if (pizzaSortKey === sortKey) {
        pizzaSortDir = pizzaSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        pizzaSortKey = sortKey;
        pizzaSortDir = 'asc';
      }
      updatePizzaSortIndicators();
      renderPizza();
    });
  });

  // Refresh button
  const refreshBtn = $('refresh-pizza-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadPizzaData);
  }

  // Initialize filter pills state
  updatePizzaFilterPills();
}

function updatePizzaFilterPills() {
  document.querySelectorAll('[id^="pizza-filter-"]').forEach(pill => {
    const radio = pill.querySelector('input[type="radio"]');
    if (radio?.checked) {
      pill.classList.add('active');
    } else {
      pill.classList.remove('active');
    }
  });
}

function updatePizzaSortIndicators() {
  const headers = document.querySelectorAll('#pizza-table .sortable-header');
  headers.forEach(header => {
    const sortKey = header.dataset.sort;
    if (sortKey === pizzaSortKey) {
      header.setAttribute('data-sort-dir', pizzaSortDir);
      header.querySelector('.sort-indicator').textContent = pizzaSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      header.removeAttribute('data-sort-dir');
      header.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });
}

// ============================================================
// ROOM MANAGEMENT
// ============================================================

let roomsData = [];
let roomsSearchTerm = '';
let roomsFilter = 'all';
let roomsSortKey = 'name';
let roomsSortDir = 'asc';
let availableRooms = [];

async function loadRoomsData() {
  try {
    const data = await adminGet('/admin/rooms');
    roomsData = data.teams || [];
    availableRooms = data.rooms || [];
    renderRoomsStats(data.stats);
    renderPizzaByRoom(data.pizza_by_room || []);
    renderRooms();
    updateRoomsBadge(data.stats?.unassigned_teams || 0);
  } catch (err) {
    console.error('Error loading rooms data:', err);
    toastError('Erreur lors du chargement des salles');
  }
}

function renderPizzaByRoom(pizzaByRoom) {
  const container = $('room-pizza-container');
  if (!container) return;

  if (!pizzaByRoom || pizzaByRoom.length === 0) {
    container.innerHTML = '<p class="text-muted">Aucune salle avec des équipes assignées</p>';
    return;
  }

  container.innerHTML = pizzaByRoom.map(room => `
    <div class="room-pizza-block" style="margin-bottom: var(--space-4); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md);">
      <h4 style="margin-bottom: var(--space-3); display: flex; align-items: center; gap: var(--space-2);">
        <span>${escapeHtml(room.room)}</span>
        <span class="badge badge-muted">${room.totals.total} inscrits</span>
        <span class="badge badge-success">${room.totals.present} présents</span>
      </h4>
      <div class="stats-grid">
        ${room.pizzas.map(p => `
          <div class="stat-card stat-card-sm">
            <div class="stat-value">${p.total}</div>
            <div class="stat-label">${pizzaTypes[p.food_diet] || p.food_diet}</div>
            <div class="stat-sublabel">${p.present} présents</div>
          </div>
        `).join('')}
        <div class="stat-card stat-card-sm" style="background: var(--bg-tertiary);">
          <div class="stat-value">${room.totals.total}</div>
          <div class="stat-label">Total</div>
          <div class="stat-sublabel">${room.totals.present} présents</div>
        </div>
      </div>
    </div>
  `).join('');
}

function renderRoomsStats(stats) {
  const grid = $('room-stats-grid');
  if (!grid) return;

  const assigned = stats?.assigned_teams || 0;
  const unassigned = stats?.unassigned_teams || 0;
  const total = stats?.total_teams || 0;
  const percent = total > 0 ? Math.round((assigned / total) * 100) : 0;

  grid.innerHTML = `
    <div class="stat-card">
      <span class="stat-value">${assigned}</span>
      <span class="stat-label">Équipes assignées</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${unassigned}</span>
      <span class="stat-label">Non assignées</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${total}</span>
      <span class="stat-label">Total équipes</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${percent}%</span>
      <span class="stat-label">Progression</span>
    </div>
  `;

  // By room stats
  const byRoomGrid = $('room-by-room-grid');
  if (byRoomGrid && stats?.by_room?.length > 0) {
    byRoomGrid.innerHTML = stats.by_room.map(r => `
      <div class="stat-card stat-card-sm">
        <span class="stat-value">${r.team_count}</span>
        <span class="stat-label">${escapeHtml(r.room)}</span>
        <span class="stat-sublabel">${r.member_count} membres</span>
      </div>
    `).join('');
  } else if (byRoomGrid) {
    byRoomGrid.innerHTML = '';
  }
}

function renderRooms() {
  const tbody = $('rooms-tbody');
  if (!tbody) return;

  let filtered = [...roomsData];

  // Search filter
  if (roomsSearchTerm) {
    filtered = filtered.filter(t =>
      t.name.toLowerCase().includes(roomsSearchTerm) ||
      (t.room || '').toLowerCase().includes(roomsSearchTerm)
    );
  }

  // Status filter
  if (roomsFilter === 'assigned') {
    filtered = filtered.filter(t => t.room && t.room !== '');
  } else if (roomsFilter === 'unassigned') {
    filtered = filtered.filter(t => !t.room || t.room === '');
  }

  // Sort
  filtered.sort((a, b) => {
    let valA, valB;
    switch (roomsSortKey) {
      case 'name':
        valA = a.name.toLowerCase();
        valB = b.name.toLowerCase();
        break;
      case 'members':
        valA = a.member_count || 0;
        valB = b.member_count || 0;
        break;
      case 'room':
        valA = (a.room || '').toLowerCase();
        valB = (b.room || '').toLowerCase();
        break;
      default:
        valA = a.name.toLowerCase();
        valB = b.name.toLowerCase();
    }

    if (valA < valB) return roomsSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return roomsSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Aucune équipe trouvée</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(t => {
    const hasRoom = t.room && t.room !== '';
    const roomOptions = availableRooms
      .filter(r => r !== t.room)
      .map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`)
      .join('');

    return `
      <tr class="member-row ${hasRoom ? 'checked-in' : ''}" data-team-id="${t.id}">
        <td class="team-col" title="${escapeHtml(t.name)}">${escapeHtml(truncateText(t.name, 40))}</td>
        <td>${t.member_count || 0}</td>
        <td>
          <div class="room-input-wrapper">
            <input type="text"
                   class="room-input"
                   value="${escapeHtml(t.room || '')}"
                   placeholder="Salle..."
                   list="room-datalist-${t.id}"
                   data-team-id="${t.id}"
                   onchange="handleRoomChange(${t.id}, this.value)"
                   style="width: 120px; padding: 4px 8px; font-size: var(--text-sm); border: 1px solid var(--border-default); border-radius: var(--radius);">
            <datalist id="room-datalist-${t.id}">
              ${roomOptions}
            </datalist>
          </div>
        </td>
        <td class="actions-col">
          <div class="action-buttons">
            ${hasRoom
              ? `<button type="button" class="icon-btn danger" onclick="handleClearRoom(${t.id})" title="Retirer de la salle" aria-label="Retirer de la salle"><span class="sf-symbol">@sfs:xmark@</span></button>`
              : ''}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

window.handleRoomChange = async function(teamId, room) {
  try {
    await adminPut(`/admin/rooms/${teamId}`, { room: room || null });
    await loadRoomsData();
    toastSuccess(room ? `Équipe assignée à ${room}` : 'Salle retirée');
  } catch (err) {
    console.error('Error setting room:', err);
    toastError('Erreur lors de l\'assignation');
  }
};

window.handleClearRoom = async function(teamId) {
  try {
    await adminPut(`/admin/rooms/${teamId}`, { room: null });
    await loadRoomsData();
    toastSuccess('Salle retirée');
  } catch (err) {
    console.error('Error clearing room:', err);
    toastError('Erreur lors de la suppression');
  }
};

function updateRoomsBadge(unassigned) {
  const badge = $('rooms-badge');
  if (badge) badge.textContent = unassigned || 0;
}

function initRooms() {
  // Search
  const searchInput = $('rooms-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      roomsSearchTerm = e.target.value.toLowerCase();
      renderRooms();
    });
  }

  // Filter pills
  document.querySelectorAll('input[name="rooms-filter"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      roomsFilter = e.target.value;
      updateRoomsFilterPills();
      renderRooms();
    });
  });

  // Sortable headers
  const sortableHeaders = document.querySelectorAll('#rooms-table .sortable-header');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.dataset.sort;
      if (roomsSortKey === sortKey) {
        roomsSortDir = roomsSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        roomsSortKey = sortKey;
        roomsSortDir = 'asc';
      }
      updateRoomsSortIndicators();
      renderRooms();
    });
  });

  // Refresh button
  const refreshBtn = $('refresh-rooms-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadRoomsData);
  }

  updateRoomsFilterPills();
}

function updateRoomsFilterPills() {
  document.querySelectorAll('[id^="rooms-filter-"]').forEach(pill => {
    const radio = pill.querySelector('input[type="radio"]');
    if (radio?.checked) {
      pill.classList.add('active');
    } else {
      pill.classList.remove('active');
    }
  });
}

function updateRoomsSortIndicators() {
  const headers = document.querySelectorAll('#rooms-table .sortable-header');
  headers.forEach(header => {
    const sortKey = header.dataset.sort;
    if (sortKey === roomsSortKey) {
      header.setAttribute('data-sort-dir', roomsSortDir);
      header.querySelector('.sort-indicator').textContent = roomsSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      header.removeAttribute('data-sort-dir');
      header.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });
}

// ============================================================
// TEAMS SEARCH
// ============================================================

let teamsSearchTerm = '';

function initTeamsSearch() {
  const searchInput = $('teams-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      teamsSearchTerm = e.target.value.toLowerCase();
      filterTeams();
    });
  }
}

function filterTeams() {
  const container = $('teams-container');
  if (!container) return;

  const teamBlocks = container.querySelectorAll('.team-block');

  teamBlocks.forEach(block => {
    const teamName = block.querySelector('.team-header h3')?.textContent.toLowerCase() || '';
    const memberNames = Array.from(block.querySelectorAll('.member-row td:nth-child(2)')).map(td => td.textContent.toLowerCase());
    const memberEmails = Array.from(block.querySelectorAll('.member-row td:nth-child(3)')).map(td => td.textContent.toLowerCase());

    const matchesTeam = teamName.includes(teamsSearchTerm);
    const matchesMember = memberNames.some(name => name.includes(teamsSearchTerm)) ||
                          memberEmails.some(email => email.includes(teamsSearchTerm));

    if (teamsSearchTerm === '' || matchesTeam || matchesMember) {
      block.style.display = '';
      // If search matches a member, expand the team
      if (matchesMember && teamsSearchTerm !== '') {
        block.classList.add('open');
      }
    } else {
      block.style.display = 'none';
    }
  });
}

// ============================================================
// INITIALIZE
// ============================================================

async function init() {
  elements.authBtn.addEventListener('click', handleAuth);
  elements.tokenInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleAuth();
  });
  elements.exportOfficialBtn.addEventListener('click', handleExportOfficial);
  elements.exportAllBtn.addEventListener('click', handleExportAll);
  elements.refreshBtn.addEventListener('click', handleRefresh);
  elements.addTeamBtn.addEventListener('click', openAddTeamModal);
  elements.addMemberBtn.addEventListener('click', openAddMemberModal);
  elements.selectAllBtn.addEventListener('click', selectAllParticipants);
  elements.deleteSelectedBtn.addEventListener('click', deleteSelectedMembers);
  elements.teamForm.addEventListener('submit', handleTeamSubmit);
  elements.memberForm.addEventListener('submit', handleMemberSubmit);

  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  });

  // Initialize tabs and search
  initTabs();
  initTeamsSearch();
  initAttendance();
  initPizza();
  initRooms();

  if (adminToken) {
    try {
      await loadData();
      showAdmin();
      initSettings();
      initImport();
      initAllParticipants();
      initArchives();
    } catch (err) {
      showAuth();
      if (err.message === 'Unauthorized') {
        localStorage.removeItem('ndi_admin_token');
        adminToken = '';
      }
    }
  } else {
    showAuth();
  }
}

window.loadData = loadData;

init();
</script>
</AdminLayout>
