---
import AdminLayout from '../layouts/AdminLayout.astro';
---

<AdminLayout title="NDI Admin - Gestion des √©quipes - Asso Info Evry">
  <!-- Admin Hero Header -->
  <section class="page-hero">
    <div class="page-hero-bg">
      <div class="orb orb-blue"></div>
      <div class="orb orb-indigo"></div>
    </div>
    <div class="page-hero-content container">
      <h1 class="page-hero-title">
        <span>Administration</span>
        <span class="gradient-text">NDI</span>
      </h1>
      <p class="page-hero-subtitle">Gestion des √©quipes et participants</p>
    </div>
  </section>

  <main class="container-wide admin">
    <section id="auth-section" class="section glass-card">
      <h2>Authentification</h2>
      <div class="form-group">
        <label for="admin-token">Token d'administration</label>
        <input type="password" id="admin-token" placeholder="Entrez votre token...">
      </div>
      <button type="button" id="auth-btn" class="btn btn-primary">Connexion</button>
      <p id="auth-error" class="error-text hidden"></p>
    </section>

    <div id="admin-content" class="hidden">
      <!-- Tab Navigation -->
      <nav class="tab-nav" role="tablist">
        <button type="button" role="tab" id="tab-registrations" aria-controls="panel-registrations" aria-selected="true" class="tab-item active" data-tab="registrations">
          <span class="tab-icon sf-symbol">@sfs:list.bullet@</span>
          <span class="tab-label">Inscriptions</span>
        </button>
        <button type="button" role="tab" id="tab-attendance" aria-controls="panel-attendance" aria-selected="false" class="tab-item" data-tab="attendance">
          <span class="tab-icon sf-symbol">@sfs:person.badge.clock@</span>
          <span class="tab-label">Pr√©sences</span>
          <span id="attendance-badge" class="tab-badge">0</span>
        </button>
        <button type="button" role="tab" id="tab-pizza" aria-controls="panel-pizza" aria-selected="false" class="tab-item" data-tab="pizza">
          <span class="tab-icon sf-symbol">@sfs:fork.knife@</span>
          <span class="tab-label">Pizzas</span>
          <span id="pizza-badge" class="tab-badge">0</span>
        </button>
        <button type="button" role="tab" id="tab-rooms" aria-controls="panel-rooms" aria-selected="false" class="tab-item" data-tab="rooms">
          <span class="tab-icon sf-symbol">@sfs:building.2@</span>
          <span class="tab-label">Salles</span>
          <span id="rooms-badge" class="tab-badge">0</span>
        </button>
        <button type="button" role="tab" id="tab-archives" aria-controls="panel-archives" aria-selected="false" class="tab-item" data-tab="archives">
          <span class="tab-icon sf-symbol">@sfs:archivebox@</span>
          <span class="tab-label">Archives</span>
          <span id="archives-badge" class="tab-badge hidden">0</span>
        </button>
        <button type="button" role="tab" id="tab-settings" aria-controls="panel-settings" aria-selected="false" class="tab-item" data-tab="settings">
          <span class="tab-icon sf-symbol">@sfs:gear@</span>
          <span class="tab-label">Param√®tres</span>
        </button>
      </nav>

      <!-- Registrations Panel -->
      <div id="panel-registrations" class="tab-panel" role="tabpanel" aria-labelledby="tab-registrations">

      <!-- Stats Section -->
      <div class="disclosure-group open" data-disclosure="stats">
        <div class="disclosure-header" onclick="toggleDisclosure('stats')">
          <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Vue d'ensemble</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <button type="button" id="export-official-btn" class="btn btn-primary btn-sm">Export Officiel</button>
            <button type="button" id="export-all-btn" class="btn btn-secondary btn-sm">Exporter CSV</button>
            <button type="button" id="refresh-btn" class="btn btn-secondary btn-sm">Rafra√Æchir</button>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="stats-grid" class="stats-grid"></div>
        </div>
      </div>

      <!-- Food Stats -->
      <div class="disclosure-group open" data-disclosure="food">
        <div class="disclosure-header" onclick="toggleDisclosure('food')">
          <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Pr√©f√©rences alimentaires</h2>
        </div>
        <div class="disclosure-body">
          <div id="food-stats" class="food-stats"></div>
        </div>
      </div>

      <!-- Import Section -->
      <div class="disclosure-group" data-disclosure="import">
        <div class="disclosure-header" onclick="toggleDisclosure('import')">
          <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Importer des donn√©es</h2>
        </div>
        <div class="disclosure-body">
          <div class="settings-card">
            <h3>Import CSV</h3>
            <p class="import-description">
              Importez des membres depuis un fichier CSV. Les √©quipes seront cr√©√©es automatiquement avec le nom de l'√©quipe comme mot de passe.
            </p>
            <div class="import-format">
              <strong>Format attendu :</strong>
              <code>id,firstname,lastname,email,fooddiet,baclevel,ismanager,teamName,date</code>
            </div>
            <div class="form-group">
              <label for="import-file">Fichier CSV</label>
              <input type="file" id="import-file" accept=".csv,text/csv">
            </div>
            <div id="import-preview" class="import-preview hidden">
              <h4>Aper√ßu</h4>
              <div id="import-preview-content"></div>
            </div>
            <div class="import-actions">
              <button type="button" id="import-btn" class="btn btn-primary" disabled>Importer</button>
              <span id="import-status" class="import-status"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="disclosure-group open" data-disclosure="actions">
        <div class="disclosure-header" onclick="toggleDisclosure('actions')">
          <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Actions rapides</h2>
        </div>
        <div class="disclosure-body">
          <div class="quick-actions">
            <button type="button" id="add-team-btn" class="btn btn-primary">ÙÄÅç Nouvelle √©quipe</button>
            <button type="button" id="add-member-btn" class="btn btn-primary">ÙÄÅç Nouveau membre</button>
            <button type="button" id="select-all-btn" class="btn btn-secondary">Tout s√©lectionner</button>
            <button type="button" id="delete-selected-btn" class="btn btn-danger" disabled>ÙÄàë Supprimer s√©lection</button>
          </div>
        </div>
      </div>

      <!-- Teams Section -->
      <div class="disclosure-group open" data-disclosure="teams">
        <div class="disclosure-header" onclick="toggleDisclosure('teams')">
          <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> √âquipes et membres</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <div class="search-input-wrapper">
              <span class="search-icon sf-symbol" aria-hidden="true">@sfs:magnifyingglass@</span>
              <input type="search" id="teams-search" class="search-input" placeholder="Rechercher...">
            </div>
          </div>
        </div>
        <div class="disclosure-body">
          <div id="teams-container"></div>
        </div>
      </div>

      <!-- All Participants List Section -->
      <div class="disclosure-group" data-disclosure="all-participants">
        <div class="disclosure-header" onclick="toggleDisclosure('all-participants')">
          <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Tous les participants</h2>
          <div class="header-actions" onclick="event.stopPropagation()">
            <div class="search-input-wrapper">
              <span class="search-icon sf-symbol" aria-hidden="true">@sfs:magnifyingglass@</span>
              <input type="search" id="all-participants-search" class="search-input" placeholder="Rechercher un participant...">
            </div>
          </div>
        </div>
        <div class="disclosure-body">
          <div class="table-container">
            <table id="all-participants-table" class="members-table">
              <thead>
                <tr>
                  <th class="sortable-header" data-sort="name" onclick="sortAllParticipants('name')">Nom <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                  <th class="sortable-header" data-sort="email" onclick="sortAllParticipants('email')">Email <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                  <th class="sortable-header team-col" data-sort="team" onclick="sortAllParticipants('team')">√âquipe <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                  <th class="sortable-header" data-sort="pizza" onclick="sortAllParticipants('pizza')">Pizza <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                  <th class="sortable-header" data-sort="bac" onclick="sortAllParticipants('bac')">BAC <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                  <th class="sortable-header" data-sort="manager" onclick="sortAllParticipants('manager')">R√¥le <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                </tr>
              </thead>
              <tbody id="all-participants-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      </div><!-- End Registrations Panel -->

      <!-- Attendance Panel -->
      <div id="panel-attendance" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-attendance">
        <!-- Attendance Stats -->
        <div class="disclosure-group open" data-disclosure="attendance-stats">
          <div class="disclosure-header" onclick="toggleDisclosure('attendance-stats')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Statistiques de pr√©sence</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <button type="button" id="refresh-attendance-btn" class="btn btn-secondary btn-sm">Rafra√Æchir</button>
            </div>
          </div>
          <div class="disclosure-body">
            <div id="attendance-stats-grid" class="stats-grid"></div>
          </div>
        </div>

        <!-- Attendance List -->
        <div class="disclosure-group open" data-disclosure="attendance-list">
          <div class="disclosure-header" onclick="toggleDisclosure('attendance-list')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Liste des participants</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <div class="search-input-wrapper">
                <span class="search-icon sf-symbol" aria-hidden="true">@sfs:magnifyingglass@</span>
                <input type="search" id="attendance-search" class="search-input" placeholder="Rechercher un participant...">
              </div>
            </div>
          </div>
          <div class="disclosure-body">
            <div class="attendance-filters">
              <label class="filter-pill" id="filter-all-pill">
                <input type="radio" name="attendance-filter" value="all" checked> ÙÄã≤ Tous
              </label>
              <label class="filter-pill" id="filter-present-pill">
                <input type="radio" name="attendance-filter" value="present"> ÙÄÅ£ Pr√©sents
              </label>
              <label class="filter-pill" id="filter-absent-pill">
                <input type="radio" name="attendance-filter" value="absent"> ÙÄÅ° Absents
              </label>
            </div>
            <div class="table-container">
              <table id="attendance-table" class="members-table attendance-table">
                <thead>
                  <tr>
                    <th class="sortable-header" data-sort="name">Nom <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header" data-sort="email">Email <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header team-col" data-sort="team">√âquipe <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header status-col" data-sort="status">Statut <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header time-col" data-sort="time">Heure <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header" data-sort="payment">Paiement <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="actions-col">Actions</th>
                  </tr>
                </thead>
                <tbody id="attendance-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div><!-- End Attendance Panel -->

      <!-- Pizza Distribution Panel -->
      <div id="panel-pizza" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-pizza">
        <!-- Pizza Stats -->
        <div class="disclosure-group open" data-disclosure="pizza-stats">
          <div class="disclosure-header" onclick="toggleDisclosure('pizza-stats')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Distribution des pizzas</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <button type="button" id="refresh-pizza-btn" class="btn btn-secondary btn-sm">Rafra√Æchir</button>
            </div>
          </div>
          <div class="disclosure-body">
            <h3 style="margin-bottom: var(--space-3); font-size: var(--text-sm); color: var(--text-muted);"><span class="sf-symbol">@sfs:list.bullet@</span> Tous les inscrits</h3>
            <div id="pizza-stats-grid" class="stats-grid"></div>
            <div id="pizza-by-type-grid" class="stats-grid" style="margin-top: var(--space-4);"></div>
            <h3 style="margin-top: var(--space-6); margin-bottom: var(--space-3); font-size: var(--text-sm); color: var(--text-muted);"><span class="sf-symbol">@sfs:checkmark.circle@</span> Pr√©sents uniquement (pizzas r√©ellement n√©cessaires)</h3>
            <div id="pizza-present-stats-grid" class="stats-grid"></div>
            <div id="pizza-present-by-type-grid" class="stats-grid" style="margin-top: var(--space-4);"></div>
          </div>
        </div>

        <!-- Pizza List -->
        <div class="disclosure-group open" data-disclosure="pizza-list">
          <div class="disclosure-header" onclick="toggleDisclosure('pizza-list')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Liste des participants</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <div class="search-input-wrapper">
                <span class="search-icon sf-symbol" aria-hidden="true">@sfs:magnifyingglass@</span>
                <input type="search" id="pizza-search" class="search-input" placeholder="Rechercher un participant...">
              </div>
            </div>
          </div>
          <div class="disclosure-body">
            <div class="attendance-filters">
              <label class="filter-pill" id="pizza-filter-all-pill">
                <input type="radio" name="pizza-filter" value="all" checked> ÙÄã≤ Tous
              </label>
              <label class="filter-pill" id="pizza-filter-pending-pill">
                <input type="radio" name="pizza-filter" value="pending"> ÙÄÅ° En attente
              </label>
              <label class="filter-pill" id="pizza-filter-received-pill">
                <input type="radio" name="pizza-filter" value="received"> ÙÄÅ£ Servis
              </label>
              <label class="filter-pill" id="pizza-filter-checkedin-pill">
                <input type="radio" name="pizza-filter" value="checkedin"> ÙÄÜÖ Pr√©sents uniquement
              </label>
            </div>
            <div class="filter-row" style="margin-top: var(--space-3); margin-bottom: var(--space-3);">
              <select id="pizza-type-filter" class="filter-select">
                <option value="">Toutes les pizzas</option>
              </select>
            </div>
            <div class="table-container">
              <table id="pizza-table" class="members-table attendance-table">
                <thead>
                  <tr>
                    <th class="sortable-header" data-sort="name">Nom <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header team-col" data-sort="team">√âquipe <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header" data-sort="pizza">Pizza <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header status-col" data-sort="checkin">Pr√©sent <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header status-col" data-sort="status">Statut <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header time-col" data-sort="time">Heure <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="actions-col">Actions</th>
                  </tr>
                </thead>
                <tbody id="pizza-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div><!-- End Pizza Panel -->

      <!-- Rooms Panel -->
      <div id="panel-rooms" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-rooms">
        <!-- Room Stats -->
        <div class="disclosure-group open" data-disclosure="room-stats">
          <div class="disclosure-header" onclick="toggleDisclosure('room-stats')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Attribution des salles</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <button type="button" id="refresh-rooms-btn" class="btn btn-secondary btn-sm">Rafra√Æchir</button>
            </div>
          </div>
          <div class="disclosure-body">
            <div id="room-stats-grid" class="stats-grid"></div>
            <div id="room-by-room-grid" class="stats-grid" style="margin-top: var(--space-4);"></div>
          </div>
        </div>

        <!-- Pizza per Room -->
        <div class="disclosure-group open" data-disclosure="room-pizza">
          <div class="disclosure-header" onclick="toggleDisclosure('room-pizza')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Pizzas par salle</h2>
          </div>
          <div class="disclosure-body">
            <div id="room-pizza-container"></div>
          </div>
        </div>

        <!-- Room Assignment List -->
        <div class="disclosure-group open" data-disclosure="room-list">
          <div class="disclosure-header" onclick="toggleDisclosure('room-list')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Liste des √©quipes</h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <div class="search-input-wrapper">
                <span class="search-icon sf-symbol" aria-hidden="true">@sfs:magnifyingglass@</span>
                <input type="search" id="rooms-search" class="search-input" placeholder="Rechercher une √©quipe...">
              </div>
            </div>
          </div>
          <div class="disclosure-body">
            <div class="attendance-filters">
              <label class="filter-pill" id="rooms-filter-all-pill">
                <input type="radio" name="rooms-filter" value="all" checked> <span class="sf-symbol">@sfs:circle.circle.fill@</span> Toutes
              </label>
              <label class="filter-pill" id="rooms-filter-assigned-pill">
                <input type="radio" name="rooms-filter" value="assigned"> <span class="sf-symbol">@sfs:checkmark@</span> Assign√©es
              </label>
              <label class="filter-pill" id="rooms-filter-unassigned-pill">
                <input type="radio" name="rooms-filter" value="unassigned"> <span class="sf-symbol">@sfs:circle@</span> Non assign√©es
              </label>
            </div>
            <div class="table-container">
              <table id="rooms-table" class="members-table">
                <thead>
                  <tr>
                    <th class="sortable-header" data-sort="name">√âquipe <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header" data-sort="members">Membres <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="sortable-header" data-sort="room">Salle <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
                    <th class="actions-col">Actions</th>
                  </tr>
                </thead>
                <tbody id="rooms-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div><!-- End Rooms Panel -->

      <!-- Archives Panel -->
      <div id="panel-archives" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-archives">
        <div class="settings-header">
          <h2>Archives</h2>
          <div class="header-actions">
            <button type="button" id="refresh-archives-btn" class="btn btn-secondary btn-sm">Rafra√Æchir</button>
          </div>
        </div>

        <!-- Archives List -->
        <div class="disclosure-group open" data-disclosure="archives-list">
          <div class="disclosure-header" onclick="toggleDisclosure('archives-list')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> √âditions archiv√©es</h2>
          </div>
          <div class="disclosure-body">
            <div id="archives-container" class="archives-container">
              <div class="loading-placeholder">Chargement des archives...</div>
            </div>
          </div>
        </div>

        <!-- Archive Detail View (initially hidden) -->
        <div id="archive-detail" class="disclosure-group hidden" data-disclosure="archive-detail">
          <div class="disclosure-header" onclick="toggleDisclosure('archive-detail')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> <span id="archive-detail-title">D√©tails de l'archive</span></h2>
            <div class="header-actions" onclick="event.stopPropagation()">
              <button type="button" id="export-archive-json-btn" class="btn btn-secondary btn-sm">Export JSON</button>
              <button type="button" id="export-archive-zip-btn" class="btn btn-primary btn-sm">Export ZIP</button>
              <button type="button" id="close-archive-detail-btn" class="btn btn-secondary btn-sm">Fermer</button>
            </div>
          </div>
          <div class="disclosure-body">
            <!-- Archive Stats -->
            <div class="archive-stats-grid" id="archive-stats-grid"></div>
            
            <!-- Archive Teams -->
            <div class="archive-section">
              <h3>√âquipes</h3>
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Nom</th>
                      <th>Membres</th>
                      <th>Salle</th>
                    </tr>
                  </thead>
                  <tbody id="archive-teams-tbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Archive Members -->
            <div class="archive-section">
              <h3>Participants</h3>
              <div class="table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Nom</th>
                      <th>Email</th>
                      <th>√âquipe</th>
                      <th>Niveau BAC</th>
                    </tr>
                  </thead>
                  <tbody id="archive-members-tbody"></tbody>
                </table>
              </div>
            </div>

            <!-- GDPR Notice -->
            <div id="archive-gdpr-notice" class="archive-gdpr-notice hidden">
              <p><strong><span class="sf-symbol">@sfs:exclamationmark.triangle@</span> Donn√©es anonymis√©es</strong></p>
              <p>Cette archive a d√©pass√© sa date de r√©tention GDPR. Les donn√©es personnelles (noms, emails) ont √©t√© supprim√©es conform√©ment au RGPD.</p>
            </div>
          </div>
        </div>
      </div><!-- End Archives Panel -->

      <!-- Settings Panel -->
      <div id="panel-settings" class="tab-panel hidden" role="tabpanel" aria-labelledby="tab-settings">
        <div class="settings-header">
          <h2>Param√®tres</h2>
          <button type="button" id="save-settings-btn" class="btn btn-primary" disabled>
            Enregistrer les modifications
          </button>
        </div>

        <!-- General Settings -->
        <div class="disclosure-group open" data-disclosure="settings-general">
          <div class="disclosure-header" onclick="toggleDisclosure('settings-general')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> G√©n√©ral</h2>
          </div>
          <div class="disclosure-body">
            <div class="settings-card">
              <h3>Export Officiel NDI</h3>
              <div class="form-group">
                <label for="setting-school-name">Nom de l'√©cole (exact comme saisi sur le site NDI)</label>
                <input type="text" id="setting-school-name" value="Universit√© d'Evry" maxlength="256" placeholder="Universit√© d'Evry">
              </div>
            </div>

            <div class="settings-card">
              <h3>Limites de capacit√©</h3>
              <div class="settings-grid">
                <div class="form-group">
                  <label for="setting-max-team">Taille max d'√©quipe</label>
                  <input type="number" id="setting-max-team" min="1" max="100" value="15">
                </div>
                <div class="form-group">
                  <label for="setting-max-participants">Participants max</label>
                  <input type="number" id="setting-max-participants" min="1" max="10000" value="200">
                </div>
                <div class="form-group">
                  <label for="setting-min-team">Taille min d'√©quipe</label>
                  <input type="number" id="setting-min-team" min="1" max="50" value="1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pizza Management -->
        <div class="disclosure-group open" data-disclosure="settings-pizzas">
          <div class="disclosure-header" onclick="toggleDisclosure('settings-pizzas')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Pizzas</h2>
          </div>
          <div class="disclosure-body">
            <div class="settings-card">
              <h3>Gestion des pizzas</h3>
              <div id="pizzas-list" class="pizzas-list"></div>

              <div id="pizza-add-form" class="pizza-add-form">
                <h4>Ajouter une pizza</h4>
                <form id="add-pizza-form-element">
                  <div class="settings-grid">
                    <div class="form-group">
                      <label for="new-pizza-id">ID (unique)</label>
                      <input type="text" id="new-pizza-id" placeholder="ex: hawaienne" required>
                    </div>
                    <div class="form-group">
                      <label for="new-pizza-name">Nom</label>
                      <input type="text" id="new-pizza-name" placeholder="ex: Hawa√Øenne" required>
                    </div>
                    <div class="form-group">
                      <label for="new-pizza-desc">Description</label>
                      <input type="text" id="new-pizza-desc" placeholder="ex: Tomate, jambon, ananas">
                    </div>
                  </div>
                  <button type="submit" class="btn btn-secondary btn-sm"><span class="sf-symbol">@sfs:plus@</span> Ajouter</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Online Payment Settings -->
        <div class="disclosure-group open" data-disclosure="settings-payment">
          <div class="disclosure-header" onclick="toggleDisclosure('settings-payment')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Paiement en ligne</h2>
          </div>
          <div class="disclosure-body">
            <div class="settings-card">
              <h3>Activation</h3>
              <p class="settings-description">Activer ou d√©sactiver le paiement en ligne lors de l'inscription.</p>
              <div class="form-group">
                <label class="toggle-label">
                  <input type="checkbox" id="setting-payment-enabled">
                  <span class="toggle-switch"></span>
                  <span>Paiement en ligne activ√©</span>
                </label>
              </div>
            </div>

            <div class="settings-card">
              <h3>Tarifs d'inscription</h3>
              <p class="settings-description">Prix de l'inscription en ligne selon la p√©riode.</p>
              <div class="settings-grid">
                <div class="form-group">
                  <label for="setting-price-tier1">Prix anticip√© (‚Ç¨)</label>
                  <input type="number" id="setting-price-tier1" min="0" max="100" step="0.01" value="5.00">
                  <span class="form-hint">Inscription avant la date limite</span>
                </div>
                <div class="form-group">
                  <label for="setting-price-tier2">Prix derni√®re semaine (‚Ç¨)</label>
                  <input type="number" id="setting-price-tier2" min="0" max="100" step="0.01" value="7.00">
                  <span class="form-hint">Inscription dans les derniers jours</span>
                </div>
                <div class="form-group">
                  <label for="setting-tier1-cutoff-days">Jours avant deadline pour tarif anticip√©</label>
                  <input type="number" id="setting-tier1-cutoff-days" min="1" max="30" value="7">
                  <span class="form-hint">Nombre de jours avant la deadline</span>
                </div>
              </div>
            </div>

            <div class="settings-card">
              <h3>Date limite d'inscription</h3>
              <p class="settings-description">Date et heure de cl√¥ture des inscriptions en ligne.</p>
              <div class="form-group">
                <label for="setting-registration-deadline">Date et heure limite</label>
                <input type="datetime-local" id="setting-registration-deadline" value="">
                <span class="form-hint">Les inscriptions seront ferm√©es √† cette date</span>
              </div>
            </div>
          </div>
        </div>

        <!-- On-site Pricing Settings -->
        <div class="disclosure-group open" data-disclosure="settings-onsite">
          <div class="disclosure-header" onclick="toggleDisclosure('settings-onsite')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Tarification sur place</h2>
          </div>
          <div class="disclosure-body">
            <div class="settings-card">
              <h3>Tarification √† l'entr√©e</h3>
              <p class="settings-description">Prix de participation pour ceux qui paient sur place.</p>
              <div class="settings-grid">
                <div class="form-group">
                  <label for="setting-price-asso-member">Prix membre asso (‚Ç¨)</label>
                  <input type="number" id="setting-price-asso-member" min="0" max="100" step="0.01" value="5.00">
                </div>
                <div class="form-group">
                  <label for="setting-price-non-member">Prix non-membre (‚Ç¨)</label>
                  <input type="number" id="setting-price-non-member" min="0" max="100" step="0.01" value="8.00">
                </div>
                <div class="form-group">
                  <label for="setting-late-cutoff">Heure limite (arriv√©e tardive)</label>
                  <input type="time" id="setting-late-cutoff" value="19:00">
                </div>
                <div class="form-group">
                  <label for="setting-price-late">Prix retardataire (‚Ç¨)</label>
                  <input type="number" id="setting-price-late" min="0" max="100" step="0.01" value="10.00">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Archive & Data Management -->
        <div class="disclosure-group" data-disclosure="settings-archive">
          <div class="disclosure-header" onclick="toggleDisclosure('settings-archive')">
            <h2><span class="disclosure-chevron sf-symbol">@sfs:chevron.right@</span> Archivage & Donn√©es</h2>
          </div>
          <div class="disclosure-body">
            <div class="settings-card">
              <h3>Cr√©er une archive</h3>
              <p class="settings-description">
                Archivez les donn√©es de l'√©dition actuelle avant de r√©initialiser pour la prochaine ann√©e.
                L'archive conserve une copie compl√®te des √©quipes, participants et statistiques.
              </p>
              <div class="archive-info" id="current-event-info">
                <p>Ann√©e de l'√©v√©nement : <strong id="current-event-year">-</strong></p>
                <p>√âquipes : <strong id="current-teams-count">-</strong></p>
                <p>Participants : <strong id="current-participants-count">-</strong></p>
              </div>
              <button type="button" id="create-archive-btn" class="btn btn-primary">
                üìÅ Cr√©er l'archive
              </button>
            </div>

            <div class="settings-card">
              <h3>R√©tention GDPR</h3>
              <p class="settings-description">
                Dur√©e de conservation des donn√©es personnelles dans les archives.
                Apr√®s expiration, les donn√©es sont automatiquement anonymis√©es (noms, emails supprim√©s).
              </p>
              <div class="form-group">
                <label for="setting-gdpr-retention">Dur√©e de r√©tention (ann√©es)</label>
                <input type="number" id="setting-gdpr-retention" min="1" max="10" value="3">
                <span class="form-hint">Les archives plus anciennes seront anonymis√©es</span>
              </div>
              <button type="button" id="check-expiration-btn" class="btn btn-secondary">
                üîç V√©rifier les expirations
              </button>
              <p id="expiration-result" class="result-text hidden"></p>
            </div>

            <div class="settings-card danger-zone">
              <h3><span class="sf-symbol">@sfs:exclamationmark.triangle@</span> Zone dangereuse</h3>
              <p class="settings-description warning-text">
                R√©initialisez toutes les donn√©es pour pr√©parer une nouvelle √©dition.
                <strong>Cette action est irr√©versible.</strong>
              </p>
              <div id="reset-safety-check" class="reset-safety-check">
                <p class="checking">V√©rification en cours...</p>
              </div>
              <button type="button" id="reset-data-btn" class="btn btn-danger" disabled>
                üóëÔ∏è R√©initialiser toutes les donn√©es
              </button>
            </div>
          </div>
        </div>
      </div><!-- End Settings Panel -->

    </div>

    <!-- Add/Edit Team Modal -->
    <div id="team-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="team-modal-title">Nouvelle √©quipe</h3>
        <form id="team-form">
          <input type="hidden" id="team-form-id">
          <div class="form-group">
            <label for="team-form-name">Nom de l'√©quipe *</label>
            <input type="text" id="team-form-name" required>
          </div>
          <div class="form-group">
            <label for="team-form-desc">Description</label>
            <textarea id="team-form-desc" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label for="team-form-password">Mot de passe (laisser vide pour ne pas changer)</label>
            <input type="text" id="team-form-password" placeholder="Nouveau mot de passe">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('team-modal')">ÙÄÅë Annuler</button>
            <button type="submit" class="btn btn-primary">ÙÄÅ£ Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add/Edit Member Modal -->
    <div id="member-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="member-modal-title">Nouveau membre</h3>
        <form id="member-form">
          <input type="hidden" id="member-form-id">
          <div class="form-group">
            <label for="member-form-team">√âquipe *</label>
            <select id="member-form-team" required></select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-firstname">Pr√©nom *</label>
              <input type="text" id="member-form-firstname" required>
            </div>
            <div class="form-group">
              <label for="member-form-lastname">Nom *</label>
              <input type="text" id="member-form-lastname" required>
            </div>
          </div>
          <div class="form-group">
            <label for="member-form-email">Email *</label>
            <input type="email" id="member-form-email" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="member-form-bac">Niveau BAC</label>
              <select id="member-form-bac">
                <option value="0">Non bachelier</option>
                <option value="1">BAC+1</option>
                <option value="2">BAC+2</option>
                <option value="3">BAC+3 (Licence)</option>
                <option value="4">BAC+4</option>
                <option value="5">BAC+5 (Master)</option>
                <option value="6">BAC+6</option>
                <option value="7">BAC+7</option>
                <option value="8">BAC+8 (Doctorat)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="member-form-food">Pizza</label>
              <select id="member-form-food">
                <option value="">Aucune</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="member-form-leader">
              Chef d'√©quipe
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('member-modal')">ÙÄÅë Annuler</button>
            <button type="submit" class="btn btn-primary">ÙÄÅ£ Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Confirmer la suppression</h3>
        <p id="confirm-message"></p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('confirm-modal')">ÙÄÅë Annuler</button>
          <button type="button" id="confirm-delete-btn" class="btn btn-danger">ÙÄàë Supprimer</button>
        </div>
      </div>
    </div>

    <!-- Check-in with Payment Modal -->
    <div id="checkin-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Valider la pr√©sence</h3>
        <p id="checkin-member-name" class="modal-subtitle"></p>
        <input type="hidden" id="checkin-member-id">

        <div class="payment-options">
          <label class="payment-option" id="option-org">
            <input type="radio" name="payment-tier" value="organisation">
            <span class="payment-option-content">
              <span class="payment-option-title">Organisation</span>
              <span class="payment-option-price">Gratuit</span>
            </span>
          </label>

          <label class="payment-option" id="option-asso">
            <input type="radio" name="payment-tier" value="asso_member" checked>
            <span class="payment-option-content">
              <span class="payment-option-title">Membre Asso</span>
              <span class="payment-option-price" id="price-asso">5,00 ‚Ç¨</span>
            </span>
          </label>

          <label class="payment-option" id="option-non-member">
            <input type="radio" name="payment-tier" value="non_member">
            <span class="payment-option-content">
              <span class="payment-option-title">Non-membre</span>
              <span class="payment-option-price" id="price-non-member">8,00 ‚Ç¨</span>
            </span>
          </label>

          <label class="payment-option hidden" id="option-late">
            <input type="radio" name="payment-tier" value="late">
            <span class="payment-option-content">
              <span class="payment-option-title">Retardataire</span>
              <span class="payment-option-price" id="price-late">10,00 ‚Ç¨</span>
            </span>
          </label>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('checkin-modal')">ÙÄÅë Annuler</button>
          <button type="button" class="btn btn-primary" onclick="confirmCheckIn()">ÙÄÅ£ Valider le paiement</button>
        </div>
      </div>
    </div>
  </main>
</AdminLayout>

<script define:vars={{ baseUrl: import.meta.env.BASE_URL }}>
/**
 * NDI Admin Dashboard
 * Full CRUD functionality for teams and members
 */

// API base URL (from Astro's BASE_URL)
const API_BASE = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function $(id) {
  return document.getElementById(id);
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function truncateText(str, maxLength = 40) {
  if (!str || str.length <= maxLength) return str;
  return str.substring(0, maxLength - 1) + '‚Ä¶';
}

function formatTeamWithRoom(teamName, teamRoom, maxLength = 40) {
  if (!teamName) return { truncated: '-', full: '-' };
  const fullText = teamRoom ? `${teamName} (${teamRoom})` : teamName;
  const truncated = truncateText(fullText, maxLength);
  return { truncated, full: fullText };
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================

function showToast(message, type = 'success', duration = 3000) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function toastSuccess(message) {
  showToast(message, 'success');
}

function toastError(message) {
  showToast(message, 'error');
}

// ============================================================
// API FUNCTIONS
// ============================================================

let adminToken = localStorage.getItem('ndi_admin_token') || '';

async function api(endpoint, options = {}) {
  const response = await fetch(`${API_BASE}/api${endpoint}`, {
    headers: {
      'Authorization': `Bearer ${adminToken}`,
      'Content-Type': 'application/json',
      ...options.headers
    },
    ...options
  });

  if (response.status === 401) {
    throw new Error('Unauthorized');
  }

  // Handle CSV downloads
  if (response.headers.get('Content-Type')?.includes('text/csv')) {
    return response;
  }

  if (!response.ok) {
    const data = await response.json();
    throw new Error(data.error || 'Request failed');
  }

  return response.json();
}

function adminGet(endpoint) {
  return api(endpoint, { method: 'GET' });
}

function adminPost(endpoint, body) {
  return api(endpoint, { method: 'POST', body: JSON.stringify(body) });
}

function adminPut(endpoint, body) {
  return api(endpoint, { method: 'PUT', body: JSON.stringify(body) });
}

// ============================================================
// STATE
// ============================================================

let teamsData = [];
let selectedMembers = new Set();
let pizzasConfig = [];

// Settings state
let settingsState = {
  maxTeamSize: 15,
  maxTotalParticipants: 200,
  minTeamSize: 1,
  schoolName: "Universit√© d'Evry",
  pizzas: [],
  bacLevels: [],
  isDirty: false
};

// Import state
let csvData = null;
let parsedRows = [];

// DOM Elements
const elements = {
  authSection: $('auth-section'),
  adminContent: $('admin-content'),
  tokenInput: $('admin-token'),
  authBtn: $('auth-btn'),
  authError: $('auth-error'),
  statsGrid: $('stats-grid'),
  foodStats: $('food-stats'),
  teamsContainer: $('teams-container'),
  exportOfficialBtn: $('export-official-btn'),
  exportAllBtn: $('export-all-btn'),
  refreshBtn: $('refresh-btn'),
  addTeamBtn: $('add-team-btn'),
  addMemberBtn: $('add-member-btn'),
  selectAllBtn: $('select-all-btn'),
  deleteSelectedBtn: $('delete-selected-btn'),
  teamModal: $('team-modal'),
  memberModal: $('member-modal'),
  confirmModal: $('confirm-modal'),
  teamForm: $('team-form'),
  memberForm: $('member-form'),
  confirmDeleteBtn: $('confirm-delete-btn')
};

// ============================================================
// MODAL & DISCLOSURE FUNCTIONS
// ============================================================

window.closeModal = function(modalId) {
  $(modalId).classList.add('hidden');
};

function openModal(modalId) {
  $(modalId).classList.remove('hidden');
}

window.toggleDisclosure = function(name) {
  const group = document.querySelector(`[data-disclosure="${name}"]`);
  if (group) {
    group.classList.toggle('open');
  }
};

// ============================================================
// RENDER FUNCTIONS
// ============================================================

function renderStats(stats) {
  elements.statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.total_teams}</div>
      <div class="stat-label">√âquipes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total_participants}</div>
      <div class="stat-label">Participants</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.max_participants}</div>
      <div class="stat-label">Capacit√© max</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.available_spots}</div>
      <div class="stat-label">Places restantes</div>
    </div>
  `;
}

function renderFoodStats(foodPreferences) {
  if (!foodPreferences || foodPreferences.length === 0) {
    elements.foodStats.innerHTML = '<p>Aucune pr√©f√©rence enregistr√©e</p>';
    return;
  }

  elements.foodStats.innerHTML = foodPreferences
    .map(item => `
      <div class="food-item">
        <span class="count">${item.count}</span> ${escapeHtml(item.food_diet)}
      </div>
    `)
    .join('');
}

function renderTeams(teams) {
  teamsData = teams;
  updateTeamSelect();

  if (!teams || teams.length === 0) {
    elements.teamsContainer.innerHTML = '<p>Aucune √©quipe inscrite</p>';
    return;
  }

  elements.teamsContainer.innerHTML = teams.map(team => `
    <div class="team-block" data-team-id="${team.id}">
      <div class="team-header" onclick="toggleTeam(${team.id})">
        <h3>${escapeHtml(team.name)}${team.room ? ` <span class="badge badge-muted">${escapeHtml(team.room)}</span>` : ''}</h3>
        <div class="team-info">
          <span>${team.members?.length || 0} membre(s)</span>
        </div>
      </div>
      <div class="team-body">
        ${team.description ? `<p><em>${escapeHtml(team.description)}</em></p>` : ''}
        <div class="team-actions action-buttons">
          <button type="button" class="icon-btn" onclick="editTeam(${team.id})" title="Modifier" aria-label="Modifier l'√©quipe">ÙÄàä</button>
          <button type="button" class="action-btn" onclick="exportTeam(${team.id}, '${escapeHtml(team.name)}')">Exporter CSV</button>
          <button type="button" class="action-btn primary" onclick="exportTeamOfficial(${team.id}, '${escapeHtml(team.name)}')">Export Officiel</button>
          ${team.name !== 'Organisation' ? `<button type="button" class="icon-btn danger" onclick="confirmDeleteTeam(${team.id}, '${escapeHtml(team.name)}')" title="Supprimer" aria-label="Supprimer l'√©quipe">ÙÄàë</button>` : ''}
        </div>
        ${renderMembersTable(team.members, team.id)}
      </div>
    </div>
  `).join('');
}

function renderMembersTable(members, teamId) {
  if (!members || members.length === 0) {
    return '<p>Aucun membre</p>';
  }

  // Sort members by name by default
  const sortedMembers = [...members].sort((a, b) => {
    const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
    const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
    return nameA.localeCompare(nameB);
  });

  return `
    <div class="table-container">
    <table class="members-table" data-team-id="${teamId}">
      <thead>
        <tr>
          <th class="checkbox-col">
            <label class="select-all-label">
              <input type="checkbox" onchange="toggleSelectAll(${teamId}, this.checked)">
            </label>
          </th>
          <th class="sortable-header" data-sort="name" onclick="sortTeamMembers(${teamId}, 'name', this)">Nom <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
          <th class="sortable-header" data-sort="email" onclick="sortTeamMembers(${teamId}, 'email', this)">Email <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
          <th class="sortable-header" data-sort="bac" onclick="sortTeamMembers(${teamId}, 'bac', this)">Niveau <span class="sort-indicator sf-symbol">@sfs:arrow.up.arrow.down@</span></th>
          <th>Pizza</th>
          <th>R√¥le</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${sortedMembers.map(m => `
          <tr class="member-row" data-member-id="${m.id}">
            <td class="checkbox-col">
              <input type="checkbox" onchange="toggleMemberSelect(${m.id}, this.checked)" ${selectedMembers.has(m.id) ? 'checked' : ''}>
            </td>
            <td>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</td>
            <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
            <td><span class="badge badge-bac">BAC+${m.bac_level}</span></td>
            <td>${escapeHtml(m.food_diet) || '-'}</td>
            <td>${m.is_leader ? '<span class="badge badge-leader">ÙÄãÄ Chef</span>' : ''}</td>
            <td class="actions-col">
              <div class="action-buttons">
                <button type="button" class="icon-btn" onclick="editMember(${m.id}, ${teamId})" title="Modifier" aria-label="Modifier le membre">ÙÄàä</button>
                <button type="button" class="icon-btn danger" onclick="confirmDeleteMember(${m.id}, '${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}')" title="Supprimer" aria-label="Supprimer le membre">ÙÄàë</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    </div>
  `;
}

function updateTeamSelect() {
  const select = $('member-form-team');
  if (select) {
    select.innerHTML = teamsData.map(t =>
      `<option value="${t.id}">${escapeHtml(t.name)}</option>`
    ).join('');
  }
}

// ============================================================
// UI HELPERS
// ============================================================

function showAuth() {
  elements.authSection.classList.remove('hidden');
  elements.adminContent.classList.add('hidden');
}

function showAdmin() {
  elements.authSection.classList.add('hidden');
  elements.adminContent.classList.remove('hidden');
}

function showAuthError(message) {
  elements.authError.textContent = message;
  elements.authError.classList.remove('hidden');
}

function hideAuthError() {
  elements.authError.classList.add('hidden');
}

function updateDeleteButton() {
  elements.deleteSelectedBtn.disabled = selectedMembers.size === 0;
  elements.deleteSelectedBtn.textContent = selectedMembers.size > 0
    ? `Supprimer s√©lection (${selectedMembers.size})`
    : 'Supprimer s√©lection';
}

// ============================================================
// GLOBAL FUNCTIONS FOR ONCLICK HANDLERS
// ============================================================

window.toggleTeam = function(teamId) {
  const block = document.querySelector(`[data-team-id="${teamId}"]`);
  if (block) block.classList.toggle('open');
};

window.toggleSelectAll = function(teamId, checked) {
  const block = document.querySelector(`[data-team-id="${teamId}"]`);
  block.querySelectorAll('.member-row input[type="checkbox"]').forEach(cb => {
    cb.checked = checked;
    const memberId = parseInt(cb.closest('.member-row').dataset.memberId);
    if (checked) {
      selectedMembers.add(memberId);
    } else {
      selectedMembers.delete(memberId);
    }
  });
  updateDeleteButton();
};

window.toggleMemberSelect = function(memberId, checked) {
  if (checked) {
    selectedMembers.add(memberId);
  } else {
    selectedMembers.delete(memberId);
  }
  updateDeleteButton();
};

// Team members sorting
const teamSortState = {}; // { teamId: { key: 'name', dir: 'asc' } }

window.sortTeamMembers = function(teamId, sortKey, headerElement) {
  const team = teamsData.find(t => t.id === teamId);
  if (!team || !team.members) return;

  // Update sort state
  if (!teamSortState[teamId]) {
    teamSortState[teamId] = { key: sortKey, dir: 'asc' };
  } else if (teamSortState[teamId].key === sortKey) {
    teamSortState[teamId].dir = teamSortState[teamId].dir === 'asc' ? 'desc' : 'asc';
  } else {
    teamSortState[teamId] = { key: sortKey, dir: 'asc' };
  }

  const { key, dir } = teamSortState[teamId];

  // Sort members
  team.members.sort((a, b) => {
    let valA, valB;
    switch (key) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'email':
        valA = a.email.toLowerCase();
        valB = b.email.toLowerCase();
        break;
      case 'bac':
        valA = a.bac_level || 0;
        valB = b.bac_level || 0;
        break;
      default:
        valA = a.first_name.toLowerCase();
        valB = b.first_name.toLowerCase();
    }

    if (valA < valB) return dir === 'asc' ? -1 : 1;
    if (valA > valB) return dir === 'asc' ? 1 : -1;
    return 0;
  });

  // Update sort indicators in the table
  const table = headerElement.closest('table');
  table.querySelectorAll('.sortable-header').forEach(h => {
    if (h.dataset.sort === key) {
      h.setAttribute('data-sort-dir', dir);
      h.querySelector('.sort-indicator').textContent = dir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      h.removeAttribute('data-sort-dir');
      h.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });

  // Re-render the table body
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = team.members.map(m => `
    <tr class="member-row" data-member-id="${m.id}">
      <td class="checkbox-col">
        <input type="checkbox" onchange="toggleMemberSelect(${m.id}, this.checked)" ${selectedMembers.has(m.id) ? 'checked' : ''}>
      </td>
      <td>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</td>
      <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
      <td><span class="badge badge-bac">BAC+${m.bac_level}</span></td>
      <td>${escapeHtml(m.food_diet) || '-'}</td>
      <td>${m.is_leader ? '<span class="badge badge-leader">ÙÄãÄ Chef</span>' : ''}</td>
      <td class="actions-col">
        <div class="action-buttons">
          <button type="button" class="icon-btn" onclick="editMember(${m.id}, ${teamId})" title="Modifier" aria-label="Modifier le membre">ÙÄàä</button>
          <button type="button" class="icon-btn danger" onclick="confirmDeleteMember(${m.id}, '${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}')" title="Supprimer" aria-label="Supprimer le membre">ÙÄàë</button>
        </div>
      </td>
    </tr>
  `).join('');
};

window.exportTeam = async function(teamId, teamName) {
  try {
    const response = await api(`/admin/export/${teamId}`);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `participants_${teamName.replace(/[^a-z0-9]/gi, '_')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
};

window.exportTeamOfficial = async function(teamId, teamName) {
  try {
    const response = await api(`/admin/export-official/${teamId}`);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `participants_officiel_${teamName.replace(/[^a-z0-9]/gi, '_')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastSuccess('Export officiel t√©l√©charg√©');
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
};

// ============================================================
// TEAM CRUD
// ============================================================

window.editTeam = function(teamId) {
  const team = teamsData.find(t => t.id === teamId);
  if (!team) return;

  $('team-modal-title').textContent = 'Modifier l\'√©quipe';
  $('team-form-id').value = teamId;
  $('team-form-name').value = team.name;
  $('team-form-desc').value = team.description || '';
  $('team-form-password').value = '';
  openModal('team-modal');
};

function openAddTeamModal() {
  $('team-modal-title').textContent = 'Nouvelle √©quipe';
  $('team-form-id').value = '';
  $('team-form-name').value = '';
  $('team-form-desc').value = '';
  $('team-form-password').value = '';
  openModal('team-modal');
}

window.confirmDeleteTeam = function(teamId, teamName) {
  $('confirm-message').textContent =
    `√ätes-vous s√ªr de vouloir supprimer l'√©quipe "${teamName}" et tous ses membres ?`;
  elements.confirmDeleteBtn.onclick = () => deleteTeam(teamId);
  openModal('confirm-modal');
};

async function deleteTeam(teamId) {
  try {
    await api(`/admin/teams/${teamId}`, { method: 'DELETE' });
    toastSuccess('√âquipe supprim√©e');
    closeModal('confirm-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

// ============================================================
// MEMBER CRUD
// ============================================================

window.editMember = function(memberId, teamId) {
  const team = teamsData.find(t => t.id === teamId);
  const member = team?.members?.find(m => m.id === memberId);
  if (!member) return;

  $('member-modal-title').textContent = 'Modifier le membre';
  $('member-form-id').value = memberId;
  $('member-form-team').value = teamId;
  $('member-form-firstname').value = member.first_name;
  $('member-form-lastname').value = member.last_name;
  $('member-form-email').value = member.email;
  $('member-form-bac').value = member.bac_level;
  $('member-form-food').value = member.food_diet || '';
  $('member-form-leader').checked = !!member.is_leader;
  openModal('member-modal');
};

function openAddMemberModal() {
  $('member-modal-title').textContent = 'Nouveau membre';
  $('member-form-id').value = '';
  $('member-form-team').value = teamsData[0]?.id || '';
  $('member-form-firstname').value = '';
  $('member-form-lastname').value = '';
  $('member-form-email').value = '';
  $('member-form-bac').value = '0';
  $('member-form-food').value = '';
  $('member-form-leader').checked = false;
  openModal('member-modal');
}

window.confirmDeleteMember = function(memberId, memberName) {
  $('confirm-message').textContent =
    `√ätes-vous s√ªr de vouloir supprimer ${memberName} ?`;
  elements.confirmDeleteBtn.onclick = () => deleteMember(memberId);
  openModal('confirm-modal');
};

async function deleteMember(memberId) {
  try {
    await api(`/admin/members/${memberId}`, { method: 'DELETE' });
    toastSuccess('Membre supprim√©');
    closeModal('confirm-modal');
    selectedMembers.delete(memberId);
    updateDeleteButton();
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

async function deleteSelectedMembers() {
  if (selectedMembers.size === 0) return;

  $('confirm-message').textContent =
    `√ätes-vous s√ªr de vouloir supprimer ${selectedMembers.size} membre(s) ?`;
  elements.confirmDeleteBtn.onclick = async () => {
    try {
      await api('/admin/members/delete-batch', {
        method: 'POST',
        body: JSON.stringify({ memberIds: Array.from(selectedMembers) })
      });
      toastSuccess(`${selectedMembers.size} membre(s) supprim√©(s)`);
      closeModal('confirm-modal');
      selectedMembers.clear();
      updateDeleteButton();
      loadData();
    } catch (err) {
      toastError('Erreur: ' + err.message);
    }
  };
  openModal('confirm-modal');
}

function selectAllParticipants() {
  // Get all member checkboxes across all teams
  const allCheckboxes = document.querySelectorAll('.member-row input[type="checkbox"]');
  const allSelected = selectedMembers.size === allCheckboxes.length && allCheckboxes.length > 0;

  // Toggle: if all are selected, deselect all; otherwise select all
  allCheckboxes.forEach(cb => {
    const memberId = parseInt(cb.closest('.member-row').dataset.memberId);
    if (allSelected) {
      cb.checked = false;
      selectedMembers.delete(memberId);
    } else {
      cb.checked = true;
      selectedMembers.add(memberId);
    }
  });

  // Also update the team-level "select all" checkboxes
  document.querySelectorAll('.team-block input[type="checkbox"]').forEach(cb => {
    if (!cb.closest('.member-row')) {
      cb.checked = !allSelected;
    }
  });

  updateDeleteButton();
  updateSelectAllButton();
}

function updateSelectAllButton() {
  const allCheckboxes = document.querySelectorAll('.member-row input[type="checkbox"]');
  const allSelected = selectedMembers.size === allCheckboxes.length && allCheckboxes.length > 0;
  elements.selectAllBtn.textContent = allSelected ? 'Tout d√©s√©lectionner' : 'Tout s√©lectionner';
}

// ============================================================
// FORM HANDLERS
// ============================================================

async function handleTeamSubmit(e) {
  e.preventDefault();
  const id = $('team-form-id').value;
  const name = $('team-form-name').value;
  const description = $('team-form-desc').value;
  const password = $('team-form-password').value;

  try {
    if (id) {
      await api(`/admin/teams/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ name, description, password })
      });
      toastSuccess('√âquipe mise √† jour');
    } else {
      await api('/admin/teams', {
        method: 'POST',
        body: JSON.stringify({ name, description, password })
      });
      toastSuccess('√âquipe cr√©√©e');
    }
    closeModal('team-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

async function handleMemberSubmit(e) {
  e.preventDefault();
  const id = $('member-form-id').value;
  const teamId = parseInt($('member-form-team').value);
  const firstName = $('member-form-firstname').value;
  const lastName = $('member-form-lastname').value;
  const email = $('member-form-email').value;
  const bacLevel = parseInt($('member-form-bac').value);
  const foodDiet = $('member-form-food').value;
  const isLeader = $('member-form-leader').checked;

  try {
    if (id) {
      await api(`/admin/members/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ teamId, firstName, lastName, email, bacLevel, foodDiet, isLeader })
      });
      toastSuccess('Membre mis √† jour');
    } else {
      await api('/admin/members', {
        method: 'POST',
        body: JSON.stringify({ teamId, firstName, lastName, email, bacLevel, foodDiet, isLeader })
      });
      toastSuccess('Membre ajout√©');
    }
    closeModal('member-modal');
    loadData();
  } catch (err) {
    toastError('Erreur: ' + err.message);
  }
}

// ============================================================
// AUTH & DATA LOADING
// ============================================================

async function handleAuth() {
  const token = elements.tokenInput.value.trim();
  if (!token) {
    showAuthError('Token requis');
    return;
  }

  adminToken = token;
  hideAuthError();

  try {
    await loadData();
    localStorage.setItem('ndi_admin_token', token);
    showAdmin();
    initSettings();
    initImport();
    initAllParticipants();
    initArchives();
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuthError('Token invalide');
      adminToken = '';
      localStorage.removeItem('ndi_admin_token');
    } else {
      showAuthError('Erreur: ' + err.message);
    }
  }
}

async function loadData() {
  const { stats, teams } = await api('/admin/stats');
  renderStats(stats);
  renderFoodStats(stats.food_preferences);
  renderTeams(teams);
  renderAllParticipants();
  await loadSettings();
  await loadPizzasConfig();
}

async function loadPizzasConfig() {
  try {
    const response = await fetch('./api/config');
    const { config } = await response.json();
    pizzasConfig = config.pizzas || [];
    updatePizzaSelect();
  } catch (err) {
    console.error('Error loading pizzas config:', err);
  }
}

function updatePizzaSelect() {
  const select = $('member-form-food');
  if (!select) return;

  select.innerHTML = '<option value="">Aucune</option>' +
    pizzasConfig.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('');
}

async function handleExportAll() {
  try {
    const response = await api('/admin/export');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'participants.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
}

async function handleExportOfficial() {
  try {
    const response = await api('/admin/export-official');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'participants_officiel.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toastSuccess('Export officiel t√©l√©charg√©');
  } catch (err) {
    toastError('Erreur export: ' + err.message);
  }
}

async function handleRefresh() {
  try {
    await loadData();
    toastSuccess('Donn√©es actualis√©es');
  } catch (err) {
    if (err.message === 'Unauthorized') {
      showAuth();
      showAuthError('Session expir√©e');
    } else {
      toastError('Erreur: ' + err.message);
    }
  }
}

// ============================================================
// ALL PARTICIPANTS LIST MODULE
// ============================================================

let allParticipantsData = [];
let allParticipantsSearchTerm = '';
let allParticipantsSortKey = 'name';
let allParticipantsSortDir = 'asc';

function renderAllParticipants() {
  const tbody = $('all-participants-tbody');
  if (!tbody) return;

  // Build flat list from teamsData
  allParticipantsData = [];
  teamsData.forEach(team => {
    if (team.members) {
      team.members.forEach(member => {
        allParticipantsData.push({
          ...member,
          team_name: team.name
        });
      });
    }
  });

  let filtered = [...allParticipantsData];

  // Apply search filter
  if (allParticipantsSearchTerm) {
    const term = allParticipantsSearchTerm.toLowerCase();
    filtered = filtered.filter(m =>
      m.first_name.toLowerCase().includes(term) ||
      m.last_name.toLowerCase().includes(term) ||
      m.email.toLowerCase().includes(term) ||
      m.team_name.toLowerCase().includes(term)
    );
  }

  // Apply sorting
  filtered.sort((a, b) => {
    let valA, valB;
    switch (allParticipantsSortKey) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'email':
        valA = a.email.toLowerCase();
        valB = b.email.toLowerCase();
        break;
      case 'team':
        valA = a.team_name.toLowerCase();
        valB = b.team_name.toLowerCase();
        break;
      case 'pizza':
        valA = (a.food_diet || '').toLowerCase();
        valB = (b.food_diet || '').toLowerCase();
        break;
      case 'bac':
        valA = a.bac_level || 0;
        valB = b.bac_level || 0;
        break;
      case 'manager':
        valA = a.is_leader ? 1 : 0;
        valB = b.is_leader ? 1 : 0;
        break;
      default:
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
    }

    if (valA < valB) return allParticipantsSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return allParticipantsSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Aucun participant trouv√©</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(m => {
    const teamInfo = formatTeamWithRoom(m.team_name, m.team_room, 40);
    return `
    <tr class="member-row" data-member-id="${m.id}">
      <td><strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong></td>
      <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
      <td class="team-col" title="${escapeHtml(teamInfo.full)}">${escapeHtml(teamInfo.truncated)}</td>
      <td>${escapeHtml(m.food_diet) || '-'}</td>
      <td><span class="badge badge-bac">BAC+${m.bac_level || '?'}</span></td>
      <td>${m.is_leader ? '<span class="badge badge-leader">ÙÄãÄ Chef</span>' : '<span class="badge badge-muted">Membre</span>'}</td>
    </tr>
  `;}).join('');
}

window.sortAllParticipants = function(key) {
  if (allParticipantsSortKey === key) {
    allParticipantsSortDir = allParticipantsSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    allParticipantsSortKey = key;
    allParticipantsSortDir = 'asc';
  }

  // Update sort indicators
  document.querySelectorAll('#all-participants-table .sortable-header').forEach(h => {
    const indicator = h.querySelector('.sort-indicator');
    if (h.dataset.sort === allParticipantsSortKey) {
      indicator.textContent = allParticipantsSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      indicator.textContent = '@sfs:arrow.up.arrow.down@';
    }
  });

  renderAllParticipants();
};

function initAllParticipants() {
  const searchInput = $('all-participants-search');
  if (searchInput) {
    searchInput.addEventListener('input', e => {
      allParticipantsSearchTerm = e.target.value;
      renderAllParticipants();
    });
  }
}

// ============================================================
// SETTINGS MODULE
// ============================================================

async function loadSettings() {
  try {
    const data = await adminGet('/admin/settings');
    settingsState.maxTeamSize = parseInt(data.settings.max_team_size, 10) || 15;
    settingsState.maxTotalParticipants = parseInt(data.settings.max_total_participants, 10) || 200;
    settingsState.minTeamSize = parseInt(data.settings.min_team_size, 10) || 1;
    settingsState.schoolName = data.settings.school_name || "Universit√© d'Evry";
    settingsState.pizzas = data.settings.pizzas || [];
    settingsState.bacLevels = data.settings.bac_levels || [];
    settingsState.isDirty = false;

    // Load on-site pricing settings
    pricingSettings.priceAssoMember = parseInt(data.settings.price_asso_member, 10) || 500;
    pricingSettings.priceNonMember = parseInt(data.settings.price_non_member, 10) || 800;
    pricingSettings.priceLate = parseInt(data.settings.price_late, 10) || 1000;
    pricingSettings.lateCutoffTime = data.settings.late_cutoff_time || '19:00';

    // Load online payment settings
    pricingSettings.paymentEnabled = data.settings.payment_enabled === 'true' || data.settings.payment_enabled === true;
    pricingSettings.priceTier1 = parseInt(data.settings.price_tier1, 10) || 500;
    pricingSettings.priceTier2 = parseInt(data.settings.price_tier2, 10) || 700;
    pricingSettings.tier1CutoffDays = parseInt(data.settings.tier1_cutoff_days, 10) || 7;
    pricingSettings.registrationDeadline = data.settings.registration_deadline || '';

    // Load GDPR settings
    settingsState.gdprRetentionYears = parseInt(data.settings.gdpr_retention_years, 10) || 3;

    renderSettings();
  } catch (err) {
    console.error('Error loading settings:', err);
  }
}

function renderSettings() {
  const schoolNameInput = $('setting-school-name');
  if (schoolNameInput) schoolNameInput.value = settingsState.schoolName;

  const maxTeamInput = $('setting-max-team');
  const maxParticipantsInput = $('setting-max-participants');
  const minTeamInput = $('setting-min-team');

  if (maxTeamInput) maxTeamInput.value = settingsState.maxTeamSize;
  if (maxParticipantsInput) maxParticipantsInput.value = settingsState.maxTotalParticipants;
  if (minTeamInput) minTeamInput.value = settingsState.minTeamSize;

  // Render on-site pricing settings (convert cents to euros for display)
  const priceAssoInput = $('setting-price-asso-member');
  const priceNonMemberInput = $('setting-price-non-member');
  const priceLateInput = $('setting-price-late');
  const lateCutoffInput = $('setting-late-cutoff');

  if (priceAssoInput) priceAssoInput.value = (pricingSettings.priceAssoMember / 100).toFixed(2);
  if (priceNonMemberInput) priceNonMemberInput.value = (pricingSettings.priceNonMember / 100).toFixed(2);
  if (priceLateInput) priceLateInput.value = (pricingSettings.priceLate / 100).toFixed(2);
  if (lateCutoffInput) lateCutoffInput.value = pricingSettings.lateCutoffTime;

  // Render online payment settings
  const paymentEnabledInput = $('setting-payment-enabled');
  const priceTier1Input = $('setting-price-tier1');
  const priceTier2Input = $('setting-price-tier2');
  const tier1CutoffDaysInput = $('setting-tier1-cutoff-days');
  const registrationDeadlineInput = $('setting-registration-deadline');

  if (paymentEnabledInput) paymentEnabledInput.checked = pricingSettings.paymentEnabled;
  if (priceTier1Input) priceTier1Input.value = (pricingSettings.priceTier1 / 100).toFixed(2);
  if (priceTier2Input) priceTier2Input.value = (pricingSettings.priceTier2 / 100).toFixed(2);
  if (tier1CutoffDaysInput) tier1CutoffDaysInput.value = pricingSettings.tier1CutoffDays;
  if (registrationDeadlineInput && pricingSettings.registrationDeadline) {
    // Convert ISO string to datetime-local format (YYYY-MM-DDTHH:MM)
    const deadline = new Date(pricingSettings.registrationDeadline);
    if (!isNaN(deadline.getTime())) {
      const localDatetime = deadline.toISOString().slice(0, 16);
      registrationDeadlineInput.value = localDatetime;
    }
  }

  // Render GDPR settings
  const gdprRetentionInput = $('setting-gdpr-retention');
  if (gdprRetentionInput) gdprRetentionInput.value = settingsState.gdprRetentionYears || 3;

  renderPizzasList();
  updateSaveButton();
}

function renderPizzasList() {
  const container = $('pizzas-list');
  if (!container) return;

  if (settingsState.pizzas.length === 0) {
    container.innerHTML = '<p class="text-muted">Aucune pizza configur√©e</p>';
    return;
  }

  container.innerHTML = settingsState.pizzas.map((pizza, index) => `
    <div class="pizza-item" data-index="${index}">
      <div class="pizza-item-info">
        <span class="pizza-item-id">${escapeHtml(pizza.id)}</span>
        <span class="pizza-item-name">${escapeHtml(pizza.name)}</span>
        <span class="pizza-item-desc">${escapeHtml(pizza.description || '')}</span>
      </div>
      <div class="pizza-item-actions action-buttons">
        <button type="button" class="icon-btn sm edit-pizza-btn" data-index="${index}" title="Modifier" aria-label="Modifier la pizza">ÙÄàä</button>
        <button type="button" class="icon-btn sm danger delete-pizza-btn" data-index="${index}" title="Supprimer" aria-label="Supprimer la pizza">ÙÄàë</button>
      </div>
    </div>
  `).join('');

  container.querySelectorAll('.edit-pizza-btn').forEach(btn => {
    btn.addEventListener('click', () => editPizza(parseInt(btn.dataset.index, 10)));
  });

  container.querySelectorAll('.delete-pizza-btn').forEach(btn => {
    btn.addEventListener('click', () => deletePizza(parseInt(btn.dataset.index, 10)));
  });
}

function initSettings() {
  // All settings inputs that should trigger dirty state
  const settingsInputs = [
    'setting-max-team', 'setting-max-participants', 'setting-min-team', 'setting-school-name',
    'setting-price-asso-member', 'setting-price-non-member', 'setting-price-late', 'setting-late-cutoff',
    // Online payment settings
    'setting-payment-enabled', 'setting-price-tier1', 'setting-price-tier2',
    'setting-tier1-cutoff-days', 'setting-registration-deadline'
  ];

  settingsInputs.forEach(id => {
    const input = $(id);
    if (input) {
      input.addEventListener('change', markDirty);
      input.addEventListener('input', markDirty);
    }
  });

  const saveBtn = $('save-settings-btn');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveSettings);
  }

  const addPizzaForm = $('add-pizza-form-element');
  if (addPizzaForm) {
    addPizzaForm.addEventListener('submit', (e) => {
      e.preventDefault();
      addPizzaFromForm();
    });
  }
}

function markDirty() {
  settingsState.isDirty = true;
  updateSaveButton();
}

function updateSaveButton() {
  const saveBtn = $('save-settings-btn');
  if (saveBtn) {
    saveBtn.disabled = !settingsState.isDirty;
    saveBtn.textContent = settingsState.isDirty ? 'Enregistrer *' : 'Enregistrer';
  }
}

function addPizzaFromForm() {
  const idInput = $('new-pizza-id');
  const nameInput = $('new-pizza-name');
  const descInput = $('new-pizza-desc');

  if (!idInput || !nameInput) return;

  const id = idInput.value.trim().toLowerCase().replace(/\s+/g, '_');
  const name = nameInput.value.trim();
  const description = descInput?.value.trim() || '';

  if (!id || !name) {
    toastError('ID et nom requis');
    return;
  }

  if (settingsState.pizzas.some(p => p.id === id)) {
    toastError('Une pizza avec cet ID existe d√©j√†');
    return;
  }

  settingsState.pizzas.push({ id, name, description });
  markDirty();
  renderPizzasList();

  idInput.value = '';
  nameInput.value = '';
  if (descInput) descInput.value = '';

  toastSuccess('Pizza ajout√©e (non sauvegard√©e)');
}

function editPizza(index) {
  const pizza = settingsState.pizzas[index];
  if (!pizza) return;

  const newName = prompt('Nom de la pizza:', pizza.name);
  if (newName === null) return;

  const newDesc = prompt('Description:', pizza.description || '');
  if (newDesc === null) return;

  settingsState.pizzas[index] = {
    ...pizza,
    name: newName.trim() || pizza.name,
    description: newDesc.trim()
  };

  markDirty();
  renderPizzasList();
}

function deletePizza(index) {
  const pizza = settingsState.pizzas[index];
  if (!pizza) return;

  if (!confirm(`Supprimer la pizza "${pizza.name}" ?`)) return;

  settingsState.pizzas.splice(index, 1);
  markDirty();
  renderPizzasList();
}

async function saveSettings() {
  try {
    const maxTeamSize = parseInt($('setting-max-team')?.value, 10);
    const maxTotalParticipants = parseInt($('setting-max-participants')?.value, 10);
    const minTeamSize = parseInt($('setting-min-team')?.value, 10);
    const schoolName = $('setting-school-name')?.value?.trim() || "Universit√© d'Evry";

    // On-site pricing settings (convert euros to cents)
    const priceAssoMember = Math.round(parseFloat($('setting-price-asso-member')?.value || '5') * 100);
    const priceNonMember = Math.round(parseFloat($('setting-price-non-member')?.value || '8') * 100);
    const priceLate = Math.round(parseFloat($('setting-price-late')?.value || '10') * 100);
    const lateCutoffTime = $('setting-late-cutoff')?.value || '19:00';

    // Online payment settings
    const paymentEnabled = $('setting-payment-enabled')?.checked || false;
    const priceTier1 = Math.round(parseFloat($('setting-price-tier1')?.value || '5') * 100);
    const priceTier2 = Math.round(parseFloat($('setting-price-tier2')?.value || '7') * 100);
    const tier1CutoffDays = parseInt($('setting-tier1-cutoff-days')?.value, 10) || 7;
    const registrationDeadlineValue = $('setting-registration-deadline')?.value || '';
    // Convert datetime-local value to ISO string
    const registrationDeadline = registrationDeadlineValue ? new Date(registrationDeadlineValue).toISOString() : '';

    // GDPR settings
    const gdprRetentionYears = parseInt($('setting-gdpr-retention')?.value, 10) || 3;

    if (isNaN(maxTeamSize) || maxTeamSize < 1 || maxTeamSize > 100) {
      toastError('Taille max d\'√©quipe invalide (1-100)');
      return;
    }
    if (isNaN(maxTotalParticipants) || maxTotalParticipants < 1 || maxTotalParticipants > 10000) {
      toastError('Participants max invalide (1-10000)');
      return;
    }
    if (isNaN(minTeamSize) || minTeamSize < 1 || minTeamSize > 50) {
      toastError('Taille min d\'√©quipe invalide (1-50)');
      return;
    }
    if (isNaN(priceAssoMember) || priceAssoMember < 0) {
      toastError('Prix membre asso invalide');
      return;
    }
    if (isNaN(priceNonMember) || priceNonMember < 0) {
      toastError('Prix non-membre invalide');
      return;
    }
    if (isNaN(priceLate) || priceLate < 0) {
      toastError('Prix retardataire invalide');
      return;
    }
    if (isNaN(priceTier1) || priceTier1 < 0) {
      toastError('Prix anticip√© invalide');
      return;
    }
    if (isNaN(priceTier2) || priceTier2 < 0) {
      toastError('Prix derni√®re semaine invalide');
      return;
    }
    if (isNaN(tier1CutoffDays) || tier1CutoffDays < 1 || tier1CutoffDays > 30) {
      toastError('Jours avant deadline invalide (1-30)');
      return;
    }

    const saveBtn = $('save-settings-btn');
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Enregistrement...';
    }

    await adminPut('/admin/settings', {
      max_team_size: maxTeamSize,
      max_total_participants: maxTotalParticipants,
      min_team_size: minTeamSize,
      school_name: schoolName,
      pizzas: settingsState.pizzas,
      price_asso_member: priceAssoMember,
      price_non_member: priceNonMember,
      price_late: priceLate,
      late_cutoff_time: lateCutoffTime,
      // Online payment settings
      payment_enabled: paymentEnabled,
      price_tier1: priceTier1,
      price_tier2: priceTier2,
      tier1_cutoff_days: tier1CutoffDays,
      registration_deadline: registrationDeadline,
      // GDPR settings
      gdpr_retention_years: gdprRetentionYears
    });

    settingsState.isDirty = false;
    settingsState.maxTeamSize = maxTeamSize;
    settingsState.maxTotalParticipants = maxTotalParticipants;
    settingsState.minTeamSize = minTeamSize;
    settingsState.schoolName = schoolName;

    // Update on-site pricing settings
    pricingSettings.priceAssoMember = priceAssoMember;
    pricingSettings.priceNonMember = priceNonMember;
    pricingSettings.priceLate = priceLate;
    pricingSettings.lateCutoffTime = lateCutoffTime;

    // Update online payment settings
    pricingSettings.paymentEnabled = paymentEnabled;
    pricingSettings.priceTier1 = priceTier1;
    pricingSettings.priceTier2 = priceTier2;
    pricingSettings.tier1CutoffDays = tier1CutoffDays;
    pricingSettings.registrationDeadline = registrationDeadline;

    updateSaveButton();
    toastSuccess('Param√®tres enregistr√©s');
  } catch (err) {
    console.error('Error saving settings:', err);
    toastError(err.message || 'Erreur lors de la sauvegarde');
    updateSaveButton();
  }
}

// ============================================================
// IMPORT MODULE
// ============================================================

function initImport() {
  const fileInput = $('import-file');
  const importBtn = $('import-btn');

  if (fileInput) {
    fileInput.addEventListener('change', handleFileSelect);
  }

  if (importBtn) {
    importBtn.addEventListener('click', handleImport);
  }
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) {
    resetImport();
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    csvData = e.target.result;
    parseAndPreview(csvData);
  };
  reader.onerror = () => {
    toastError('Erreur lors de la lecture du fichier');
    resetImport();
  };
  reader.readAsText(file);
}

function parseAndPreview(csv) {
  try {
    const lines = csv.trim().split('\n');
    if (lines.length < 2) {
      throw new Error('Le fichier doit contenir au moins une ligne de donn√©es');
    }

    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    parsedRows = [];

    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLine(lines[i]);
      if (values.length === headers.length) {
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx].trim();
        });
        parsedRows.push(row);
      }
    }

    const teams = new Set(parsedRows.map(r => r.teamname || 'Sans √©quipe'));

    const preview = $('import-preview');
    const previewContent = $('import-preview-content');
    const importBtn = $('import-btn');
    const status = $('import-status');

    if (preview && previewContent) {
      previewContent.innerHTML = `
        <p><strong>${parsedRows.length}</strong> membres dans <strong>${teams.size}</strong> √©quipes</p>
        <table class="import-preview-table">
          <thead>
            <tr>
              <th>√âquipe</th>
              <th>Pr√©nom</th>
              <th>Nom</th>
              <th>Email</th>
            </tr>
          </thead>
          <tbody>
            ${parsedRows.slice(0, 5).map(row => `
              <tr>
                <td>${escapeHtml(row.teamname || '-')}</td>
                <td>${escapeHtml(row.firstname || '-')}</td>
                <td>${escapeHtml(row.lastname || '-')}</td>
                <td>${escapeHtml(row.email || '-')}</td>
              </tr>
            `).join('')}
            ${parsedRows.length > 5 ? `<tr><td colspan="4" style="text-align:center;color:var(--color-text-muted)">... et ${parsedRows.length - 5} autres</td></tr>` : ''}
          </tbody>
        </table>
      `;
      preview.classList.remove('hidden');
    }

    if (importBtn) {
      importBtn.disabled = false;
    }

    if (status) {
      status.textContent = '';
      status.className = 'import-status';
    }

  } catch (err) {
    toastError(err.message);
    resetImport();
  }
}

function parseCSVLine(line) {
  const values = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      values.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  values.push(current);

  return values;
}

async function handleImport() {
  if (!csvData) {
    toastError('Veuillez s√©lectionner un fichier');
    return;
  }

  const importBtn = $('import-btn');
  const status = $('import-status');

  if (importBtn) {
    importBtn.disabled = true;
    importBtn.textContent = 'Import en cours...';
  }

  if (status) {
    status.textContent = 'Import en cours...';
    status.className = 'import-status';
  }

  try {
    const result = await adminPost('/admin/import', { csv: csvData });

    if (result.success) {
      const { stats } = result;
      toastSuccess(`Import termin√©: ${stats.membersImported} membres, ${stats.teamsCreated} √©quipes cr√©√©es`);

      if (status) {
        status.innerHTML = `<span class="sf-symbol">@sfs:checkmark@</span> ${stats.membersImported} import√©s, ${stats.membersSkipped} ignor√©s, ${stats.teamsCreated} √©quipes cr√©√©es`;
        status.className = 'import-status success';
      }

      loadData();
    } else {
      throw new Error(result.error || 'Erreur lors de l\'import');
    }

  } catch (err) {
    console.error('Import error:', err);
    toastError(err.message || 'Erreur lors de l\'import');

    if (status) {
      status.innerHTML = `<span class="sf-symbol">@sfs:xmark@</span> Erreur: ${err.message}`;
      status.className = 'import-status error';
    }
  } finally {
    if (importBtn) {
      importBtn.disabled = false;
      importBtn.textContent = 'Importer';
    }
  }
}

function resetImport() {
  csvData = null;
  parsedRows = [];

  const preview = $('import-preview');
  const importBtn = $('import-btn');
  const status = $('import-status');

  if (preview) {
    preview.classList.add('hidden');
  }

  if (importBtn) {
    importBtn.disabled = true;
  }

  if (status) {
    status.textContent = '';
    status.className = 'import-status';
  }
}

// ============================================================
// ARCHIVES MODULE
// ============================================================

let archivesData = [];
let selectedArchive = null;

async function loadArchives() {
  try {
    const response = await api('/admin/archives');
    archivesData = response.archives || [];
    renderArchivesList();
    updateArchivesBadge();
  } catch (err) {
    console.error('Failed to load archives:', err);
    const container = $('archives-container');
    if (container) {
      container.innerHTML = '<div class="no-archives"><p>Erreur lors du chargement des archives</p></div>';
    }
  }
}

function updateArchivesBadge() {
  const badge = $('archives-badge');
  if (badge) {
    badge.textContent = archivesData.length;
    badge.classList.toggle('hidden', archivesData.length === 0);
  }
}

function renderArchivesList() {
  const container = $('archives-container');
  if (!container) return;

  if (archivesData.length === 0) {
    container.innerHTML = `
      <div class="no-archives">
        <p>üìÅ Aucune archive</p>
        <p>Cr√©ez une archive depuis l'onglet Param√®tres pour sauvegarder les donn√©es d'une √©dition.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = archivesData.map(archive => `
    <div class="archive-card ${archive.is_expired ? 'expired' : ''}" data-year="${archive.event_year}">
      <div class="archive-card-info">
        <h3 class="archive-card-year">√âdition ${archive.event_year}</h3>
        <div class="archive-card-stats">
          <span>üë• ${archive.total_teams} √©quipes</span>
          <span>üéì ${archive.total_participants} participants</span>
          ${archive.total_revenue ? `<span>üí∞ ${(archive.total_revenue / 100).toFixed(2)}‚Ç¨</span>` : ''}
        </div>
        <p class="archive-card-date">Archiv√© le ${new Date(archive.archived_at).toLocaleDateString('fr-FR')}</p>
      </div>
      <div class="archive-card-actions">
        <button type="button" class="btn btn-secondary btn-sm" onclick="viewArchive(${archive.event_year})">
          üëÅÔ∏è Consulter
        </button>
      </div>
    </div>
  `).join('');
}

async function viewArchive(year) {
  try {
    const response = await api(`/admin/archives/${year}`);
    selectedArchive = response.archive;
    renderArchiveDetail();
    
    // Show the detail section
    const detailSection = $('archive-detail');
    if (detailSection) {
      detailSection.classList.remove('hidden');
      detailSection.scrollIntoView({ behavior: 'smooth' });
    }
  } catch (err) {
    toastError('Erreur lors du chargement de l\'archive');
  }
}

function renderArchiveDetail() {
  if (!selectedArchive) return;

  // Update title
  const title = $('archive-detail-title');
  if (title) {
    title.textContent = `√âdition ${selectedArchive.event_year}`;
  }

  // Parse JSON data
  const teams = JSON.parse(selectedArchive.teams_json || '[]');
  const members = JSON.parse(selectedArchive.members_json || '[]');
  const stats = JSON.parse(selectedArchive.stats_json || '{}');

  // Render stats grid
  const statsGrid = $('archive-stats-grid');
  if (statsGrid) {
    statsGrid.innerHTML = `
      <div class="archive-stat-card">
        <div class="archive-stat-value">${selectedArchive.total_teams}</div>
        <div class="archive-stat-label">√âquipes</div>
      </div>
      <div class="archive-stat-card">
        <div class="archive-stat-value">${selectedArchive.total_participants}</div>
        <div class="archive-stat-label">Participants</div>
      </div>
      <div class="archive-stat-card">
        <div class="archive-stat-value">${(selectedArchive.total_revenue / 100).toFixed(2)}‚Ç¨</div>
        <div class="archive-stat-label">Revenus</div>
      </div>
      <div class="archive-stat-card">
        <div class="archive-stat-value">${new Date(selectedArchive.archived_at).toLocaleDateString('fr-FR')}</div>
        <div class="archive-stat-label">Date d'archivage</div>
      </div>
    `;
  }

  // Render teams table
  const teamsBody = $('archive-teams-tbody');
  if (teamsBody) {
    teamsBody.innerHTML = teams.map(team => `
      <tr>
        <td>${escapeHtml(team.name)}</td>
        <td>${team.member_count || '-'}</td>
        <td>${escapeHtml(team.room_name) || '-'}</td>
      </tr>
    `).join('');
  }

  // Render members table
  const membersBody = $('archive-members-tbody');
  if (membersBody) {
    membersBody.innerHTML = members.map(member => {
      const team = teams.find(t => t.id === member.team_id);
      return `
        <tr>
          <td>${escapeHtml(member.first_name)} ${escapeHtml(member.last_name)}</td>
          <td>${escapeHtml(member.email) || '<em>anonymis√©</em>'}</td>
          <td>${escapeHtml(team?.name) || '-'}</td>
          <td>BAC+${member.bac_level || 0}</td>
        </tr>
      `;
    }).join('');
  }

  // Show GDPR notice if expired
  const gdprNotice = $('archive-gdpr-notice');
  if (gdprNotice) {
    gdprNotice.classList.toggle('hidden', !selectedArchive.is_expired);
  }
}

function closeArchiveDetail() {
  const detailSection = $('archive-detail');
  if (detailSection) {
    detailSection.classList.add('hidden');
  }
  selectedArchive = null;
}

async function exportArchiveJson() {
  if (!selectedArchive) return;
  try {
    const response = await fetch(`${API_BASE}/api/admin/archives/${selectedArchive.event_year}/export?format=json`, {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    const data = await response.json();
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ndi-${selectedArchive.event_year}-archive.json`;
    a.click();
    URL.revokeObjectURL(url);
    toastSuccess('Export JSON t√©l√©charg√©');
  } catch (err) {
    toastError('Erreur lors de l\'export');
  }
}

async function exportArchiveZip() {
  if (!selectedArchive) return;
  try {
    const response = await fetch(`${API_BASE}/api/admin/archives/${selectedArchive.event_year}/export?format=zip`, {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    const blob = await response.blob();
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ndi-${selectedArchive.event_year}-archive.zip`;
    a.click();
    URL.revokeObjectURL(url);
    toastSuccess('Export ZIP t√©l√©charg√©');
  } catch (err) {
    toastError('Erreur lors de l\'export');
  }
}

async function createArchive() {
  const yearEl = $('current-event-year');
  const year = yearEl ? yearEl.textContent : new Date().getFullYear();
  
  if (!confirm(`Cr√©er une archive pour l'√©dition ${year} ?\n\nCette action sauvegardera toutes les donn√©es actuelles (√©quipes, participants, statistiques).`)) {
    return;
  }

  try {
    const response = await api('/admin/archives', {
      method: 'POST',
      body: JSON.stringify({ year: parseInt(year) })
    });
    
    toastSuccess(`Archive ${year} cr√©√©e avec succ√®s`);
    await loadArchives();
    await loadResetSafetyCheck();
  } catch (err) {
    if (err.message.includes('already exists')) {
      toastError(`Une archive pour ${year} existe d√©j√†`);
    } else if (err.message.includes('No data')) {
      toastError('Aucune donn√©e √† archiver');
    } else {
      toastError('Erreur lors de la cr√©ation de l\'archive');
    }
  }
}

async function checkExpiration() {
  const resultEl = $('expiration-result');
  try {
    const response = await api('/admin/expiration-check', { method: 'POST' });
    
    if (resultEl) {
      resultEl.classList.remove('hidden');
      if (response.updated > 0) {
        resultEl.className = 'result-text warning';
        resultEl.textContent = `${response.updated} archive(s) ont √©t√© anonymis√©es.`;
        await loadArchives();
      } else {
        resultEl.className = 'result-text success';
        resultEl.textContent = `${response.checked} archive(s) v√©rifi√©es. Aucune expiration.`;
      }
    }
  } catch (err) {
    if (resultEl) {
      resultEl.classList.remove('hidden');
      resultEl.className = 'result-text warning';
      resultEl.textContent = 'Erreur lors de la v√©rification';
    }
  }
}

async function loadResetSafetyCheck() {
  const container = $('reset-safety-check');
  const resetBtn = $('reset-data-btn');
  
  if (!container) return;

  try {
    const response = await api('/admin/reset/check');
    
    if (response.needsArchive) {
      container.className = 'reset-safety-check warning';
      container.innerHTML = `
        <p><strong><span class="sf-symbol">@sfs:exclamationmark.triangle@</span> Donn√©es non archiv√©es</strong></p>
        <p>Il y a actuellement ${response.teamsCount} √©quipes et ${response.membersCount} participants.</p>
        <p>Cr√©ez une archive avant de r√©initialiser pour ne pas perdre ces donn√©es.</p>
      `;
      if (resetBtn) resetBtn.disabled = true;
    } else if (response.hasData) {
      container.className = 'reset-safety-check safe';
      container.innerHTML = `
        <p><strong><span class="sf-symbol">@sfs:checkmark.circle@</span> Pr√™t √† r√©initialiser</strong></p>
        <p>Les donn√©es ont √©t√© archiv√©es. Vous pouvez r√©initialiser en toute s√©curit√©.</p>
        <p>Derni√®re archive : ${response.latestArchiveYear || 'N/A'}</p>
      `;
      if (resetBtn) resetBtn.disabled = false;
    } else {
      container.className = 'reset-safety-check safe';
      container.innerHTML = `
        <p><strong><span class="sf-symbol">@sfs:info.circle@</span> Aucune donn√©e</strong></p>
        <p>La base de donn√©es est vide. Rien √† r√©initialiser.</p>
      `;
      if (resetBtn) resetBtn.disabled = true;
    }
  } catch (err) {
    container.innerHTML = '<p>Erreur lors de la v√©rification</p>';
  }
}

async function loadEventInfo() {
  try {
    const response = await api('/admin/event-year');
    const yearEl = $('current-event-year');
    if (yearEl) {
      yearEl.textContent = response.year;
    }
    
    // Also update counts from current data
    const teamsEl = $('current-teams-count');
    const participantsEl = $('current-participants-count');
    if (teamsEl && teamsData) {
      teamsEl.textContent = teamsData.length;
    }
    if (participantsEl && membersData) {
      participantsEl.textContent = membersData.length;
    }
  } catch (err) {
    console.error('Failed to load event info:', err);
  }
}

async function resetData() {
  if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nVous √™tes sur le point de SUPPRIMER D√âFINITIVEMENT toutes les donn√©es :\n- Toutes les √©quipes\n- Tous les participants\n- Tous les paiements\n\nCette action est IRR√âVERSIBLE.\n\n√ätes-vous absolument s√ªr ?')) {
    return;
  }

  // Double confirmation
  const confirmText = prompt('Pour confirmer, tapez "SUPPRIMER" :');
  if (confirmText !== 'SUPPRIMER') {
    toastError('R√©initialisation annul√©e');
    return;
  }

  try {
    await api('/admin/reset', { method: 'POST' });
    toastSuccess('Donn√©es r√©initialis√©es avec succ√®s');
    await loadData();
    await loadResetSafetyCheck();
  } catch (err) {
    if (err.message.includes('archive')) {
      toastError('Cr√©ez d\'abord une archive avant de r√©initialiser');
    } else {
      toastError('Erreur lors de la r√©initialisation');
    }
  }
}

function initArchives() {
  // Refresh button
  const refreshBtn = $('refresh-archives-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadArchives);
  }

  // Close detail button
  const closeBtn = $('close-archive-detail-btn');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeArchiveDetail);
  }

  // Export buttons
  const exportJsonBtn = $('export-archive-json-btn');
  if (exportJsonBtn) {
    exportJsonBtn.addEventListener('click', exportArchiveJson);
  }

  const exportZipBtn = $('export-archive-zip-btn');
  if (exportZipBtn) {
    exportZipBtn.addEventListener('click', exportArchiveZip);
  }

  // Create archive button
  const createBtn = $('create-archive-btn');
  if (createBtn) {
    createBtn.addEventListener('click', createArchive);
  }

  // Check expiration button
  const expirationBtn = $('check-expiration-btn');
  if (expirationBtn) {
    expirationBtn.addEventListener('click', checkExpiration);
  }

  // Reset button
  const resetBtn = $('reset-data-btn');
  if (resetBtn) {
    resetBtn.addEventListener('click', resetData);
  }

  // Load initial data
  loadArchives();
  loadResetSafetyCheck();
  loadEventInfo();
}

// Make viewArchive available globally for onclick
window.viewArchive = viewArchive;

// ============================================================
// TAB NAVIGATION
// ============================================================

let activeTab = 'registrations';

function initTabs() {
  document.querySelectorAll('.tab-item').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });
}

function switchTab(tabId) {
  activeTab = tabId;

  // Update tab buttons
  document.querySelectorAll('.tab-item').forEach(tab => {
    const isActive = tab.dataset.tab === tabId;
    tab.classList.toggle('active', isActive);
    tab.setAttribute('aria-selected', isActive);
  });

  // Update panels
  document.querySelectorAll('.tab-panel').forEach(panel => {
    const isActive = panel.id === `panel-${tabId}`;
    panel.classList.toggle('hidden', !isActive);
  });

  // Load data when switching tabs
  if (tabId === 'attendance') {
    loadAttendanceData();
  } else if (tabId === 'pizza') {
    loadPizzaData();
  } else if (tabId === 'rooms') {
    loadRoomsData();
  }
}

// ============================================================
// ATTENDANCE MANAGEMENT
// ============================================================

let attendanceData = [];
let attendanceSearchTerm = '';
let attendanceFilter = 'all'; // 'all', 'present', 'absent'
let attendanceSortKey = 'name';
let attendanceSortDir = 'asc';

// Pricing settings (loaded from settings, defaults if not set)
let pricingSettings = {
  priceAssoMember: 500,   // cents
  priceNonMember: 800,    // cents
  priceLate: 1000,        // cents
  lateCutoffTime: '19:00' // HH:MM format
};
let checkInMemberId = null;

function formatCurrency(cents) {
  return (cents / 100).toLocaleString('fr-FR', {
    style: 'currency',
    currency: 'EUR'
  });
}

async function loadAttendanceData() {
  try {
    const data = await adminGet('/admin/attendance');
    attendanceData = data.members || [];
    renderAttendanceStats(data.stats);
    renderAttendance();
    updateAttendanceBadge(data.stats.checked_in);
  } catch (err) {
    console.error('Error loading attendance:', err);
    toastError('Erreur lors du chargement des pr√©sences');
  }
}

function renderAttendanceStats(stats) {
  const grid = $('attendance-stats-grid');
  if (!grid) return;

  const percentage = stats.total > 0 ? Math.round((stats.checked_in / stats.total) * 100) : 0;
  const payment = stats.payment || {};

  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.checked_in}</div>
      <div class="stat-label">Pr√©sents</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.not_checked_in}</div>
      <div class="stat-label">Absents</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total}</div>
      <div class="stat-label">Total inscrits</div>
    </div>
    <div class="stat-card stat-card-highlight">
      <div class="stat-value">${formatCurrency(payment.total_revenue || 0)}</div>
      <div class="stat-label">Recettes</div>
    </div>
  `;

  // Add payment breakdown if there are any payments
  if (payment.total_paid > 0) {
    const breakdownHtml = `
      <div class="stats-grid" style="margin-top: var(--space-4);">
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${payment.asso_members || 0}</div>
          <div class="stat-label">Membres asso</div>
          <div class="stat-sublabel">${formatCurrency(payment.asso_revenue || 0)}</div>
        </div>
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${payment.non_members || 0}</div>
          <div class="stat-label">Non-membres</div>
          <div class="stat-sublabel">${formatCurrency(payment.non_member_revenue || 0)}</div>
        </div>
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${payment.late_arrivals || 0}</div>
          <div class="stat-label">Retardataires</div>
          <div class="stat-sublabel">${formatCurrency(payment.late_revenue || 0)}</div>
        </div>
      </div>
    `;
    grid.insertAdjacentHTML('afterend', breakdownHtml);
  }
}

function renderAttendance() {
  const tbody = $('attendance-tbody');
  if (!tbody) return;

  let filtered = [...attendanceData];

  // Apply search filter
  if (attendanceSearchTerm) {
    const term = attendanceSearchTerm.toLowerCase();
    filtered = filtered.filter(m =>
      m.first_name.toLowerCase().includes(term) ||
      m.last_name.toLowerCase().includes(term) ||
      m.email.toLowerCase().includes(term) ||
      m.team_name.toLowerCase().includes(term)
    );
  }

  // Apply status filter
  if (attendanceFilter === 'present') {
    filtered = filtered.filter(m => m.checked_in === 1);
  } else if (attendanceFilter === 'absent') {
    filtered = filtered.filter(m => m.checked_in === 0 || m.checked_in === null);
  }

  // Apply sorting
  filtered.sort((a, b) => {
    let valA, valB;
    switch (attendanceSortKey) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'email':
        valA = a.email.toLowerCase();
        valB = b.email.toLowerCase();
        break;
      case 'team':
        valA = a.team_name.toLowerCase();
        valB = b.team_name.toLowerCase();
        break;
      case 'status':
        valA = a.checked_in || 0;
        valB = b.checked_in || 0;
        break;
      case 'time':
        valA = a.checked_in_at || '';
        valB = b.checked_in_at || '';
        break;
      case 'payment':
        valA = a.payment_tier || '';
        valB = b.payment_tier || '';
        break;
      default:
        valA = a.first_name.toLowerCase();
        valB = b.first_name.toLowerCase();
    }

    if (valA < valB) return attendanceSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return attendanceSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Aucun participant trouv√©</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(m => {
    const isCheckedIn = m.checked_in === 1;
    const checkedInTime = m.checked_in_at ? new Date(m.checked_in_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-';
    const teamInfo = formatTeamWithRoom(m.team_name, m.team_room, 40);

    // Payment badge - check for online payment status first, then on-site payment tier
    let paymentBadge = '<span class="badge badge-muted">-</span>';

    // Online payment status (new columns from payment integration)
    if (m.payment_status === 'paid') {
      // Paid online
      const tierLabels = { 'tier1': 'Anticip√©', 'tier2': 'Standard' };
      const tierLabel = tierLabels[m.registration_tier] || 'En ligne';
      const amount = m.payment_amount ? formatCurrency(m.payment_amount) : '';
      paymentBadge = `<span class="badge badge-success"><span class="sf-symbol">@sfs:creditcard@</span> ${tierLabel}</span>`;
      if (amount) {
        paymentBadge += ` <span class="text-muted text-sm">${amount}</span>`;
      }
    } else if (m.payment_status === 'delayed') {
      // Chose to pay on-site
      paymentBadge = '<span class="badge badge-warning"><span class="sf-symbol">@sfs:calendar@</span> √Ä payer</span>';
    } else if (m.payment_status === 'pending') {
      // Payment in progress
      paymentBadge = '<span class="badge badge-info"><span class="sf-symbol">@sfs:hourglass@</span> En cours</span>';
    } else if (m.payment_tier) {
      // On-site payment (existing logic for backward compatibility)
      const tierLabels = {
        'asso_member': '<span class="sf-symbol">@sfs:checkmark@</span> Membre asso',
        'non_member': '<span class="sf-symbol">@sfs:checkmark@</span> Non-membre',
        'late': '<span class="sf-symbol">@sfs:clock@</span> Retardataire'
      };
      const tierLabel = tierLabels[m.payment_tier] || m.payment_tier;
      const amount = m.payment_amount ? formatCurrency(m.payment_amount) : '';
      paymentBadge = `<span class="badge badge-success">${tierLabel}</span>`;
      if (amount) {
        paymentBadge += ` <span class="text-muted text-sm">${amount}</span>`;
      }
    }

    return `
      <tr class="member-row ${isCheckedIn ? 'checked-in' : ''}" data-member-id="${m.id}">
        <td><strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong></td>
        <td><a href="mailto:${escapeHtml(m.email)}">${escapeHtml(m.email)}</a></td>
        <td class="team-col" title="${escapeHtml(teamInfo.full)}">${escapeHtml(teamInfo.truncated)}</td>
        <td class="status-col">
          ${isCheckedIn
            ? '<span class="badge badge-success">ÙÄÅ£ Pr√©sent</span>'
            : '<span class="badge badge-muted">ÙÄÅ° Absent</span>'}
        </td>
        <td class="time-col">${checkedInTime}</td>
        <td>${paymentBadge}</td>
        <td class="actions-col">
          <div class="action-buttons">
            ${isCheckedIn
              ? `<button type="button" class="icon-btn danger" onclick="handleCheckOut(${m.id})" title="Annuler la pr√©sence" aria-label="Annuler la pr√©sence">ÙÄÅ°</button>`
              : `<button type="button" class="icon-btn success" onclick="handleCheckIn(${m.id})" title="Valider la pr√©sence" aria-label="Valider la pr√©sence">ÙÄÅ£</button>`}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function updateAttendanceBadge(count) {
  const badge = $('attendance-badge');
  if (badge) badge.textContent = count || 0;
}

window.handleCheckIn = async function(memberId) {
  const member = attendanceData.find(m => m.id === memberId);
  if (!member) return;

  // If member already paid online, skip the payment modal and check in directly
  if (member.payment_status === 'paid') {
    try {
      await adminPost(`/admin/attendance/check-in/${memberId}`, {
        paymentTier: member.registration_tier === 'tier1' ? 'online_tier1' : 'online_tier2',
        paymentAmount: member.payment_amount,
        skipPayment: true  // Indicate payment was already collected online
      });
      await loadAttendanceData();
      toastSuccess(`${member.first_name} ${member.last_name} enregistr√©(e) (d√©j√† pay√© en ligne)`);
    } catch (err) {
      console.error('Error checking in:', err);
      toastError(err.message || 'Erreur lors de l\'enregistrement');
    }
    return;
  }

  checkInMemberId = memberId;
  $('checkin-member-id').value = memberId;
  $('checkin-member-name').textContent = `${member.first_name} ${member.last_name}`;

  // Check if after cutoff time
  const now = new Date();
  const [hours, minutes] = pricingSettings.lateCutoffTime.split(':').map(Number);
  const cutoff = new Date();
  cutoff.setHours(hours, minutes, 0, 0);
  const isAfterCutoff = now >= cutoff;

  // Show/hide late option based on cutoff
  const lateOption = $('option-late');
  const nonMemberOption = $('option-non-member');

  if (isAfterCutoff) {
    // After cutoff: show asso + late, hide non-member
    lateOption.classList.remove('hidden');
    nonMemberOption.classList.add('hidden');
  } else {
    // Before cutoff: show asso + non-member, hide late
    lateOption.classList.add('hidden');
    nonMemberOption.classList.remove('hidden');
  }

  // Update prices display
  $('price-asso').textContent = formatCurrency(pricingSettings.priceAssoMember);
  $('price-non-member').textContent = formatCurrency(pricingSettings.priceNonMember);
  $('price-late').textContent = formatCurrency(pricingSettings.priceLate);

  // If member chose delayed payment, show a message and pre-select a tier
  if (member.payment_status === 'delayed') {
    $('checkin-member-name').textContent = `${member.first_name} ${member.last_name} (paiement sur place)`;
  }

  // Reset to asso member option
  document.querySelector('input[name="payment-tier"][value="asso_member"]').checked = true;

  openModal('checkin-modal');
};

window.confirmCheckIn = async function() {
  const tier = document.querySelector('input[name="payment-tier"]:checked').value;
  let amount;

  switch (tier) {
    case 'asso_member':
      amount = pricingSettings.priceAssoMember;
      break;
    case 'non_member':
      amount = pricingSettings.priceNonMember;
      break;
    case 'late':
      amount = pricingSettings.priceLate;
      break;
  }

  try {
    await adminPost(`/admin/attendance/check-in/${checkInMemberId}`, {
      paymentTier: tier,
      paymentAmount: amount
    });
    closeModal('checkin-modal');
    await loadAttendanceData();
    toastSuccess(`Pr√©sence valid√©e - ${formatCurrency(amount)}`);
  } catch (err) {
    console.error('Error checking in:', err);
    toastError('Erreur lors de la validation');
  }
};

window.handleCheckOut = async function(memberId) {
  try {
    await adminPost(`/admin/attendance/check-out/${memberId}`);
    await loadAttendanceData();
    toastSuccess('Pr√©sence annul√©e');
  } catch (err) {
    console.error('Error checking out:', err);
    toastError('Erreur lors de l\'annulation');
  }
};

function initAttendance() {
  const searchInput = $('attendance-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      attendanceSearchTerm = e.target.value;
      renderAttendance();
    });
  }

  // Filter pills
  const filterRadios = document.querySelectorAll('input[name="attendance-filter"]');
  filterRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      attendanceFilter = e.target.value;
      updateFilterPills();
      renderAttendance();
    });
  });

  // Sortable headers
  const sortableHeaders = document.querySelectorAll('#attendance-table .sortable-header');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.dataset.sort;
      if (attendanceSortKey === sortKey) {
        attendanceSortDir = attendanceSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        attendanceSortKey = sortKey;
        attendanceSortDir = 'asc';
      }
      updateSortIndicators();
      renderAttendance();
    });
  });

  const refreshBtn = $('refresh-attendance-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadAttendanceData);
  }

  // Initialize filter pills state
  updateFilterPills();
}

function updateFilterPills() {
  const pills = document.querySelectorAll('.filter-pill');
  pills.forEach(pill => {
    const radio = pill.querySelector('input[type="radio"]');
    if (radio?.checked) {
      pill.classList.add('active');
    } else {
      pill.classList.remove('active');
    }
  });
}

function updateSortIndicators() {
  const headers = document.querySelectorAll('#attendance-table .sortable-header');
  headers.forEach(header => {
    const sortKey = header.dataset.sort;
    if (sortKey === attendanceSortKey) {
      header.setAttribute('data-sort-dir', attendanceSortDir);
      header.querySelector('.sort-indicator').textContent = attendanceSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      header.removeAttribute('data-sort-dir');
      header.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });
}

// ============================================================
// PIZZA DISTRIBUTION MANAGEMENT
// ============================================================

let pizzaData = [];
let pizzaSearchTerm = '';
let pizzaFilter = 'all'; // 'all', 'pending', 'received', 'checkedin'
let pizzaTypeFilter = '';
let pizzaSortKey = 'name';
let pizzaSortDir = 'asc';
let pizzaTypes = {}; // { id: name } mapping from settings

async function loadPizzaData() {
  try {
    const data = await adminGet('/admin/pizza');
    pizzaData = data.members || [];
    renderPizzaStats(data.stats);
    renderPizza();
    updatePizzaBadge(data.stats.pending);
  } catch (err) {
    console.error('Error loading pizza data:', err);
    toastError('Erreur lors du chargement des pizzas');
  }
}

function renderPizzaStats(stats) {
  // All members stats
  const grid = $('pizza-stats-grid');
  if (!grid) return;

  const percentage = stats.total > 0 ? Math.round((stats.received / stats.total) * 100) : 0;

  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${stats.received}</div>
      <div class="stat-label">Servis</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.pending}</div>
      <div class="stat-label">En attente</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${stats.total}</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${percentage}%</div>
      <div class="stat-label">Progression</div>
    </div>
  `;

  // By type stats (all members)
  const typeGrid = $('pizza-by-type-grid');
  if (typeGrid && stats.by_type && stats.by_type.length > 0) {
    typeGrid.innerHTML = stats.by_type.map(t => {
      const toServe = t.total - t.received;
      return `
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${t.total}</div>
          <div class="stat-label">${pizzaTypes[t.food_diet] || t.food_diet}</div>
          <div class="stat-sublabel">${t.received} servis${toServe > 0 ? `, ${toServe} restants` : ''}</div>
        </div>
      `;
    }).join('');
  }

  // Present members stats
  const presentGrid = $('pizza-present-stats-grid');
  if (presentGrid && stats.present) {
    const present = stats.present;
    const presentPercentage = present.total > 0 ? Math.round((present.received / present.total) * 100) : 0;

    presentGrid.innerHTML = `
      <div class="stat-card">
        <div class="stat-value">${present.received}</div>
        <div class="stat-label">Servis</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${present.pending}</div>
        <div class="stat-label">√Ä servir</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${present.total}</div>
        <div class="stat-label">Pr√©sents</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${presentPercentage}%</div>
        <div class="stat-label">Progression</div>
      </div>
    `;
  }

  // By type stats (present members only) - show total present and how many still need pizza
  const presentTypeGrid = $('pizza-present-by-type-grid');
  if (presentTypeGrid && stats.present?.by_type && stats.present.by_type.length > 0) {
    presentTypeGrid.innerHTML = stats.present.by_type.map(t => {
      const toServe = t.total - t.received;
      return `
        <div class="stat-card stat-card-sm">
          <div class="stat-value">${t.total}</div>
          <div class="stat-label">${pizzaTypes[t.food_diet] || t.food_diet}</div>
          <div class="stat-sublabel">${toServe > 0 ? `${toServe} √† servir` : 'Tous servis'}</div>
        </div>
      `;
    }).join('');
  }
}

function renderPizza() {
  const tbody = $('pizza-tbody');
  if (!tbody) return;

  let filtered = [...pizzaData];

  // Apply search filter
  if (pizzaSearchTerm) {
    const term = pizzaSearchTerm.toLowerCase();
    filtered = filtered.filter(m =>
      m.first_name.toLowerCase().includes(term) ||
      m.last_name.toLowerCase().includes(term) ||
      m.email.toLowerCase().includes(term) ||
      (m.team_name || '').toLowerCase().includes(term)
    );
  }

  // Apply status filter
  if (pizzaFilter === 'pending') {
    filtered = filtered.filter(m => m.pizza_received === 0 || m.pizza_received === null);
  } else if (pizzaFilter === 'received') {
    filtered = filtered.filter(m => m.pizza_received === 1);
  } else if (pizzaFilter === 'checkedin') {
    filtered = filtered.filter(m => m.checked_in === 1);
  }

  // Apply pizza type filter
  if (pizzaTypeFilter) {
    filtered = filtered.filter(m => m.food_diet === pizzaTypeFilter);
  }

  // Apply sorting
  filtered.sort((a, b) => {
    let valA, valB;
    switch (pizzaSortKey) {
      case 'name':
        valA = `${a.first_name} ${a.last_name}`.toLowerCase();
        valB = `${b.first_name} ${b.last_name}`.toLowerCase();
        break;
      case 'team':
        valA = (a.team_name || '').toLowerCase();
        valB = (b.team_name || '').toLowerCase();
        break;
      case 'pizza':
        valA = a.food_diet || '';
        valB = b.food_diet || '';
        break;
      case 'checkin':
        valA = a.checked_in || 0;
        valB = b.checked_in || 0;
        break;
      case 'status':
        valA = a.pizza_received || 0;
        valB = b.pizza_received || 0;
        break;
      case 'time':
        valA = a.pizza_received_at || '';
        valB = b.pizza_received_at || '';
        break;
      default:
        valA = a.first_name.toLowerCase();
        valB = b.first_name.toLowerCase();
    }

    if (valA < valB) return pizzaSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return pizzaSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Aucun participant trouv√©</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(m => {
    const isPizzaReceived = m.pizza_received === 1;
    const isCheckedIn = m.checked_in === 1;
    const pizzaTime = m.pizza_received_at ? new Date(m.pizza_received_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '-';
    const teamInfo = formatTeamWithRoom(m.team_name, m.team_room, 40);

    return `
      <tr class="member-row ${isPizzaReceived ? 'checked-in' : ''}" data-member-id="${m.id}">
        <td><strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong></td>
        <td class="team-col" title="${escapeHtml(teamInfo.full)}">${escapeHtml(teamInfo.truncated)}</td>
        <td>${pizzaTypes[m.food_diet] || escapeHtml(m.food_diet) || '-'}</td>
        <td class="status-col">
          ${isCheckedIn
            ? '<span class="badge badge-success">Pr√©sent</span>'
            : '<span class="badge badge-muted">Absent</span>'}
        </td>
        <td class="status-col">
          ${isPizzaReceived
            ? '<span class="badge badge-success">ÙÄÅ£ Servi</span>'
            : '<span class="badge badge-muted">ÙÄÅ° En attente</span>'}
        </td>
        <td class="time-col">${pizzaTime}</td>
        <td class="actions-col">
          <div class="action-buttons">
            ${isPizzaReceived
              ? `<button type="button" class="icon-btn danger" onclick="handleRevokePizza(${m.id})" title="Annuler" aria-label="Annuler la distribution">ÙÄÅ°</button>`
              : `<button type="button" class="icon-btn success" onclick="handleGivePizza(${m.id})" title="Donner pizza" aria-label="Donner pizza">ÙÄÅ£</button>`}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function updatePizzaBadge(pending) {
  const badge = $('pizza-badge');
  if (badge) badge.textContent = pending || 0;
}

window.handleGivePizza = async function(memberId) {
  try {
    await adminPost(`/admin/pizza/give/${memberId}`);
    await loadPizzaData();
    toastSuccess('Pizza distribu√©e');
  } catch (err) {
    console.error('Error giving pizza:', err);
    toastError('Erreur lors de la distribution');
  }
};

window.handleRevokePizza = async function(memberId) {
  try {
    await adminPost(`/admin/pizza/revoke/${memberId}`);
    await loadPizzaData();
    toastSuccess('Distribution annul√©e');
  } catch (err) {
    console.error('Error revoking pizza:', err);
    toastError('Erreur lors de l\'annulation');
  }
};

function initPizza() {
  // Load pizza types from settings
  if (settingsState.pizzas) {
    settingsState.pizzas.forEach(p => { pizzaTypes[p.id] = p.name; });
  }

  // Also try from pizzasConfig
  if (pizzasConfig && pizzasConfig.length > 0) {
    pizzasConfig.forEach(p => { pizzaTypes[p.id] = p.name; });
  }

  // Populate type filter
  const typeFilter = $('pizza-type-filter');
  if (typeFilter) {
    const pizzaList = settingsState.pizzas || pizzasConfig || [];
    typeFilter.innerHTML = '<option value="">Toutes les pizzas</option>' +
      pizzaList.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('');
  }

  // Search
  const searchInput = $('pizza-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      pizzaSearchTerm = e.target.value;
      renderPizza();
    });
  }

  // Filter pills
  const filterRadios = document.querySelectorAll('input[name="pizza-filter"]');
  filterRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      pizzaFilter = e.target.value;
      updatePizzaFilterPills();
      renderPizza();
    });
  });

  // Type filter
  const typeFilterSelect = $('pizza-type-filter');
  if (typeFilterSelect) {
    typeFilterSelect.addEventListener('change', (e) => {
      pizzaTypeFilter = e.target.value;
      renderPizza();
    });
  }

  // Sortable headers
  const sortableHeaders = document.querySelectorAll('#pizza-table .sortable-header');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.dataset.sort;
      if (pizzaSortKey === sortKey) {
        pizzaSortDir = pizzaSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        pizzaSortKey = sortKey;
        pizzaSortDir = 'asc';
      }
      updatePizzaSortIndicators();
      renderPizza();
    });
  });

  // Refresh button
  const refreshBtn = $('refresh-pizza-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadPizzaData);
  }

  // Initialize filter pills state
  updatePizzaFilterPills();
}

function updatePizzaFilterPills() {
  document.querySelectorAll('[id^="pizza-filter-"]').forEach(pill => {
    const radio = pill.querySelector('input[type="radio"]');
    if (radio?.checked) {
      pill.classList.add('active');
    } else {
      pill.classList.remove('active');
    }
  });
}

function updatePizzaSortIndicators() {
  const headers = document.querySelectorAll('#pizza-table .sortable-header');
  headers.forEach(header => {
    const sortKey = header.dataset.sort;
    if (sortKey === pizzaSortKey) {
      header.setAttribute('data-sort-dir', pizzaSortDir);
      header.querySelector('.sort-indicator').textContent = pizzaSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      header.removeAttribute('data-sort-dir');
      header.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });
}

// ============================================================
// ROOM MANAGEMENT
// ============================================================

let roomsData = [];
let roomsSearchTerm = '';
let roomsFilter = 'all';
let roomsSortKey = 'name';
let roomsSortDir = 'asc';
let availableRooms = [];

async function loadRoomsData() {
  try {
    const data = await adminGet('/admin/rooms');
    roomsData = data.teams || [];
    availableRooms = data.rooms || [];
    renderRoomsStats(data.stats);
    renderPizzaByRoom(data.pizza_by_room || []);
    renderRooms();
    updateRoomsBadge(data.stats?.unassigned_teams || 0);
  } catch (err) {
    console.error('Error loading rooms data:', err);
    toastError('Erreur lors du chargement des salles');
  }
}

function renderPizzaByRoom(pizzaByRoom) {
  const container = $('room-pizza-container');
  if (!container) return;

  if (!pizzaByRoom || pizzaByRoom.length === 0) {
    container.innerHTML = '<p class="text-muted">Aucune salle avec des √©quipes assign√©es</p>';
    return;
  }

  container.innerHTML = pizzaByRoom.map(room => `
    <div class="room-pizza-block" style="margin-bottom: var(--space-4); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md);">
      <h4 style="margin-bottom: var(--space-3); display: flex; align-items: center; gap: var(--space-2);">
        <span>${escapeHtml(room.room)}</span>
        <span class="badge badge-muted">${room.totals.total} inscrits</span>
        <span class="badge badge-success">${room.totals.present} pr√©sents</span>
      </h4>
      <div class="stats-grid">
        ${room.pizzas.map(p => `
          <div class="stat-card stat-card-sm">
            <div class="stat-value">${p.total}</div>
            <div class="stat-label">${pizzaTypes[p.food_diet] || p.food_diet}</div>
            <div class="stat-sublabel">${p.present} pr√©sents</div>
          </div>
        `).join('')}
        <div class="stat-card stat-card-sm" style="background: var(--bg-tertiary);">
          <div class="stat-value">${room.totals.total}</div>
          <div class="stat-label">Total</div>
          <div class="stat-sublabel">${room.totals.present} pr√©sents</div>
        </div>
      </div>
    </div>
  `).join('');
}

function renderRoomsStats(stats) {
  const grid = $('room-stats-grid');
  if (!grid) return;

  const assigned = stats?.assigned_teams || 0;
  const unassigned = stats?.unassigned_teams || 0;
  const total = stats?.total_teams || 0;
  const percent = total > 0 ? Math.round((assigned / total) * 100) : 0;

  grid.innerHTML = `
    <div class="stat-card">
      <span class="stat-value">${assigned}</span>
      <span class="stat-label">√âquipes assign√©es</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${unassigned}</span>
      <span class="stat-label">Non assign√©es</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${total}</span>
      <span class="stat-label">Total √©quipes</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${percent}%</span>
      <span class="stat-label">Progression</span>
    </div>
  `;

  // By room stats
  const byRoomGrid = $('room-by-room-grid');
  if (byRoomGrid && stats?.by_room?.length > 0) {
    byRoomGrid.innerHTML = stats.by_room.map(r => `
      <div class="stat-card stat-card-sm">
        <span class="stat-value">${r.team_count}</span>
        <span class="stat-label">${escapeHtml(r.room)}</span>
        <span class="stat-sublabel">${r.member_count} membres</span>
      </div>
    `).join('');
  } else if (byRoomGrid) {
    byRoomGrid.innerHTML = '';
  }
}

function renderRooms() {
  const tbody = $('rooms-tbody');
  if (!tbody) return;

  let filtered = [...roomsData];

  // Search filter
  if (roomsSearchTerm) {
    filtered = filtered.filter(t =>
      t.name.toLowerCase().includes(roomsSearchTerm) ||
      (t.room || '').toLowerCase().includes(roomsSearchTerm)
    );
  }

  // Status filter
  if (roomsFilter === 'assigned') {
    filtered = filtered.filter(t => t.room && t.room !== '');
  } else if (roomsFilter === 'unassigned') {
    filtered = filtered.filter(t => !t.room || t.room === '');
  }

  // Sort
  filtered.sort((a, b) => {
    let valA, valB;
    switch (roomsSortKey) {
      case 'name':
        valA = a.name.toLowerCase();
        valB = b.name.toLowerCase();
        break;
      case 'members':
        valA = a.member_count || 0;
        valB = b.member_count || 0;
        break;
      case 'room':
        valA = (a.room || '').toLowerCase();
        valB = (b.room || '').toLowerCase();
        break;
      default:
        valA = a.name.toLowerCase();
        valB = b.name.toLowerCase();
    }

    if (valA < valB) return roomsSortDir === 'asc' ? -1 : 1;
    if (valA > valB) return roomsSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Aucune √©quipe trouv√©e</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(t => {
    const hasRoom = t.room && t.room !== '';
    const roomOptions = availableRooms
      .filter(r => r !== t.room)
      .map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`)
      .join('');

    return `
      <tr class="member-row ${hasRoom ? 'checked-in' : ''}" data-team-id="${t.id}">
        <td class="team-col" title="${escapeHtml(t.name)}">${escapeHtml(truncateText(t.name, 40))}</td>
        <td>${t.member_count || 0}</td>
        <td>
          <div class="room-input-wrapper">
            <input type="text"
                   class="room-input"
                   value="${escapeHtml(t.room || '')}"
                   placeholder="Salle..."
                   list="room-datalist-${t.id}"
                   data-team-id="${t.id}"
                   onchange="handleRoomChange(${t.id}, this.value)"
                   style="width: 120px; padding: 4px 8px; font-size: var(--text-sm); border: 1px solid var(--border-default); border-radius: var(--radius);">
            <datalist id="room-datalist-${t.id}">
              ${roomOptions}
            </datalist>
          </div>
        </td>
        <td class="actions-col">
          <div class="action-buttons">
            ${hasRoom
              ? `<button type="button" class="icon-btn danger" onclick="handleClearRoom(${t.id})" title="Retirer de la salle" aria-label="Retirer de la salle"><span class="sf-symbol">@sfs:xmark@</span></button>`
              : ''}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

window.handleRoomChange = async function(teamId, room) {
  try {
    await adminPut(`/admin/rooms/${teamId}`, { room: room || null });
    await loadRoomsData();
    toastSuccess(room ? `√âquipe assign√©e √† ${room}` : 'Salle retir√©e');
  } catch (err) {
    console.error('Error setting room:', err);
    toastError('Erreur lors de l\'assignation');
  }
};

window.handleClearRoom = async function(teamId) {
  try {
    await adminPut(`/admin/rooms/${teamId}`, { room: null });
    await loadRoomsData();
    toastSuccess('Salle retir√©e');
  } catch (err) {
    console.error('Error clearing room:', err);
    toastError('Erreur lors de la suppression');
  }
};

function updateRoomsBadge(unassigned) {
  const badge = $('rooms-badge');
  if (badge) badge.textContent = unassigned || 0;
}

function initRooms() {
  // Search
  const searchInput = $('rooms-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      roomsSearchTerm = e.target.value.toLowerCase();
      renderRooms();
    });
  }

  // Filter pills
  document.querySelectorAll('input[name="rooms-filter"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      roomsFilter = e.target.value;
      updateRoomsFilterPills();
      renderRooms();
    });
  });

  // Sortable headers
  const sortableHeaders = document.querySelectorAll('#rooms-table .sortable-header');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.dataset.sort;
      if (roomsSortKey === sortKey) {
        roomsSortDir = roomsSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        roomsSortKey = sortKey;
        roomsSortDir = 'asc';
      }
      updateRoomsSortIndicators();
      renderRooms();
    });
  });

  // Refresh button
  const refreshBtn = $('refresh-rooms-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', loadRoomsData);
  }

  updateRoomsFilterPills();
}

function updateRoomsFilterPills() {
  document.querySelectorAll('[id^="rooms-filter-"]').forEach(pill => {
    const radio = pill.querySelector('input[type="radio"]');
    if (radio?.checked) {
      pill.classList.add('active');
    } else {
      pill.classList.remove('active');
    }
  });
}

function updateRoomsSortIndicators() {
  const headers = document.querySelectorAll('#rooms-table .sortable-header');
  headers.forEach(header => {
    const sortKey = header.dataset.sort;
    if (sortKey === roomsSortKey) {
      header.setAttribute('data-sort-dir', roomsSortDir);
      header.querySelector('.sort-indicator').textContent = roomsSortDir === 'asc' ? '@sfs:chevron.up@' : '@sfs:chevron.down@';
    } else {
      header.removeAttribute('data-sort-dir');
      header.querySelector('.sort-indicator').textContent = '@sfs:arrow.up.arrow.down@';
    }
  });
}

// ============================================================
// TEAMS SEARCH
// ============================================================

let teamsSearchTerm = '';

function initTeamsSearch() {
  const searchInput = $('teams-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      teamsSearchTerm = e.target.value.toLowerCase();
      filterTeams();
    });
  }
}

function filterTeams() {
  const container = $('teams-container');
  if (!container) return;

  const teamBlocks = container.querySelectorAll('.team-block');

  teamBlocks.forEach(block => {
    const teamName = block.querySelector('.team-header h3')?.textContent.toLowerCase() || '';
    const memberNames = Array.from(block.querySelectorAll('.member-row td:nth-child(2)')).map(td => td.textContent.toLowerCase());
    const memberEmails = Array.from(block.querySelectorAll('.member-row td:nth-child(3)')).map(td => td.textContent.toLowerCase());

    const matchesTeam = teamName.includes(teamsSearchTerm);
    const matchesMember = memberNames.some(name => name.includes(teamsSearchTerm)) ||
                          memberEmails.some(email => email.includes(teamsSearchTerm));

    if (teamsSearchTerm === '' || matchesTeam || matchesMember) {
      block.style.display = '';
      // If search matches a member, expand the team
      if (matchesMember && teamsSearchTerm !== '') {
        block.classList.add('open');
      }
    } else {
      block.style.display = 'none';
    }
  });
}

// ============================================================
// INITIALIZE
// ============================================================

async function init() {
  elements.authBtn.addEventListener('click', handleAuth);
  elements.tokenInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleAuth();
  });
  elements.exportOfficialBtn.addEventListener('click', handleExportOfficial);
  elements.exportAllBtn.addEventListener('click', handleExportAll);
  elements.refreshBtn.addEventListener('click', handleRefresh);
  elements.addTeamBtn.addEventListener('click', openAddTeamModal);
  elements.addMemberBtn.addEventListener('click', openAddMemberModal);
  elements.selectAllBtn.addEventListener('click', selectAllParticipants);
  elements.deleteSelectedBtn.addEventListener('click', deleteSelectedMembers);
  elements.teamForm.addEventListener('submit', handleTeamSubmit);
  elements.memberForm.addEventListener('submit', handleMemberSubmit);

  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  });

  // Initialize tabs and search
  initTabs();
  initTeamsSearch();
  initAttendance();
  initPizza();
  initRooms();

  if (adminToken) {
    try {
      await loadData();
      showAdmin();
      initSettings();
      initImport();
      initAllParticipants();
      initArchives();
    } catch (err) {
      showAuth();
      if (err.message === 'Unauthorized') {
        localStorage.removeItem('ndi_admin_token');
        adminToken = '';
      }
    }
  } else {
    showAuth();
  }
}

window.loadData = loadData;

init();
</script>
</AdminLayout>
