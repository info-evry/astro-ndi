---
import BaseLayout from '../layouts/BaseLayout.astro';
import Badge from '../../design/src/components/Badge.astro';
import ndiEvent from '../../knowledge/src/ndi/event.json';
import ndiInfoEvry from '../../knowledge/src/ndi/info-evry.json';

// Format date helper
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('fr-FR', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

function formatTime(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleTimeString('fr-FR', {
    hour: '2-digit',
    minute: '2-digit'
  });
}
---

<BaseLayout title="Nuit de l'Info - Inscription - Asso Info Evry">
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-bg">
      <div class="orb orb-blue"></div>
      <div class="orb orb-purple"></div>
      <div class="orb orb-indigo"></div>
      <div class="grid-overlay"></div>
    </div>

    <div class="hero-content container">
      <Badge text={ndiEvent.edition} variant="hero" showDot animated />

      <h1 class="hero-title large">
        <span class="title-line">Nuit de</span>
        <span class="title-line gradient-text">l'Info</span>
      </h1>

      <p class="hero-description">
        {ndiEvent.tagline}
      </p>

      <!-- Event Date/Time -->
      <div class="hero-datetime">
        <div class="datetime-item">
          <span class="datetime-icon">&#128197;</span>
          <span>{ndiEvent.dates.startLabel}</span>
        </div>
        <div class="datetime-item">
          <span class="datetime-icon">&#9203;</span>
          <span>Durée : {ndiEvent.dates.duration}</span>
        </div>
        <div class="datetime-item">
          <span class="datetime-icon">&#128205;</span>
          <span>{ndiInfoEvry.site.location}</span>
        </div>
      </div>

      <!-- Modern KPI Stats -->
      <div id="hero-stats" class="hero-stats">
        <div class="kpi-card">
          <span class="kpi-value" id="kpi-teams">-</span>
          <span class="kpi-label">équipes</span>
        </div>
        <div class="kpi-divider"></div>
        <div class="kpi-card">
          <span class="kpi-value" id="kpi-participants">-</span>
          <span class="kpi-label">participants</span>
        </div>
        <div class="kpi-divider"></div>
        <div class="kpi-card">
          <span class="kpi-value" id="kpi-spots">-</span>
          <span class="kpi-label">places restantes</span>
        </div>
      </div>

      <div class="hero-actions">
        <a href="#inscription" id="hero-register-btn" class="btn btn-primary btn-lg">
          S'inscrire maintenant
        </a>
        <a href="#about" class="btn btn-secondary btn-lg">
          En savoir plus
        </a>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <!-- About Section -->
      <section id="about" class="content-section">
        <h2>Qu'est-ce que la Nuit de l'Info ?</h2>
        <div class="info-grid">
          <div class="info-card glass-card">
            <div class="info-card-icon">&#127942;</div>
            <h3>Le Concept</h3>
            <p>{ndiEvent.description}</p>
          </div>
          <div class="info-card glass-card">
            <div class="info-card-icon">&#128188;</div>
            <h3>Les Défis</h3>
            <p>{ndiInfoEvry.challenges.official.description}. Chaque équipe peut participer à maximum {ndiEvent.structure.maxChallenges} défis.</p>
          </div>
          <div class="info-card glass-card">
            <div class="info-card-icon">&#127828;</div>
            <h3>Sur Place</h3>
            <p>{ndiInfoEvry.amenities.food.description}. {ndiInfoEvry.amenities.networking.description}.</p>
          </div>
        </div>

        <!-- Stats from last year -->
        <div class="last-year-stats">
          <p class="stats-label">Édition {ndiEvent.stats.sinceYear + (2024 - 2007)} :</p>
          <div class="stats-row">
            <span><strong>{ndiEvent.stats.participants2024.toLocaleString('fr-FR')}</strong> participants</span>
            <span class="stats-sep">•</span>
            <span><strong>{ndiEvent.stats.teams2024}</strong> équipes</span>
            <span class="stats-sep">•</span>
            <span><strong>{ndiEvent.stats.sites2024}</strong> sites en France</span>
          </div>
        </div>
      </section>

      <!-- Association Challenge -->
      <section id="defi-asso" class="content-section">
        <h2>Défi de l'Asso</h2>
        <div class="challenge-card glass-card">
          <div class="challenge-header">
            <span class="challenge-badge">Asso Info Evry</span>
            <h3>{ndiInfoEvry.challenges.association.type}</h3>
          </div>
          <p class="challenge-desc">{ndiInfoEvry.challenges.association.description}</p>

          <div class="categories-grid">
            {ndiInfoEvry.challenges.association.categories.map((cat: {id: string, name: string, description: string}) => (
              <div class="category-item">
                <span class="category-name">{cat.name}</span>
                <span class="category-desc">{cat.description}</span>
              </div>
            ))}
          </div>

          <div class="challenge-rules">
            <h4>Règles</h4>
            <ul>
              {ndiInfoEvry.challenges.association.rules.map((rule: string) => (
                <li>{rule}</li>
              ))}
            </ul>
          </div>
        </div>
      </section>

      <!-- Pricing Section -->
      <section id="tarifs" class="content-section">
        <h2>Tarifs</h2>
        <div class="pricing-grid">
          <div class="pricing-card glass-card">
            <div class="pricing-amount">{ndiInfoEvry.registration.prices.member.amount}€</div>
            <div class="pricing-label">Adhérent</div>
            <p>Membre de l'association Info Evry</p>
          </div>
          <div class="pricing-card glass-card featured">
            <div class="pricing-amount">{ndiInfoEvry.registration.prices.nonMember.amount}€</div>
            <div class="pricing-label">Non-adhérent</div>
            <p>Accès complet avec goodies</p>
          </div>
          <div class="pricing-card glass-card">
            <div class="pricing-amount">Gratuit</div>
            <div class="pricing-label">Sans goodies</div>
            <p>Participation uniquement</p>
          </div>
        </div>
        <p class="pricing-note">{ndiInfoEvry.registration.payment}</p>
      </section>

      <!-- Capacity Warning -->
      <div id="capacity-warning" class="capacity-warning hidden">
        <span class="capacity-warning-icon">&#9888;</span>
        <span class="capacity-warning-text" id="capacity-warning-text"></span>
      </div>

      <!-- Teams Section -->
      <section id="teams" class="content-section">
        <div class="section-header-row">
          <h2>Équipes inscrites <span class="team-count-badge" id="teams-badge">0</span></h2>
        </div>
        <div id="teams-list" class="teams-grid"></div>
      </section>

      <!-- Registration Form Section -->
      <section id="inscription" class="content-section">
        <h2>Formulaire d'inscription</h2>

        <form id="registration-form" class="form">
          <div class="form-card">
            <h3 class="form-card-title">Équipe</h3>

            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="team-mode" value="new" checked>
                <span>Créer une nouvelle équipe</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="team-mode" value="join">
                <span>Rejoindre une équipe existante</span>
              </label>
            </div>

            <div id="new-team-fields" class="team-fields">
              <div class="form-group">
                <label for="team-name">Nom de l'équipe *</label>
                <input type="text" id="team-name" name="teamName" maxlength="128">
              </div>
              <div class="form-group">
                <label for="team-desc">Description (optionnelle)</label>
                <textarea id="team-desc" name="teamDescription" maxlength="256" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label for="team-password">Mot de passe de l'équipe *</label>
                <input type="password" id="team-password" name="teamPassword" maxlength="64" placeholder="Les autres membres en auront besoin pour rejoindre">
              </div>
            </div>

            <div id="join-team-fields" class="team-fields hidden">
              <div class="form-group">
                <label for="team-select">Sélectionner une équipe *</label>
                <select id="team-select" name="teamId">
                  <option value="">-- Choisir une équipe --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="join-password">Mot de passe de l'équipe *</label>
                <input type="password" id="join-password" name="joinPassword" maxlength="64" placeholder="Demandez-le au chef d'équipe">
              </div>
            </div>
          </div>

          <div class="form-card">
            <div class="form-card-header">
              <h3 class="form-card-title">Membres <span id="member-count">(1)</span></h3>
              <button type="button" id="add-member" class="btn btn-secondary btn-sm">
                + Ajouter un membre
              </button>
            </div>

            <div id="members-container"></div>
          </div>

          <div id="form-errors" class="errors hidden"></div>

          <button type="submit" id="submit-btn" class="btn btn-primary btn-lg">
            S'inscrire
          </button>
        </form>
      </section>
    </div>
  </main>

  <!-- Modals -->
  <div id="success-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Inscription réussie!</h3>
      <p id="success-message"></p>
      <button type="button" class="btn btn-primary" onclick="location.reload()">
        Fermer
      </button>
    </div>
  </div>

  <div id="team-view-modal" class="modal hidden">
    <div class="modal-content modal-lg">
      <div id="team-view-auth" class="team-view-section">
        <h3 id="team-view-title">Voir l'équipe</h3>
        <p class="team-view-desc">Entrez le mot de passe de l'équipe pour voir ses membres.</p>
        <div class="form-group">
          <label for="team-view-password">Mot de passe</label>
          <input type="password" id="team-view-password" placeholder="Mot de passe de l'équipe">
        </div>
        <p id="team-view-error" class="error-text hidden"></p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="team-view-cancel">Annuler</button>
          <button type="button" class="btn btn-primary" id="team-view-submit">Voir les membres</button>
        </div>
      </div>
      <div id="team-view-content" class="team-view-section hidden">
        <div class="team-view-header">
          <div>
            <h3 id="team-detail-name"></h3>
            <p id="team-detail-desc" class="team-view-desc"></p>
          </div>
          <button type="button" class="btn btn-secondary" id="team-view-close">Fermer</button>
        </div>
        <div id="team-members-list" class="team-members-list"></div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Page-Specific Styles (Hero styles from shared design system) */

  /* Hero DateTime */
  .hero-datetime {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--space-4);
    margin-bottom: var(--space-8);
    opacity: 0;
    animation: hero-fade-in-up 0.6s ease 350ms forwards;
  }

  .datetime-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    padding: var(--space-2) var(--space-4);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-full);
  }

  .datetime-icon {
    font-size: var(--text-base);
  }

  /* Main Content */
  .main-content {
    background: var(--color-bg);
    position: relative;
    z-index: 1;
  }

  .main-content .container {
    max-width: 960px;
    padding: var(--space-16) var(--space-4);
  }

  .content-section {
    margin-bottom: var(--space-16);
  }

  .content-section h2 {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-6);
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  /* Info Grid */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-8);
  }

  .info-card {
    padding: var(--space-6);
    text-align: center;
  }

  .info-card-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-4);
  }

  .info-card h3 {
    font-size: var(--text-lg);
    font-weight: 600;
    margin-bottom: var(--space-3);
    color: var(--color-text);
  }

  .info-card p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  /* Last Year Stats */
  .last-year-stats {
    text-align: center;
    padding: var(--space-4);
    background: rgba(0, 27, 165, 0.1);
    border: 1px solid rgba(0, 27, 165, 0.2);
    border-radius: var(--radius-lg);
  }

  .stats-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0 0 var(--space-2);
  }

  .stats-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--space-2);
    font-size: var(--text-base);
    color: var(--color-text);
  }

  .stats-row strong {
    color: var(--color-primary);
  }

  .stats-sep {
    color: var(--color-text-muted);
  }

  /* Challenge Card */
  .challenge-card {
    padding: var(--space-6);
  }

  .challenge-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .challenge-badge {
    display: inline-flex;
    padding: var(--space-1) var(--space-3);
    background: var(--color-primary);
    color: white;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
  }

  .challenge-header h3 {
    margin: 0;
    font-size: var(--text-xl);
    color: var(--color-text);
  }

  .challenge-desc {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-3);
    margin-bottom: var(--space-6);
  }

  .category-item {
    padding: var(--space-4);
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    text-align: center;
  }

  .category-name {
    display: block;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
  }

  .category-desc {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .challenge-rules h4 {
    font-size: var(--text-base);
    margin: 0 0 var(--space-3);
    color: var(--color-text);
  }

  .challenge-rules ul {
    margin: 0;
    padding-left: var(--space-5);
    color: var(--color-text-secondary);
  }

  .challenge-rules li {
    margin-bottom: var(--space-1);
  }

  /* Pricing Grid */
  .pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }

  .pricing-card {
    padding: var(--space-6);
    text-align: center;
    transition: transform var(--transition-base), border-color var(--transition-base);
  }

  .pricing-card:hover {
    transform: translateY(-4px);
  }

  .pricing-card.featured {
    border-color: var(--color-primary);
    background: rgba(0, 27, 165, 0.1);
  }

  .pricing-amount {
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .pricing-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
  }

  .pricing-card p {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0;
  }

  .pricing-note {
    text-align: center;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0;
  }

  .section-header-row {
    margin-bottom: var(--space-6);
  }

  .team-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    padding: 0 var(--space-2);
    background: var(--color-primary);
    color: white;
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 600;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-datetime {
      flex-direction: column;
      gap: var(--space-2);
    }

    .datetime-item {
      width: 100%;
      justify-content: center;
    }

    .main-content .container {
      padding: var(--space-10) var(--space-4);
    }

    .info-grid {
      grid-template-columns: 1fr;
    }

    .categories-grid {
      grid-template-columns: 1fr;
    }

    .pricing-grid {
      grid-template-columns: 1fr;
    }

    .stats-row {
      flex-direction: column;
      gap: var(--space-1);
    }

    .stats-sep {
      display: none;
    }
  }
</style>

<script define:vars={{ baseUrl: import.meta.env.BASE_URL }}>
/**
 * Nuit de l'Info - Registration App
 * Vanilla JavaScript, ES Modules, No Dependencies
 */

// API base URL (from Astro's BASE_URL)
const API_BASE = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;

// State
const state = {
  config: null,
  teams: [],
  stats: null,
  members: [],
  isNewTeam: true,
  selectedTeamId: null,
  isAtCapacity: false
};

// DOM Elements
const elements = {
  // Hero KPIs
  kpiTeams: document.getElementById('kpi-teams'),
  kpiParticipants: document.getElementById('kpi-participants'),
  kpiSpots: document.getElementById('kpi-spots'),
  // Teams
  teamsList: document.getElementById('teams-list'),
  teamsBadge: document.getElementById('teams-badge'),
  teamSelect: document.getElementById('team-select'),
  // Form
  newTeamFields: document.getElementById('new-team-fields'),
  joinTeamFields: document.getElementById('join-team-fields'),
  membersContainer: document.getElementById('members-container'),
  memberCount: document.getElementById('member-count'),
  addMemberBtn: document.getElementById('add-member'),
  form: document.getElementById('registration-form'),
  submitBtn: document.getElementById('submit-btn'),
  errorsDiv: document.getElementById('form-errors'),
  successModal: document.getElementById('success-modal'),
  successMessage: document.getElementById('success-message'),
  capacityWarning: document.getElementById('capacity-warning'),
  capacityWarningText: document.getElementById('capacity-warning-text'),
  inscriptionSection: document.getElementById('inscription'),
  heroRegisterBtn: document.getElementById('hero-register-btn'),
  // Team view modal elements
  teamViewModal: document.getElementById('team-view-modal'),
  teamViewAuth: document.getElementById('team-view-auth'),
  teamViewContent: document.getElementById('team-view-content'),
  teamViewTitle: document.getElementById('team-view-title'),
  teamViewPassword: document.getElementById('team-view-password'),
  teamViewError: document.getElementById('team-view-error'),
  teamViewSubmit: document.getElementById('team-view-submit'),
  teamViewCancel: document.getElementById('team-view-cancel'),
  teamViewClose: document.getElementById('team-view-close'),
  teamDetailName: document.getElementById('team-detail-name'),
  teamDetailDesc: document.getElementById('team-detail-desc'),
  teamMembersList: document.getElementById('team-members-list')
};

// API Functions
async function api(endpoint, options = {}) {
  const response = await fetch(`${API_BASE}/api${endpoint}`, {
    headers: { 'Content-Type': 'application/json' },
    ...options
  });
  const data = await response.json();
  if (!response.ok) throw new Error(data.error || 'Request failed');
  return data;
}

async function loadConfig() {
  const { config } = await api('/config');
  state.config = config;
  return config;
}

async function loadTeams() {
  const { teams } = await api('/teams');
  state.teams = teams;
  return teams;
}

async function loadStats() {
  const { stats } = await api('/stats');
  state.stats = stats;
  return stats;
}

async function submitRegistration(data) {
  return api('/register', {
    method: 'POST',
    body: JSON.stringify(data)
  });
}

async function viewTeamMembers(teamId, password) {
  return api(`/teams/${teamId}/view`, {
    method: 'POST',
    body: JSON.stringify({ password })
  });
}

// Render Functions
function renderStats(stats) {
  const percentUsed = (stats.total_participants / stats.max_participants) * 100;
  const isNearCapacity = percentUsed >= 80;
  const isAtCapacity = stats.available_spots <= 0;

  state.isAtCapacity = isAtCapacity;

  // Update hero KPIs
  elements.kpiTeams.textContent = stats.total_teams;
  // Show x/max when open, just x when closed
  elements.kpiParticipants.textContent = isAtCapacity
    ? stats.total_participants
    : `${stats.total_participants}/${stats.max_participants}`;
  elements.kpiSpots.textContent = stats.available_spots;

  // Handle capacity warning
  if (isAtCapacity) {
    elements.capacityWarning.classList.remove('hidden');
    elements.capacityWarning.classList.add('capacity-full');
    elements.capacityWarningText.innerHTML = '<strong>Inscriptions closes</strong> — Le nombre maximum de participants a été atteint.';
    disableForm();
  } else if (isNearCapacity) {
    elements.capacityWarning.classList.remove('hidden');
    elements.capacityWarning.classList.remove('capacity-full');
    elements.capacityWarningText.innerHTML = `<strong>Places limitées</strong> — Il ne reste que <strong>${stats.available_spots}</strong> place${stats.available_spots > 1 ? 's' : ''} disponible${stats.available_spots > 1 ? 's' : ''}.`;
  } else {
    elements.capacityWarning.classList.add('hidden');
  }
}

function disableForm() {
  // Hide the entire inscription section when closed
  elements.inscriptionSection.classList.add('hidden');
  // Also hide the hero register button
  elements.heroRegisterBtn.classList.add('hidden');
}

function renderTeams(teams) {
  // Update badge with team count (excluding Organisation)
  const teamCount = teams.filter(t => !t.is_organisation).length;
  elements.teamsBadge.textContent = teamCount;

  if (teams.length === 0) {
    elements.teamsList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">&#128101;</div>
        <p class="empty-state-text">Aucune équipe inscrite pour le moment.</p>
      </div>
    `;
    return;
  }

  elements.teamsList.innerHTML = teams.map(team => {
    const isOrg = team.is_organisation;
    const cardClasses = [
      'team-card',
      'clickable',
      team.is_full ? 'full' : '',
      isOrg ? 'organisation' : ''
    ].filter(Boolean).join(' ');

    const spotsClasses = [
      'team-spots',
      team.is_full ? 'full' : '',
      isOrg ? 'unlimited' : ''
    ].filter(Boolean).join(' ');

    let spotsText = '';
    if (isOrg) {
      spotsText = 'Illimité';
    } else if (team.is_full) {
      spotsText = 'Complet';
    } else {
      spotsText = `${team.available_slots} place${team.available_slots > 1 ? 's' : ''}`;
    }

    return `
      <div class="${cardClasses}" data-team-id="${team.id}">
        <h3 class="team-name">${escapeHtml(team.name)}</h3>
        ${team.description ? `<p class="team-desc">${escapeHtml(team.description)}</p>` : ''}
        <div class="team-meta">
          <span class="team-members">${team.member_count} membre${team.member_count > 1 ? 's' : ''}</span>
          <span class="${spotsClasses}">${spotsText}</span>
        </div>
        <div class="team-view-hint">Cliquez pour voir les membres</div>
      </div>
    `;
  }).join('');

  // Add click event listeners to team cards
  elements.teamsList.querySelectorAll('.team-card').forEach(card => {
    card.addEventListener('click', () => {
      const teamId = parseInt(card.dataset.teamId, 10);
      openTeamViewModal(teamId);
    });
  });
}

function renderTeamSelect(teams) {
  const availableTeams = teams.filter(t => !t.is_full && !t.is_organisation);
  elements.teamSelect.innerHTML = `
    <option value="">-- Choisir une équipe --</option>
    ${availableTeams.map(team => `
      <option value="${team.id}">
        ${escapeHtml(team.name)} (${team.available_slots} place${team.available_slots > 1 ? 's' : ''})
      </option>
    `).join('')}
  `;
}

function createMemberCard(index) {
  const { pizzas, bacLevels } = state.config;

  const card = document.createElement('div');
  card.className = 'member-card';
  card.dataset.index = index;

  card.innerHTML = `
    <div class="member-header">
      <span class="member-title">Membre ${index + 1}</span>
      ${index > 0 ? '<button type="button" class="remove-btn">Retirer</button>' : ''}
    </div>

    <div class="member-grid">
      <div class="form-group">
        <label>
          <span class="toggle-group">
            <span class="toggle">
              <input type="checkbox" name="members[${index}].isLeader">
              <span class="toggle-slider"></span>
            </span>
            Chef d'équipe
          </span>
        </label>
      </div>

      <div></div>

      <div class="form-group">
        <label>Prénom *</label>
        <input type="text" name="members[${index}].firstName" required maxlength="128">
      </div>

      <div class="form-group">
        <label>Nom *</label>
        <input type="text" name="members[${index}].lastName" required maxlength="128">
      </div>

      <div class="form-group">
        <label>Email *</label>
        <input type="email" name="members[${index}].email" required maxlength="256">
      </div>

      <div class="form-group">
        <label>Niveau d'études *</label>
        <select name="members[${index}].bacLevel" required>
          ${bacLevels.map(level => `
            <option value="${level.value}">${level.label}</option>
          `).join('')}
        </select>
      </div>

      <div class="form-group full-width">
        <label>Choix de pizza</label>
        <div class="pizza-grid">
          ${pizzas.map((pizza, i) => `
            <label class="pizza-option ${i === 0 ? 'selected' : ''}">
              <input type="radio" name="members[${index}].foodDiet" value="${pizza.id}" ${i === 0 ? 'checked' : ''}>
              <div class="pizza-info">
                <div class="pizza-name">${escapeHtml(pizza.name)}</div>
                ${pizza.description ? `<div class="pizza-desc">${escapeHtml(pizza.description)}</div>` : ''}
              </div>
            </label>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  // Event listeners
  const removeBtn = card.querySelector('.remove-btn');
  if (removeBtn) {
    removeBtn.addEventListener('click', () => removeMember(index));
  }

  // Pizza selection highlighting
  card.querySelectorAll('.pizza-option input').forEach(input => {
    input.addEventListener('change', (e) => {
      card.querySelectorAll('.pizza-option').forEach(opt => opt.classList.remove('selected'));
      e.target.closest('.pizza-option').classList.add('selected');
    });
  });

  return card;
}

function addMember() {
  if (state.isAtCapacity) return;

  const maxSize = state.config.maxTeamSize;
  if (state.members.length >= maxSize) {
    showErrors([`Maximum ${maxSize} membres par équipe`]);
    return;
  }

  // Check available spots
  if (state.stats && state.members.length >= state.stats.available_spots) {
    showErrors([`Il ne reste que ${state.stats.available_spots} place(s) disponible(s)`]);
    return;
  }

  const index = state.members.length;
  const card = createMemberCard(index);
  elements.membersContainer.appendChild(card);
  state.members.push({ index });
  updateMemberCount();
}

function removeMember(index) {
  if (state.members.length <= 1) {
    showErrors(['Au moins un membre est requis']);
    return;
  }

  const card = elements.membersContainer.querySelector(`[data-index="${index}"]`);
  if (card) {
    card.style.animation = 'fadeInUp 0.2s ease-out reverse';
    setTimeout(() => {
      card.remove();
      state.members = state.members.filter(m => m.index !== index);
      reindexMembers();
      updateMemberCount();
    }, 200);
  }
}

function reindexMembers() {
  const cards = elements.membersContainer.querySelectorAll('.member-card');
  state.members = [];

  cards.forEach((card, newIndex) => {
    card.dataset.index = newIndex;
    card.querySelector('.member-title').textContent = `Membre ${newIndex + 1}`;

    // Update all input names
    card.querySelectorAll('input, select').forEach(input => {
      if (input.name) {
        input.name = input.name.replace(/members\[\d+\]/, `members[${newIndex}]`);
      }
    });

    // Show/hide remove button
    const removeBtn = card.querySelector('.remove-btn');
    if (newIndex === 0 && removeBtn) {
      removeBtn.remove();
    } else if (newIndex > 0 && !removeBtn) {
      const header = card.querySelector('.member-header');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'remove-btn';
      btn.textContent = 'Retirer';
      btn.addEventListener('click', () => removeMember(newIndex));
      header.appendChild(btn);
    }

    state.members.push({ index: newIndex });
  });
}

function updateMemberCount() {
  elements.memberCount.textContent = `(${state.members.length})`;

  // Check capacity
  const maxSize = state.config.maxTeamSize;
  const maxBySpots = state.stats ? state.stats.available_spots : maxSize;
  elements.addMemberBtn.disabled = state.members.length >= Math.min(maxSize, maxBySpots) || state.isAtCapacity;
}

// Form Handling
function collectFormData() {
  const formData = new FormData(elements.form);
  const data = {
    createNewTeam: state.isNewTeam,
    members: []
  };

  if (state.isNewTeam) {
    data.teamName = formData.get('teamName');
    data.teamDescription = formData.get('teamDescription');
    data.teamPassword = formData.get('teamPassword');
  } else {
    data.teamId = parseInt(formData.get('teamId'), 10);
    data.teamPassword = formData.get('joinPassword');
  }

  // Collect members
  state.members.forEach((_, i) => {
    data.members.push({
      firstName: formData.get(`members[${i}].firstName`),
      lastName: formData.get(`members[${i}].lastName`),
      email: formData.get(`members[${i}].email`),
      bacLevel: parseInt(formData.get(`members[${i}].bacLevel`), 10),
      isLeader: formData.get(`members[${i}].isLeader`) === 'on',
      foodDiet: formData.get(`members[${i}].foodDiet`) || 'none'
    });
  });

  return data;
}

function validateForm() {
  const errors = [];
  const data = collectFormData();

  if (state.isNewTeam) {
    if (!data.teamName?.trim()) {
      errors.push("Le nom de l'équipe est requis");
    }
    if (!data.teamPassword?.trim()) {
      errors.push("Le mot de passe de l'équipe est requis");
    } else if (data.teamPassword.length < 4) {
      errors.push("Le mot de passe doit faire au moins 4 caractères");
    }

    const hasLeader = data.members.some(m => m.isLeader);
    if (!hasLeader) {
      errors.push("Une nouvelle équipe doit avoir au moins un chef d'équipe");
    }
  } else {
    if (!data.teamId) {
      errors.push("Veuillez sélectionner une équipe");
    }
    if (!data.teamPassword?.trim()) {
      errors.push("Le mot de passe de l'équipe est requis");
    }
  }

  // Validate each member
  data.members.forEach((member, i) => {
    if (!member.firstName?.trim()) errors.push(`Membre ${i + 1}: Prénom requis`);
    if (!member.lastName?.trim()) errors.push(`Membre ${i + 1}: Nom requis`);
    if (!member.email?.trim()) errors.push(`Membre ${i + 1}: Email requis`);
    else if (!isValidEmail(member.email)) errors.push(`Membre ${i + 1}: Email invalide`);
  });

  // Check duplicates
  const seen = new Set();
  data.members.forEach((m, i) => {
    const key = `${m.firstName?.toLowerCase()}|${m.lastName?.toLowerCase()}`;
    if (seen.has(key)) {
      errors.push(`Membre ${i + 1}: Nom en double`);
    }
    seen.add(key);
  });

  return errors;
}

async function handleSubmit(e) {
  e.preventDefault();

  if (state.isAtCapacity) {
    showErrors(['Les inscriptions sont closes']);
    return;
  }

  const errors = validateForm();
  if (errors.length > 0) {
    showErrors(errors);
    return;
  }

  hideErrors();
  setLoading(true);

  try {
    const data = collectFormData();
    const result = await submitRegistration(data);

    elements.successMessage.textContent = result.message;
    elements.successModal.classList.remove('hidden');

  } catch (err) {
    showErrors([err.message]);
  } finally {
    setLoading(false);
  }
}

// UI Helpers
function showErrors(errors) {
  elements.errorsDiv.innerHTML = `<ul>${errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul>`;
  elements.errorsDiv.classList.remove('hidden');
  elements.errorsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideErrors() {
  elements.errorsDiv.classList.add('hidden');
}

function setLoading(loading) {
  elements.submitBtn.disabled = loading;
  elements.form.classList.toggle('loading', loading);
  elements.submitBtn.textContent = loading ? 'Inscription en cours...' : "S'inscrire";
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// Team View Modal Functions
function openTeamViewModal(teamId) {
  const team = state.teams.find(t => t.id === teamId);
  if (!team) return;

  state.selectedTeamId = teamId;
  elements.teamViewTitle.textContent = `Voir l'équipe: ${team.name}`;
  elements.teamViewPassword.value = '';
  elements.teamViewError.classList.add('hidden');
  elements.teamViewAuth.classList.remove('hidden');
  elements.teamViewContent.classList.add('hidden');
  elements.teamViewModal.classList.remove('hidden');
  elements.teamViewPassword.focus();
}

function closeTeamViewModal() {
  state.selectedTeamId = null;
  elements.teamViewModal.classList.add('hidden');
  elements.teamViewPassword.value = '';
  elements.teamViewError.classList.add('hidden');
}

async function handleTeamViewSubmit() {
  const password = elements.teamViewPassword.value.trim();
  if (!password) {
    elements.teamViewError.textContent = 'Veuillez entrer le mot de passe';
    elements.teamViewError.classList.remove('hidden');
    return;
  }

  elements.teamViewSubmit.disabled = true;
  elements.teamViewSubmit.textContent = 'Chargement...';

  try {
    const result = await viewTeamMembers(state.selectedTeamId, password);
    showTeamMembers(result.team);
  } catch (err) {
    elements.teamViewError.textContent = err.message;
    elements.teamViewError.classList.remove('hidden');
  } finally {
    elements.teamViewSubmit.disabled = false;
    elements.teamViewSubmit.textContent = 'Voir les membres';
  }
}

function showTeamMembers(team) {
  elements.teamDetailName.textContent = team.name;
  elements.teamDetailDesc.textContent = team.description || '';

  const bacLabels = {
    0: 'Non bachelier',
    1: 'BAC+1',
    2: 'BAC+2',
    3: 'BAC+3 (Licence)',
    4: 'BAC+4',
    5: 'BAC+5 (Master)',
    6: 'BAC+6',
    7: 'BAC+7',
    8: 'BAC+8 (Doctorat)'
  };

  elements.teamMembersList.innerHTML = team.members.map(member => `
    <div class="member-item ${member.isLeader ? 'leader' : ''}">
      <div class="member-info">
        <span class="member-name">${escapeHtml(member.firstName)} ${escapeHtml(member.lastName)}</span>
        ${member.isLeader ? '<span class="badge-leader">Chef</span>' : ''}
      </div>
      <div class="member-details">
        <span class="member-email">${escapeHtml(member.email)}</span>
        <span class="member-bac">${bacLabels[member.bacLevel] || 'N/A'}</span>
        ${member.foodDiet ? `<span class="member-food">${escapeHtml(member.foodDiet)}</span>` : ''}
      </div>
    </div>
  `).join('');

  elements.teamViewAuth.classList.add('hidden');
  elements.teamViewContent.classList.remove('hidden');
}

// Event Listeners
function setupEventListeners() {
  // Team mode toggle
  document.querySelectorAll('input[name="team-mode"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      state.isNewTeam = e.target.value === 'new';
      elements.newTeamFields.classList.toggle('hidden', !state.isNewTeam);
      elements.joinTeamFields.classList.toggle('hidden', state.isNewTeam);
    });
  });

  // Add member button
  elements.addMemberBtn.addEventListener('click', addMember);

  // Form submission
  elements.form.addEventListener('submit', handleSubmit);

  // Team view modal
  elements.teamViewSubmit.addEventListener('click', handleTeamViewSubmit);
  elements.teamViewCancel.addEventListener('click', closeTeamViewModal);
  elements.teamViewClose.addEventListener('click', closeTeamViewModal);

  // Allow Enter key to submit password
  elements.teamViewPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleTeamViewSubmit();
    }
  });

  // Close modal on backdrop click
  elements.teamViewModal.addEventListener('click', (e) => {
    if (e.target === elements.teamViewModal) {
      closeTeamViewModal();
    }
  });

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!elements.teamViewModal.classList.contains('hidden')) {
        closeTeamViewModal();
      }
      if (!elements.successModal.classList.contains('hidden')) {
        location.reload();
      }
    }
  });
}

// Initialize
async function init() {
  try {
    // Load data in parallel
    const [config, teams, stats] = await Promise.all([
      loadConfig(),
      loadTeams(),
      loadStats()
    ]);

    renderStats(stats);
    renderTeams(teams);
    renderTeamSelect(teams);

    // Only add initial member if not at capacity
    if (!state.isAtCapacity) {
      addMember();
    }

    setupEventListeners();

  } catch (err) {
    console.error('Initialization error:', err);
    showErrors(['Erreur de chargement. Veuillez rafraîchir la page.']);
  }
}

// Start app
init();
</script>
