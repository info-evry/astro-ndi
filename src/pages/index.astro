---
import BaseLayout from '../layouts/BaseLayout.astro';
import Badge from '../../design/src/components/Badge.astro';
import ndiEvent from '../../knowledge/src/ndi/event.json';
import ndiInfoEvry from '../../knowledge/src/ndi/info-evry.json';

const baseUrl = import.meta.env.BASE_URL;
---

<BaseLayout title="Nuit de l'Info - Inscription - Asso Info Evry">
  <!-- Config data for JavaScript -->
  <div id="registration-config" data-base-url={baseUrl} hidden></div>
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-bg">
      <div class="orb orb-blue"></div>
      <div class="orb orb-purple"></div>
      <div class="orb orb-indigo"></div>
      <div class="grid-overlay"></div>
    </div>

    <div class="hero-content container">
      <Badge text={ndiEvent.edition} variant="hero" showDot animated />

      <h1 class="hero-title large">
        <span class="title-line">Nuit de</span>
        <span class="title-line gradient-text">l'Info</span>
      </h1>

      <p class="hero-description">
        {ndiEvent.tagline}
      </p>

      <!-- Event Date/Time -->
      <div class="hero-datetime">
        <div class="datetime-item">
          <span class="datetime-icon">&#128197;</span>
          <span>{ndiEvent.dates.startLabel}</span>
        </div>
        <div class="datetime-item">
          <span class="datetime-icon">&#9203;</span>
          <span>Durée : {ndiEvent.dates.duration}</span>
        </div>
        <div class="datetime-item">
          <span class="datetime-icon">&#128205;</span>
          <span>{ndiInfoEvry.site.location}</span>
        </div>
      </div>

      <!-- Modern KPI Stats -->
      <div id="hero-stats" class="hero-stats">
        <div class="kpi-card">
          <span class="kpi-value" id="kpi-teams">-</span>
          <span class="kpi-label">équipes</span>
        </div>
        <div class="kpi-divider"></div>
        <div class="kpi-card">
          <span class="kpi-value" id="kpi-participants">-</span>
          <span class="kpi-label">participants</span>
        </div>
        <div class="kpi-divider"></div>
        <div class="kpi-card">
          <span class="kpi-value" id="kpi-spots">-</span>
          <span class="kpi-label">places restantes</span>
        </div>
      </div>

      <div class="hero-actions">
        <a href="#inscription" id="hero-register-btn" class="btn btn-primary btn-lg">
          S'inscrire maintenant
        </a>
        <a href="#about" class="btn btn-secondary btn-lg">
          En savoir plus
        </a>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <!-- About Section -->
      <section id="about" class="content-section">
        <h2>Qu'est-ce que la Nuit de l'Info ?</h2>
        <div class="info-grid">
          <div class="info-card glass-card">
            <div class="info-card-icon">&#127942;</div>
            <h3>Le Concept</h3>
            <p>{ndiEvent.description}</p>
          </div>
          <div class="info-card glass-card">
            <div class="info-card-icon">&#128188;</div>
            <h3>Les Défis</h3>
            <p>{ndiInfoEvry.challenges.official.description}. Chaque équipe peut participer à maximum {ndiEvent.structure.maxChallenges} défis.</p>
          </div>
          <div class="info-card glass-card">
            <div class="info-card-icon">&#127828;</div>
            <h3>Sur Place</h3>
            <p>{ndiInfoEvry.amenities.food.description}. {ndiInfoEvry.amenities.networking.description}.</p>
          </div>
        </div>

        <!-- Stats from last year -->
        <div class="last-year-stats">
          <p class="stats-label">Édition {ndiEvent.stats.sinceYear + (2024 - 2007)} :</p>
          <div class="stats-row">
            <span><strong>{ndiEvent.stats.participants2024.toLocaleString('fr-FR')}</strong> participants</span>
            <span class="stats-sep">•</span>
            <span><strong>{ndiEvent.stats.teams2024}</strong> équipes</span>
            <span class="stats-sep">•</span>
            <span><strong>{ndiEvent.stats.sites2024}</strong> sites en France</span>
          </div>
        </div>
      </section>

      <!-- Association Challenge -->
      <section id="defi-asso" class="content-section">
        <h2>Défi de l'Asso</h2>
        <div class="challenge-card glass-card">
          <div class="challenge-header">
            <span class="challenge-badge">Asso Info Evry</span>
            <h3>{ndiInfoEvry.challenges.association.type}</h3>
          </div>
          <p class="challenge-desc">{ndiInfoEvry.challenges.association.description}</p>

          <div class="categories-grid">
            {ndiInfoEvry.challenges.association.categories.map((cat: {id: string, name: string, description: string}) => (
              <div class="category-item">
                <span class="category-name">{cat.name}</span>
                <span class="category-desc">{cat.description}</span>
              </div>
            ))}
          </div>

          <div class="challenge-rules">
            <h4>Règles</h4>
            <ul>
              {ndiInfoEvry.challenges.association.rules.map((rule: string) => (
                <li>{rule}</li>
              ))}
            </ul>
          </div>
        </div>
      </section>

      <!-- Pricing Section -->
      <section id="tarifs" class="content-section">
        <h2>Tarifs</h2>
        <div class="pricing-grid">
          <div class="pricing-card glass-card">
            <div class="pricing-amount">{ndiInfoEvry.registration.prices.member.amount}€</div>
            <div class="pricing-label">Adhérent</div>
            <p>Membre de l'association Info Evry</p>
          </div>
          <div class="pricing-card glass-card featured">
            <div class="pricing-amount">{ndiInfoEvry.registration.prices.nonMember.amount}€</div>
            <div class="pricing-label">Non-adhérent</div>
            <p>Accès complet avec goodies</p>
          </div>
          <div class="pricing-card glass-card">
            <div class="pricing-amount">Gratuit</div>
            <div class="pricing-label">Sans goodies</div>
            <p>Participation uniquement</p>
          </div>
        </div>
        <p class="pricing-note">{ndiInfoEvry.registration.payment}</p>
      </section>

      <!-- Capacity Warning -->
      <div id="capacity-warning" class="capacity-warning hidden">
        <span class="capacity-warning-icon">&#9888;</span>
        <span class="capacity-warning-text" id="capacity-warning-text"></span>
      </div>

      <!-- Teams Section -->
      <section id="teams" class="content-section">
        <div class="section-header-row">
          <h2>Équipes inscrites <span class="team-count-badge" id="teams-badge">0</span></h2>
        </div>
        <div id="teams-list" class="teams-grid"></div>
      </section>

      <!-- Registration Form Section -->
      <section id="inscription" class="content-section">
        <h2>Formulaire d'inscription</h2>

        <form id="registration-form" class="form">
          <div class="form-card">
            <h3 class="form-card-title">Équipe</h3>

            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="team-mode" value="new" checked>
                <span>Créer une nouvelle équipe</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="team-mode" value="join">
                <span>Rejoindre une équipe existante</span>
              </label>
            </div>

            <div id="new-team-fields" class="team-fields">
              <div class="form-group">
                <label for="team-name">Nom de l'équipe *</label>
                <input type="text" id="team-name" name="teamName" maxlength="128">
              </div>
              <div class="form-group">
                <label for="team-desc">Description (optionnelle)</label>
                <textarea id="team-desc" name="teamDescription" maxlength="256" rows="2"></textarea>
              </div>
              <div class="form-group">
                <label for="team-password">Mot de passe de l'équipe *</label>
                <input type="password" id="team-password" name="teamPassword" maxlength="64" placeholder="Les autres membres en auront besoin pour rejoindre">
              </div>
            </div>

            <div id="join-team-fields" class="team-fields hidden">
              <div class="form-group">
                <label for="team-select">Sélectionner une équipe *</label>
                <select id="team-select" name="teamId">
                  <option value="">-- Choisir une équipe --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="join-password">Mot de passe de l'équipe *</label>
                <input type="password" id="join-password" name="joinPassword" maxlength="64" placeholder="Demandez-le au chef d'équipe">
              </div>
            </div>
          </div>

          <div class="form-card">
            <h3 class="form-card-title">Vos informations</h3>

            <div id="member-form" class="member-grid">
              <div class="form-group">
                <label for="member-first-name">Prénom *</label>
                <input type="text" id="member-first-name" name="firstName" required maxlength="128">
              </div>

              <div class="form-group">
                <label for="member-last-name">Nom *</label>
                <input type="text" id="member-last-name" name="lastName" required maxlength="128">
              </div>

              <div class="form-group">
                <label for="member-email">Email *</label>
                <input type="email" id="member-email" name="email" required maxlength="256">
              </div>

              <div class="form-group">
                <label for="member-bac-level">Niveau d'études *</label>
                <select id="member-bac-level" name="bacLevel" required>
                  <!-- Options populated by JS -->
                </select>
              </div>

              <div id="leader-toggle-container" class="form-group full-width hidden">
                <label>
                  <span class="toggle-group">
                    <span class="toggle">
                      <input type="checkbox" id="member-is-leader" name="isLeader">
                      <span class="toggle-slider"></span>
                    </span>
                    Chef d'équipe
                  </span>
                </label>
              </div>

              <div class="form-group full-width">
                <label>Choix de pizza</label>
                <div id="pizza-options" class="pizza-grid">
                  <!-- Options populated by JS -->
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Section -->
          <div class="form-card" id="payment-section">
            <h3 class="form-card-title">Paiement</h3>

            <!-- Dynamic pricing display -->
            <div id="pricing-info" class="pricing-info">
              <div class="price-display">
                <span class="price-amount" id="current-price">-</span>
                <span class="price-tier" id="current-tier-label">-</span>
              </div>
              <p class="pricing-note" id="pricing-deadline-note"></p>
            </div>

            <!-- Payment method selection -->
            <div class="payment-methods">
              <label class="payment-method selected">
                <input type="radio" name="paymentMethod" value="online" checked>
                <span class="method-content">
                  <span class="method-icon">&#128179;</span>
                  <span class="method-title">Payer maintenant</span>
                  <span class="method-desc">Paiement sécurisé par carte bancaire</span>
                </span>
              </label>
              <label class="payment-method">
                <input type="radio" name="paymentMethod" value="delayed">
                <span class="method-content">
                  <span class="method-icon">&#128197;</span>
                  <span class="method-title">Payer sur place</span>
                  <span class="method-desc">Le jour de l'événement (espèces ou carte)</span>
                </span>
              </label>
            </div>

            <!-- Payment disabled message -->
            <div id="payment-disabled" class="payment-disabled hidden">
              <p>Le paiement en ligne n'est pas encore activé. Votre inscription sera enregistrée et vous pourrez payer sur place.</p>
            </div>
          </div>

          <div id="form-errors" class="errors hidden"></div>

          <button type="submit" id="submit-btn" class="btn btn-primary btn-lg">
            S'inscrire
          </button>
        </form>
      </section>
    </div>
  </main>

  <!-- Modals -->
  <div id="success-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Inscription réussie!</h3>
      <p id="success-message"></p>
      <button type="button" class="btn btn-primary" onclick="location.reload()">
        Fermer
      </button>
    </div>
  </div>

  <div id="team-view-modal" class="modal hidden">
    <div class="modal-content modal-lg">
      <div id="team-view-auth" class="team-view-section">
        <h3 id="team-view-title">Voir l'équipe</h3>
        <p class="team-view-desc">Entrez le mot de passe de l'équipe pour voir ses membres.</p>
        <div class="form-group">
          <label for="team-view-password">Mot de passe</label>
          <input type="password" id="team-view-password" placeholder="Mot de passe de l'équipe">
        </div>
        <p id="team-view-error" class="error-text hidden"></p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="team-view-cancel">Annuler</button>
          <button type="button" class="btn btn-primary" id="team-view-submit">Voir les membres</button>
        </div>
      </div>
      <div id="team-view-content" class="team-view-section hidden">
        <div class="team-view-header">
          <div>
            <h3 id="team-detail-name"></h3>
            <p id="team-detail-desc" class="team-view-desc"></p>
          </div>
          <button type="button" class="btn btn-secondary" id="team-view-close">Fermer</button>
        </div>
        <div id="team-members-list" class="team-members-list"></div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Page-Specific Styles (Hero styles from shared design system) */

  /* Hero DateTime */
  .hero-datetime {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--space-4);
    margin-bottom: var(--space-8);
    opacity: 0;
    animation: hero-fade-in-up 0.6s ease 350ms forwards;
  }

  .datetime-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    padding: var(--space-2) var(--space-4);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-full);
  }

  .datetime-icon {
    font-size: var(--text-base);
  }

  /* Main Content */
  .main-content {
    background: var(--color-bg);
    position: relative;
    z-index: 1;
  }

  .main-content .container {
    max-width: 960px;
    padding: var(--space-16) var(--space-4);
  }

  .content-section {
    margin-bottom: var(--space-16);
  }

  .content-section h2 {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-6);
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  /* Info Grid */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-8);
  }

  .info-card {
    padding: var(--space-6);
    text-align: center;
  }

  .info-card-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-4);
  }

  .info-card h3 {
    font-size: var(--text-lg);
    font-weight: 600;
    margin-bottom: var(--space-3);
    color: var(--color-text);
  }

  .info-card p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  /* Last Year Stats */
  .last-year-stats {
    text-align: center;
    padding: var(--space-4);
    background: rgba(0, 27, 165, 0.1);
    border: 1px solid rgba(0, 27, 165, 0.2);
    border-radius: var(--radius-lg);
  }

  .stats-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0 0 var(--space-2);
  }

  .stats-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--space-2);
    font-size: var(--text-base);
    color: var(--color-text);
  }

  .stats-row strong {
    color: var(--color-primary);
  }

  .stats-sep {
    color: var(--color-text-muted);
  }

  /* Challenge Card */
  .challenge-card {
    padding: var(--space-6);
  }

  .challenge-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .challenge-badge {
    display: inline-flex;
    padding: var(--space-1) var(--space-3);
    background: var(--color-primary);
    color: white;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
  }

  .challenge-header h3 {
    margin: 0;
    font-size: var(--text-xl);
    color: var(--color-text);
  }

  .challenge-desc {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-3);
    margin-bottom: var(--space-6);
  }

  .category-item {
    padding: var(--space-4);
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius);
    text-align: center;
  }

  .category-name {
    display: block;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
  }

  .category-desc {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .challenge-rules h4 {
    font-size: var(--text-base);
    margin: 0 0 var(--space-3);
    color: var(--color-text);
  }

  .challenge-rules ul {
    margin: 0;
    padding-left: var(--space-5);
    color: var(--color-text-secondary);
  }

  .challenge-rules li {
    margin-bottom: var(--space-1);
  }

  /* Pricing Grid */
  .pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }

  .pricing-card {
    padding: var(--space-6);
    text-align: center;
    transition: transform var(--transition-base), border-color var(--transition-base);
  }

  .pricing-card:hover {
    transform: translateY(-4px);
  }

  .pricing-card.featured {
    border-color: var(--color-primary);
    background: rgba(0, 27, 165, 0.1);
  }

  .pricing-amount {
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .pricing-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
  }

  .pricing-card p {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0;
  }

  .pricing-note {
    text-align: center;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0;
  }

  .section-header-row {
    margin-bottom: var(--space-6);
  }

  .team-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    padding: 0 var(--space-2);
    background: var(--color-primary);
    color: white;
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 600;
  }

  /* Payment Section Styles */
  .pricing-info {
    text-align: center;
    padding: var(--space-4);
    background: rgba(0, 27, 165, 0.05);
    border: 1px solid rgba(0, 27, 165, 0.1);
    border-radius: var(--radius);
    margin-bottom: var(--space-4);
  }

  .price-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    margin-bottom: var(--space-2);
  }

  .price-amount {
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--color-primary);
  }

  .price-tier {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    padding: var(--space-1) var(--space-2);
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-sm);
  }

  .pricing-note {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0;
  }

  .payment-methods {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .payment-method {
    display: flex;
    cursor: pointer;
    padding: var(--space-4);
    background: rgba(255, 255, 255, 0.02);
    border: 2px solid var(--border-subtle);
    border-radius: var(--radius);
    transition: all var(--transition-base);
  }

  .payment-method:hover {
    border-color: var(--color-primary);
    background: rgba(0, 27, 165, 0.05);
  }

  .payment-method.selected {
    border-color: var(--color-primary);
    background: rgba(0, 27, 165, 0.1);
  }

  .payment-method input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .method-content {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex: 1;
  }

  .method-icon {
    font-size: 1.5rem;
  }

  .method-title {
    font-weight: 600;
    color: var(--color-text);
    display: block;
  }

  .method-desc {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    display: block;
  }

  .payment-disabled {
    padding: var(--space-4);
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: var(--radius);
    text-align: center;
  }

  .payment-disabled p {
    margin: 0;
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
  }

  /* Member grid layout */
  .member-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .member-grid .full-width {
    grid-column: 1 / -1;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-datetime {
      flex-direction: column;
      gap: var(--space-2);
    }

    .datetime-item {
      width: 100%;
      justify-content: center;
    }

    .main-content .container {
      padding: var(--space-10) var(--space-4);
    }

    .info-grid {
      grid-template-columns: 1fr;
    }

    .categories-grid {
      grid-template-columns: 1fr;
    }

    .pricing-grid {
      grid-template-columns: 1fr;
    }

    .stats-row {
      flex-direction: column;
      gap: var(--space-1);
    }

    .stats-sep {
      display: none;
    }
  }
</style>

<script type="module" src="../client/registration/main.js"></script>
